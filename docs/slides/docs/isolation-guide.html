<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Isolation Guide - R4W Documentation</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="nav">
        <a href="../index.html">Presentations</a>
        <a href="index.html">Documentation</a>
    </div>
    <h1 id="r4w-waveform-isolation-guide">R4W Waveform Isolation
    Guide</h1>
    <p>This document provides comprehensive guidance for isolating
    waveforms from each other in R4W deployments. It covers scenarios
    from basic process separation to hardware-enforced isolation for
    multi-level security (MLS) environments.</p>
    <h2 id="table-of-contents">Table of Contents</h2>
    <ol type="1">
    <li><a href="#overview">Overview</a></li>
    <li><a href="#threat-model">Threat Model</a></li>
    <li><a href="#isolation-levels">Isolation Levels</a></li>
    <li><a href="#level-1-3-process-isolation">Level 1-3: Process
    Isolation</a></li>
    <li><a href="#level-4-5-container-isolation">Level 4-5: Container
    Isolation</a></li>
    <li><a href="#level-6-virtual-machine-isolation">Level 6: Virtual
    Machine Isolation</a></li>
    <li><a href="#level-7-hardware-isolation">Level 7: Hardware
    Isolation</a></li>
    <li><a href="#level-8-air-gap-isolation">Level 8: Air-Gap
    Isolation</a></li>
    <li><a href="#fpga-isolation">FPGA Isolation</a></li>
    <li><a href="#memory-protection">Memory Protection</a></li>
    <li><a href="#cross-domain-solutions">Cross-Domain
    Solutions</a></li>
    <li><a href="#implementation-guide">Implementation Guide</a></li>
    <li><a href="#deployment-configurations">Deployment
    Configurations</a></li>
    </ol>
    <hr />
    <h2 id="overview">Overview</h2>
    <h3 id="why-waveform-isolation">Why Waveform Isolation?</h3>
    <p>In SDR systems processing multiple waveforms, several security
    concerns arise:</p>
    <pre><code>┌─────────────────────────────────────────────────────────────────────────────┐
│                    Multi-Waveform Security Concerns                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. Data Leakage                                                            │
│     • Encrypted traffic mixed with unencrypted                              │
│     • Classified waveform data accessible to unclassified processes         │
│     • I/Q samples from one waveform visible to another                      │
│                                                                             │
│  2. Cross-Contamination                                                     │
│     • Bug in one waveform affecting others                                  │
│     • Malicious waveform attacking system                                   │
│     • Resource exhaustion (CPU, memory, FPGA)                               │
│                                                                             │
│  3. Covert Channels                                                         │
│     • Timing side-channels between waveforms                                │
│     • Cache-based information leakage                                       │
│     • Shared resource contention as communication                           │
│                                                                             │
│  4. Privilege Escalation                                                    │
│     • Low-security waveform gaining access to high-security resources       │
│     • FPGA reconfiguration attacks                                          │
│     • Key material exposure                                                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘</code></pre>
    <h3 id="isolation-spectrum">Isolation Spectrum</h3>
    <pre><code>┌─────────────────────────────────────────────────────────────────────────────┐
│                         Isolation Level Spectrum                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Overhead ──────────────────────────────────────────────────────► Security  │
│  (Low)                                                              (High)  │
│                                                                             │
│  ┌─────┐  ┌─────┐  ┌─────┐  ┌─────┐  ┌─────┐  ┌─────┐  ┌─────┐  ┌─────┐     │
│  │ L1  │  │ L2  │  │ L3  │  │ L4  │  │ L5  │  │ L6  │  │ L7  │  │ L8  │     │
│  │     │  │     │  │     │  │     │  │     │  │     │  │     │  │     │     │
│  │Proc │  │ NS  │  │LSM  │  │Cont │  │uVM  │  │ VM  │  │ HW  │  │ Air │     │
│  │     │  │     │  │     │  │     │  │     │  │     │  │     │  │ Gap │     │
│  └─────┘  └─────┘  └─────┘  └─────┘  └─────┘  └─────┘  └─────┘  └─────┘     │
│                                                                             │
│  L1: Process        - Separate processes, shared kernel                     │
│  L2: Namespace      - + Linux namespaces (pid, net, mount, user)            │
│  L3: LSM            - + seccomp + SELinux/AppArmor                          │
│  L4: Container      - Docker/Podman with security profiles                  │
│  L5: MicroVM        - Firecracker/gVisor (lightweight VMs)                  │
│  L6: Full VM        - KVM/QEMU with dedicated resources                     │
│  L7: Hardware       - CPU pinning + IOMMU + memory encryption               │
│  L8: Air Gap        - Physically separate systems with data diodes          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘</code></pre>
    <hr />
    <h2 id="threat-model">Threat Model</h2>
    <h3 id="adversary-capabilities">Adversary Capabilities</h3>
    <table>
    <colgroup>
    <col style="width: 35%" />
    <col style="width: 28%" />
    <col style="width: 35%" />
    </colgroup>
    <thead>
    <tr class="header">
    <th>Threat Level</th>
    <th>Adversary</th>
    <th>Capabilities</th>
    </tr>
    </thead>
    <tbody>
    <tr class="odd">
    <td><strong>T1</strong></td>
    <td>Buggy Waveform</td>
    <td>Unintentional memory corruption, resource exhaustion</td>
    </tr>
    <tr class="even">
    <td><strong>T2</strong></td>
    <td>Malicious User</td>
    <td>Intentional attacks within waveform code</td>
    </tr>
    <tr class="odd">
    <td><strong>T3</strong></td>
    <td>Sophisticated</td>
    <td>Side-channel attacks, timing analysis</td>
    </tr>
    <tr class="even">
    <td><strong>T4</strong></td>
    <td>Nation State</td>
    <td>Hardware attacks, supply chain compromise</td>
    </tr>
    </tbody>
    </table>
    <h3 id="assets-to-protect">Assets to Protect</h3>
    <pre><code>┌─────────────────────────────────────────────────────────────────┐
│                      Asset Classification                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Critical (must never leak)                                     │
│  ├── Cryptographic keys (TRANSEC, COMSEC)                       │
│  ├── Classified message content                                 │
│  └── Frequency hopping sequences                                │
│                                                                 │
│  Sensitive (controlled access)                                  │
│  ├── Waveform parameters and configurations                     │
│  ├── Network topology and routing                               │
│  └── User credentials and certificates                          │
│                                                                 │
│  Operational (availability matters)                             │
│  ├── I/Q sample streams                                         │
│  ├── Timing synchronization                                     │
│  └── System health metrics                                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘</code></pre>
    <hr />
    <h2 id="isolation-levels">Isolation Levels</h2>
    <h3 id="quick-reference">Quick Reference</h3>
    <table>
    <thead>
    <tr class="header">
    <th>Level</th>
    <th>Mechanism</th>
    <th>Use Case</th>
    <th>Latency Impact</th>
    </tr>
    </thead>
    <tbody>
    <tr class="odd">
    <td>L1</td>
    <td>Process</td>
    <td>Development, testing</td>
    <td>~0%</td>
    </tr>
    <tr class="even">
    <td>L2</td>
    <td>Namespace</td>
    <td>Multi-tenant non-critical</td>
    <td>~0%</td>
    </tr>
    <tr class="odd">
    <td>L3</td>
    <td>LSM</td>
    <td>Production single-security</td>
    <td>&lt;1%</td>
    </tr>
    <tr class="even">
    <td>L4</td>
    <td>Container</td>
    <td>Multi-tenant production</td>
    <td>1-5%</td>
    </tr>
    <tr class="odd">
    <td>L5</td>
    <td>MicroVM</td>
    <td>High-security multi-tenant</td>
    <td>5-10%</td>
    </tr>
    <tr class="even">
    <td>L6</td>
    <td>Full VM</td>
    <td>MLS environments</td>
    <td>10-20%</td>
    </tr>
    <tr class="odd">
    <td>L7</td>
    <td>Hardware</td>
    <td>Critical infrastructure</td>
    <td>20-50%</td>
    </tr>
    <tr class="even">
    <td>L8</td>
    <td>Air Gap</td>
    <td>Absolute separation</td>
    <td>N/A</td>
    </tr>
    </tbody>
    </table>
    <hr />
    <h2 id="level-1-3-process-isolation">Level 1-3: Process
    Isolation</h2>
    <h3 id="architecture">Architecture</h3>
    <pre><code>┌────────────────────────────────────────────────────────────────────────────┐
│                    Process-Level Isolation (L1-L3)                         │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         Linux Kernel                                │   │
│  │  ┌──────────────────────────────────────────────────────────────┐   │   │
│  │  │                    Security Modules                          │   │   │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐   │   │   │
│  │  │  │  seccomp    │  │  SELinux    │  │     AppArmor        │   │   │   │
│  │  │  │  BPF filter │  │  MAC policy │  │   Path-based MAC    │   │   │   │
│  │  │  └─────────────┘  └─────────────┘  └─────────────────────┘   │   │   │
│  │  └──────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                            │
│  ┌──────────────┐   ┌──────────────┐   ┌──────────────┐                    │
│  │  Waveform A  │   │  Waveform B  │   │  Waveform C  │                    │
│  │              │   │              │   │              │                    │
│  │ PID NS: 1000 │   │ PID NS: 2000 │   │ PID NS: 3000 │                    │
│  │ NET NS: wf-a │   │ NET NS: wf-b │   │ NET NS: wf-c │                    │
│  │ User: wf-a   │   │ User: wf-b   │   │ User: wf-c   │                    │
│  │              │   │              │   │              │                    │
│  │ seccomp: dsp │   │ seccomp: dsp │   │ seccomp: dsp │                    │
│  │ caps: NICE   │   │ caps: NICE   │   │ caps: NICE   │                    │
│  └──────────────┘   └──────────────┘   └──────────────┘                    │
│         │                  │                  │                            │
│         └─────────────────┬┴──────────────────┘                            │
│                           │                                                │
│                    ┌──────▼──────┐                                         │
│                    │   Control   │                                         │
│                    │   Process   │                                         │
│                    │ (r4w-ctl)   │                                         │
│                    └─────────────┘                                         │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘</code></pre>
    <h3 id="r4w-sandbox-api">r4w-sandbox API</h3>
    <div class="sourceCode" id="cb5"><pre
    class="sourceCode rust"><code class="sourceCode rust"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">r4w_sandbox::</span><span class="op">{</span>Sandbox<span class="op">,</span> IsolationLevel<span class="op">,</span> WaveformConfig<span class="op">};</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Create sandbox for a waveform</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> sandbox <span class="op">=</span> <span class="pp">Sandbox::</span>builder()</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>isolation_level(<span class="pp">IsolationLevel::</span>L3_LSM)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>waveform(<span class="st">&quot;BPSK&quot;</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>user(<span class="st">&quot;wf-bpsk&quot;</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>namespaces(<span class="pp">Namespaces::</span>PID <span class="op">|</span> <span class="pp">Namespaces::</span>NET <span class="op">|</span> <span class="pp">Namespaces::</span>MOUNT)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>seccomp_profile(<span class="pp">SeccompProfile::</span>DSP)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>capabilities(<span class="op">&amp;</span>[<span class="pp">Capability::</span>SYS_NICE<span class="op">,</span> <span class="pp">Capability::</span>IPC_LOCK])</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>memory_limit(<span class="dv">512</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>)  <span class="co">// 512 MB</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>cpu_quota(<span class="dv">200</span>)  <span class="co">// 200% = 2 cores</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>build()<span class="op">?;</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Spawn isolated waveform process</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> handle <span class="op">=</span> sandbox<span class="op">.</span>spawn(<span class="op">||</span> <span class="op">{</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// This runs in isolated context</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> waveform <span class="op">=</span> <span class="pp">Bpsk::</span>new(<span class="dv">48000.0</span>)<span class="op">;</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    waveform<span class="op">.</span>run_loop()</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>)<span class="op">?;</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="co">// IPC between control and waveform</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>sandbox<span class="op">.</span>send_command(<span class="pp">Command::</span>SetFrequency(<span class="dv">915_000_000</span>))<span class="op">?;</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> status <span class="op">=</span> sandbox<span class="op">.</span>recv_status()<span class="op">?;</span></span></code></pre></div>
    <h3 id="seccomp-profile-for-dsp">Seccomp Profile for DSP</h3>
    <div class="sourceCode" id="cb6"><pre
    class="sourceCode rust"><code class="sourceCode rust"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// Minimal syscall allowlist for DSP processing</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> dsp_seccomp_profile() <span class="op">-&gt;</span> SeccompProfile <span class="op">{</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="pp">SeccompProfile::</span>new()</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Memory operations (required for signal processing)</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_mmap)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_munmap)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_mprotect)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_mlock)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_madvise)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Basic I/O (for IPC with control process)</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_read)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_write)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_close)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_recvmsg)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_sendmsg)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Shared memory (for sample transfer)</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_shmat)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_shmget)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_shmdt)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_shmctl)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Time (for real-time scheduling)</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_clock_gettime)</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_clock_nanosleep)</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_nanosleep)</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Thread operations</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_futex)</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_clone)  <span class="co">// Restricted to CLONE_THREAD only</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">// FPGA access (restricted paths)</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow_with_args(SYS_openat<span class="op">,</span> <span class="op">|</span>args<span class="op">|</span> <span class="op">{</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Only allow /dev/uio* and /dev/mem</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>            args<span class="op">.</span>path_matches(<span class="st">&quot;/dev/uio*&quot;</span>) <span class="op">||</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>            args<span class="op">.</span>path_matches(<span class="st">&quot;/dev/mem&quot;</span>)</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span>)</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_ioctl)  <span class="co">// For UIO</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Default: kill process on violation</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>default_action(<span class="pp">SeccompAction::</span>Kill)</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <h3 id="selinux-policy-module">SELinux Policy Module</h3>
    <pre><code># r4w_waveform.te - SELinux Type Enforcement for R4W Waveforms

policy_module(r4w_waveform, 1.0.0)

# Define types for each security level
type r4w_unclass_t;      # Unclassified waveforms
type r4w_secret_t;       # Secret waveforms
type r4w_topsecret_t;    # Top Secret waveforms
type r4w_control_t;      # Control process

# File contexts
type r4w_samples_t;      # I/Q sample files
type r4w_keys_t;         # Cryptographic keys
type r4w_config_t;       # Configuration files

# Domain transitions
domain_auto_trans(r4w_control_t, r4w_unclass_exec_t, r4w_unclass_t)
domain_auto_trans(r4w_control_t, r4w_secret_exec_t, r4w_secret_t)

# Isolation rules - prevent cross-level access
neverallow r4w_unclass_t r4w_secret_t:process signal;
neverallow r4w_unclass_t r4w_topsecret_t:process signal;
neverallow r4w_secret_t r4w_topsecret_t:process signal;

# Prevent reading higher classification samples
neverallow r4w_unclass_t { r4w_secret_t r4w_topsecret_t }:shm { read write };

# Key material access
allow r4w_secret_t r4w_keys_t:file { read };
neverallow r4w_unclass_t r4w_keys_t:file *;

# FPGA access controlled by classification
allow r4w_topsecret_t fpga_device_t:chr_file { read write ioctl };
allow r4w_secret_t fpga_device_t:chr_file { read write ioctl };
neverallow r4w_unclass_t fpga_device_t:chr_file *;</code></pre>
    <hr />
    <h2 id="level-4-5-container-isolation">Level 4-5: Container
    Isolation</h2>
    <h3 id="docker-compose-for-multi-waveform-deployment">Docker Compose
    for Multi-Waveform Deployment</h3>
    <div class="sourceCode" id="cb8"><pre
    class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># docker-compose.isolation.yml</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">version</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;3.8&#39;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="fu">x-waveform-common</span><span class="kw">:</span><span class="at"> </span><span class="ot">&amp;waveform-common</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">security_opt</span><span class="kw">:</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> no-new-privileges:true</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> seccomp:seccomp-dsp.json</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">cap_drop</span><span class="kw">:</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> ALL</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">cap_add</span><span class="kw">:</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> SYS_NICE</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> IPC_LOCK</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">read_only</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">tmpfs</span><span class="kw">:</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> /tmp:noexec,nosuid,size=64M</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="co">  # Unclassified waveform - maximum restrictions</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">waveform-unclass</span><span class="kw">:</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">&lt;&lt;</span><span class="kw">:</span><span class="at"> </span><span class="ot">*waveform-common</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> r4w/waveform:latest</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">container_name</span><span class="kw">:</span><span class="at"> r4w-unclass</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> R4W_WAVEFORM=BPSK</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> R4W_SECURITY_LEVEL=UNCLASS</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">mem_limit</span><span class="kw">:</span><span class="at"> 256m</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">cpus</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">pids_limit</span><span class="kw">:</span><span class="at"> </span><span class="dv">50</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">networks</span><span class="kw">:</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> unclass-net</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a><span class="co">    # No FPGA access</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a><span class="co">    # No shared memory with other waveforms</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="co">  # Secret waveform - moderate restrictions</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">waveform-secret</span><span class="kw">:</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">&lt;&lt;</span><span class="kw">:</span><span class="at"> </span><span class="ot">*waveform-common</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> r4w/waveform:latest</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">container_name</span><span class="kw">:</span><span class="at"> r4w-secret</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">security_opt</span><span class="kw">:</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> no-new-privileges:true</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> seccomp:seccomp-dsp.json</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> apparmor:r4w-secret-profile</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> R4W_WAVEFORM=SINCGARS</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> R4W_SECURITY_LEVEL=SECRET</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">mem_limit</span><span class="kw">:</span><span class="at"> 512m</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">cpus</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">pids_limit</span><span class="kw">:</span><span class="at"> </span><span class="dv">100</span></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">devices</span><span class="kw">:</span></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> /dev/uio0:/dev/uio0:rw</span><span class="co">  # FPGA access</span></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> secret-keys:/keys:ro</span></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">networks</span><span class="kw">:</span></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> secret-net</span></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a><span class="co">    # Isolated network, no route to unclass</span></span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a><span class="co">  # Top Secret waveform - minimal restrictions for performance</span></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">waveform-topsecret</span><span class="kw">:</span></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">&lt;&lt;</span><span class="kw">:</span><span class="at"> </span><span class="ot">*waveform-common</span></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> r4w/waveform:latest</span></span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">container_name</span><span class="kw">:</span><span class="at"> r4w-topsecret</span></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">security_opt</span><span class="kw">:</span></span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> no-new-privileges:true</span></span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> seccomp:seccomp-dsp.json</span></span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> apparmor:r4w-topsecret-profile</span></span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> R4W_WAVEFORM=LINK16</span></span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> R4W_SECURITY_LEVEL=TOPSECRET</span></span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">mem_limit</span><span class="kw">:</span><span class="at"> 1g</span></span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">cpus</span><span class="kw">:</span><span class="at"> </span><span class="dv">4</span></span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">pids_limit</span><span class="kw">:</span><span class="at"> </span><span class="dv">200</span></span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">devices</span><span class="kw">:</span></span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> /dev/uio0:/dev/uio0:rw</span></span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> /dev/uio1:/dev/uio1:rw</span></span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> topsecret-keys:/keys:ro</span></span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">networks</span><span class="kw">:</span></span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> topsecret-net</span></span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a><span class="co">    # Dedicated FPGA partition</span></span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a><span class="co">  # Control process - orchestrates all waveforms</span></span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">r4w-control</span><span class="kw">:</span></span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> r4w/control:latest</span></span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">container_name</span><span class="kw">:</span><span class="at"> r4w-control</span></span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">security_opt</span><span class="kw">:</span></span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> no-new-privileges:true</span></span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">cap_drop</span><span class="kw">:</span></span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> ALL</span></span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">networks</span><span class="kw">:</span></span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> unclass-net</span></span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> secret-net</span></span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> topsecret-net</span></span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;127.0.0.1:8080:8080&quot;</span></span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> /var/run/docker.sock:/var/run/docker.sock:ro</span></span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a><span class="fu">networks</span><span class="kw">:</span></span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">unclass-net</span><span class="kw">:</span></span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">driver</span><span class="kw">:</span><span class="at"> bridge</span></span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">internal</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">driver_opts</span><span class="kw">:</span></span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">com.docker.network.bridge.enable_icc</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;false&quot;</span></span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">secret-net</span><span class="kw">:</span></span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">driver</span><span class="kw">:</span><span class="at"> bridge</span></span>
<span id="cb8-106"><a href="#cb8-106" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">internal</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb8-107"><a href="#cb8-107" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">driver_opts</span><span class="kw">:</span></span>
<span id="cb8-108"><a href="#cb8-108" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">com.docker.network.bridge.enable_icc</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;false&quot;</span></span>
<span id="cb8-109"><a href="#cb8-109" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">topsecret-net</span><span class="kw">:</span></span>
<span id="cb8-110"><a href="#cb8-110" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">driver</span><span class="kw">:</span><span class="at"> bridge</span></span>
<span id="cb8-111"><a href="#cb8-111" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">internal</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb8-112"><a href="#cb8-112" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">driver_opts</span><span class="kw">:</span></span>
<span id="cb8-113"><a href="#cb8-113" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">com.docker.network.bridge.enable_icc</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;false&quot;</span></span>
<span id="cb8-114"><a href="#cb8-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-115"><a href="#cb8-115" aria-hidden="true" tabindex="-1"></a><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb8-116"><a href="#cb8-116" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">secret-keys</span><span class="kw">:</span></span>
<span id="cb8-117"><a href="#cb8-117" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">driver</span><span class="kw">:</span><span class="at"> local</span></span>
<span id="cb8-118"><a href="#cb8-118" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">driver_opts</span><span class="kw">:</span></span>
<span id="cb8-119"><a href="#cb8-119" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">type</span><span class="kw">:</span><span class="at"> tmpfs</span></span>
<span id="cb8-120"><a href="#cb8-120" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">o</span><span class="kw">:</span><span class="at"> size=1m,mode=0400</span></span>
<span id="cb8-121"><a href="#cb8-121" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">topsecret-keys</span><span class="kw">:</span></span>
<span id="cb8-122"><a href="#cb8-122" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">driver</span><span class="kw">:</span><span class="at"> local</span></span>
<span id="cb8-123"><a href="#cb8-123" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">driver_opts</span><span class="kw">:</span></span>
<span id="cb8-124"><a href="#cb8-124" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">type</span><span class="kw">:</span><span class="at"> tmpfs</span></span>
<span id="cb8-125"><a href="#cb8-125" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">o</span><span class="kw">:</span><span class="at"> size=1m,mode=0400</span></span></code></pre></div>
    <h3 id="firecracker-microvm-level-5">Firecracker MicroVM (Level
    5)</h3>
    <div class="sourceCode" id="cb9"><pre
    class="sourceCode rust"><code class="sourceCode rust"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">firecracker_sdk::</span><span class="op">{</span>VmConfig<span class="op">,</span> NetworkInterface<span class="op">,</span> Drive<span class="op">};</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// Create a Firecracker microVM for isolated waveform execution</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> create_waveform_microvm(</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    waveform<span class="op">:</span> <span class="op">&amp;</span><span class="dt">str</span><span class="op">,</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    security_level<span class="op">:</span> SecurityLevel<span class="op">,</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>VmHandle<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> config <span class="op">=</span> <span class="pp">VmConfig::</span>builder()</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Minimal kernel for DSP workloads</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>kernel_image(<span class="st">&quot;/var/lib/r4w/vmlinux-dsp&quot;</span>)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>kernel_args(<span class="st">&quot;console=ttyS0 quiet&quot;</span>)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Root filesystem with waveform</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>root_drive(<span class="pp">Drive::</span>builder()</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>path(<span class="pp">format!</span>(<span class="st">&quot;/var/lib/r4w/rootfs-{}.ext4&quot;</span><span class="op">,</span> waveform))</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>read_only(<span class="cn">true</span>)</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>build())</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Resource limits based on security level</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>vcpu_count(<span class="cf">match</span> security_level <span class="op">{</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>            <span class="pp">SecurityLevel::</span>Unclass <span class="op">=&gt;</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>            <span class="pp">SecurityLevel::</span>Secret <span class="op">=&gt;</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>            <span class="pp">SecurityLevel::</span>TopSecret <span class="op">=&gt;</span> <span class="dv">4</span><span class="op">,</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span>)</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>mem_size_mib(<span class="cf">match</span> security_level <span class="op">{</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>            <span class="pp">SecurityLevel::</span>Unclass <span class="op">=&gt;</span> <span class="dv">256</span><span class="op">,</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>            <span class="pp">SecurityLevel::</span>Secret <span class="op">=&gt;</span> <span class="dv">512</span><span class="op">,</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>            <span class="pp">SecurityLevel::</span>TopSecret <span class="op">=&gt;</span> <span class="dv">1024</span><span class="op">,</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span>)</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Network isolation</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>network_interface(<span class="pp">NetworkInterface::</span>builder()</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>iface_id(<span class="st">&quot;eth0&quot;</span>)</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>host_dev_name(<span class="pp">format!</span>(<span class="st">&quot;tap-{}&quot;</span><span class="op">,</span> waveform))</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>build())</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>        <span class="co">// FPGA passthrough (for high-security only)</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>mmio_device(<span class="cf">if</span> security_level <span class="op">&gt;=</span> <span class="pp">SecurityLevel::</span>Secret <span class="op">{</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Some</span>(<span class="pp">MmioDevice::</span>builder()</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>type_(<span class="st">&quot;virtio-fpga&quot;</span>)</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>base_addr(<span class="dv">0x40000000</span>)</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>size(<span class="dv">0x10000</span>)</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>irq(<span class="dv">5</span>)</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>build())</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>            <span class="cn">None</span></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span>)</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>build()<span class="op">?;</span></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>    <span class="pp">VmHandle::</span>spawn(config)</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <hr />
    <h2 id="level-6-virtual-machine-isolation">Level 6: Virtual Machine
    Isolation</h2>
    <h3 id="kvmqemu-with-vfio-passthrough">KVM/QEMU with VFIO
    Passthrough</h3>
    <div class="sourceCode" id="cb10"><pre
    class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># launch-isolated-vm.sh - Launch VM with FPGA passthrough</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="va">WAVEFORM</span><span class="op">=</span><span class="va">$1</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="va">SECURITY_LEVEL</span><span class="op">=</span><span class="va">$2</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine IOMMU group for FPGA</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="va">FPGA_PCI</span><span class="op">=</span><span class="st">&quot;0000:01:00.0&quot;</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="va">IOMMU_GROUP</span><span class="op">=</span><span class="va">$(</span><span class="fu">readlink</span> /sys/bus/pci/devices/<span class="va">$FPGA_PCI</span>/iommu_group <span class="kw">|</span> <span class="fu">basename</span><span class="va">)</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Unbind from host driver</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="va">$FPGA_PCI</span> <span class="op">&gt;</span> /sys/bus/pci/drivers/xilinx_dma/unbind</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="va">$FPGA_PCI</span> <span class="op">&gt;</span> /sys/bus/pci/drivers/vfio-pci/bind</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Launch QEMU with isolated resources</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="ex">qemu-system-x86_64</span> <span class="dt">\</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">-name</span> <span class="st">&quot;r4w-</span><span class="va">${WAVEFORM}</span><span class="st">-</span><span class="va">${SECURITY_LEVEL}</span><span class="st">&quot;</span> <span class="dt">\</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">-machine</span> q35,accel=kvm,kernel-irqchip=split <span class="dt">\</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">-cpu</span> host,+invtsc <span class="dt">\</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">-m</span> 2G <span class="dt">\</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">-smp</span> 4,sockets=1,cores=4,threads=1 <span class="dt">\</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">\</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Memory isolation</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-object</span> memory-backend-memfd,id=mem0,size=2G,share=off <span class="dt">\</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">-numa</span> node,memdev=mem0 <span class="dt">\</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">\</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># CPU pinning for deterministic performance</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-realtime</span> mlock=on <span class="dt">\</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">-overcommit</span> cpu-pm=on <span class="dt">\</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    <span class="dt">\</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># FPGA passthrough via VFIO</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-device</span> vfio-pci,host=<span class="va">$FPGA_PCI</span>,id=fpga0 <span class="dt">\</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>    <span class="dt">\</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Isolated network</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-netdev</span> tap,id=net0,ifname=tap-<span class="va">${WAVEFORM}</span>,script=no <span class="dt">\</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">-device</span> virtio-net-pci,netdev=net0,mac=52:54:00:<span class="va">${SECURITY_LEVEL}</span>:00:01 <span class="dt">\</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    <span class="dt">\</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Secure boot (optional)</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-drive</span> if=pflash,format=raw,readonly=on,file=/usr/share/OVMF/OVMF_CODE.fd <span class="dt">\</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">-drive</span> if=pflash,format=raw,file=/var/lib/r4w/OVMF_VARS_<span class="va">${WAVEFORM}</span>.fd <span class="dt">\</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>    <span class="dt">\</span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Root filesystem</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-drive</span> file=/var/lib/r4w/vm-<span class="va">${WAVEFORM}</span>.qcow2,if=virtio,format=qcow2 <span class="dt">\</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>    <span class="dt">\</span></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Console</span></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-serial</span> stdio <span class="dt">\</span></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">-display</span> none</span></code></pre></div>
    <h3 id="libvirt-configuration">libvirt Configuration</h3>
    <div class="sourceCode" id="cb11"><pre
    class="sourceCode xml"><code class="sourceCode xml"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- /etc/libvirt/qemu/r4w-secret.xml --&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">domain</span><span class="ot"> type=</span><span class="st">&#39;kvm&#39;</span>&gt;</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">name</span>&gt;r4w-secret-sincgars&lt;/<span class="kw">name</span>&gt;</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">uuid</span>&gt;12345678-1234-1234-1234-123456789012&lt;/<span class="kw">uuid</span>&gt;</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">memory</span><span class="ot"> unit=</span><span class="st">&#39;GiB&#39;</span>&gt;2&lt;/<span class="kw">memory</span>&gt;</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">vcpu</span><span class="ot"> placement=</span><span class="st">&#39;static&#39;</span><span class="ot"> cpuset=</span><span class="st">&#39;4-7&#39;</span>&gt;4&lt;/<span class="kw">vcpu</span>&gt;</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">cputune</span>&gt;</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">vcpupin</span><span class="ot"> vcpu=</span><span class="st">&#39;0&#39;</span><span class="ot"> cpuset=</span><span class="st">&#39;4&#39;</span>/&gt;</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">vcpupin</span><span class="ot"> vcpu=</span><span class="st">&#39;1&#39;</span><span class="ot"> cpuset=</span><span class="st">&#39;5&#39;</span>/&gt;</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">vcpupin</span><span class="ot"> vcpu=</span><span class="st">&#39;2&#39;</span><span class="ot"> cpuset=</span><span class="st">&#39;6&#39;</span>/&gt;</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">vcpupin</span><span class="ot"> vcpu=</span><span class="st">&#39;3&#39;</span><span class="ot"> cpuset=</span><span class="st">&#39;7&#39;</span>/&gt;</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">emulatorpin</span><span class="ot"> cpuset=</span><span class="st">&#39;4-7&#39;</span>/&gt;</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">cputune</span>&gt;</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">numatune</span>&gt;</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">memory</span><span class="ot"> mode=</span><span class="st">&#39;strict&#39;</span><span class="ot"> nodeset=</span><span class="st">&#39;1&#39;</span>/&gt;</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">numatune</span>&gt;</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">memoryBacking</span>&gt;</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">hugepages</span>/&gt;</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">locked</span>/&gt;</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">nosharepages</span>/&gt;</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">memoryBacking</span>&gt;</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">os</span>&gt;</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">type</span><span class="ot"> arch=</span><span class="st">&#39;x86_64&#39;</span>&gt;hvm&lt;/<span class="kw">type</span>&gt;</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">loader</span><span class="ot"> readonly=</span><span class="st">&#39;yes&#39;</span><span class="ot"> type=</span><span class="st">&#39;pflash&#39;</span>&gt;/usr/share/OVMF/OVMF_CODE.fd&lt;/<span class="kw">loader</span>&gt;</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">nvram</span>&gt;/var/lib/libvirt/qemu/nvram/r4w-secret_VARS.fd&lt;/<span class="kw">nvram</span>&gt;</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">boot</span><span class="ot"> dev=</span><span class="st">&#39;hd&#39;</span>/&gt;</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">os</span>&gt;</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">features</span>&gt;</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">acpi</span>/&gt;</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">apic</span>/&gt;</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">ioapic</span><span class="ot"> driver=</span><span class="st">&#39;kvm&#39;</span>/&gt;</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">features</span>&gt;</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">devices</span>&gt;</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- FPGA passthrough --&gt;</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">hostdev</span><span class="ot"> mode=</span><span class="st">&#39;subsystem&#39;</span><span class="ot"> type=</span><span class="st">&#39;pci&#39;</span><span class="ot"> managed=</span><span class="st">&#39;yes&#39;</span>&gt;</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">driver</span><span class="ot"> name=</span><span class="st">&#39;vfio&#39;</span>/&gt;</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">source</span>&gt;</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">address</span><span class="ot"> domain=</span><span class="st">&#39;0x0000&#39;</span><span class="ot"> bus=</span><span class="st">&#39;0x01&#39;</span><span class="ot"> slot=</span><span class="st">&#39;0x00&#39;</span><span class="ot"> function=</span><span class="st">&#39;0x0&#39;</span>/&gt;</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>      &lt;/<span class="kw">source</span>&gt;</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">hostdev</span>&gt;</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- Isolated network --&gt;</span></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">interface</span><span class="ot"> type=</span><span class="st">&#39;network&#39;</span>&gt;</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">mac</span><span class="ot"> address=</span><span class="st">&#39;52:54:00:02:00:01&#39;</span>/&gt;</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">source</span><span class="ot"> network=</span><span class="st">&#39;r4w-secret-isolated&#39;</span>/&gt;</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">model</span><span class="ot"> type=</span><span class="st">&#39;virtio&#39;</span>/&gt;</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">interface</span>&gt;</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- Disk --&gt;</span></span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">disk</span><span class="ot"> type=</span><span class="st">&#39;file&#39;</span><span class="ot"> device=</span><span class="st">&#39;disk&#39;</span>&gt;</span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">driver</span><span class="ot"> name=</span><span class="st">&#39;qemu&#39;</span><span class="ot"> type=</span><span class="st">&#39;qcow2&#39;</span>/&gt;</span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">source</span><span class="ot"> file=</span><span class="st">&#39;/var/lib/r4w/vm-sincgars.qcow2&#39;</span>/&gt;</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">target</span><span class="ot"> dev=</span><span class="st">&#39;vda&#39;</span><span class="ot"> bus=</span><span class="st">&#39;virtio&#39;</span>/&gt;</span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">disk</span>&gt;</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">devices</span>&gt;</span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">seclabel</span><span class="ot"> type=</span><span class="st">&#39;static&#39;</span><span class="ot"> model=</span><span class="st">&#39;selinux&#39;</span><span class="ot"> relabel=</span><span class="st">&#39;yes&#39;</span>&gt;</span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">label</span>&gt;system_u:system_r:svirt_t:s0:c123,c456&lt;/<span class="kw">label</span>&gt;</span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">seclabel</span>&gt;</span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">domain</span>&gt;</span></code></pre></div>
    <hr />
    <h2 id="level-7-hardware-isolation">Level 7: Hardware Isolation</h2>
    <h3 id="cpu-and-memory-isolation">CPU and Memory Isolation</h3>
    <div class="sourceCode" id="cb12"><pre
    class="sourceCode rust"><code class="sourceCode rust"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">libc::</span><span class="op">{</span>cpu_set_t<span class="op">,</span> sched_setaffinity<span class="op">,</span> CPU_SET<span class="op">,</span> CPU_ZERO<span class="op">};</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">std::mem::</span>MaybeUninit<span class="op">;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">/// Pin waveform to specific CPU cores</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> pin_to_cores(cores<span class="op">:</span> <span class="op">&amp;</span>[<span class="dt">usize</span>]) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> cpuset <span class="op">=</span> <span class="pp">MaybeUninit::</span><span class="op">&lt;</span>cpu_set_t<span class="op">&gt;</span><span class="pp">::</span>uninit()<span class="op">;</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>        CPU_ZERO(cpuset<span class="op">.</span>as_mut_ptr())<span class="op">;</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">&amp;</span>core <span class="kw">in</span> cores <span class="op">{</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>            CPU_SET(core<span class="op">,</span> cpuset<span class="op">.</span>as_mut_ptr())<span class="op">;</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> result <span class="op">=</span> sched_setaffinity(<span class="dv">0</span><span class="op">,</span> <span class="pp">std::mem::size_of::</span><span class="op">&lt;</span>cpu_set_t<span class="op">&gt;</span>()<span class="op">,</span> cpuset<span class="op">.</span>as_ptr())<span class="op">;</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> result <span class="op">!=</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>AffinityFailed(<span class="pp">std::io::</span><span class="bu">Error</span><span class="pp">::</span>last_os_error()))<span class="op">;</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Ok</span>(())</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="co">/// Configure NUMA memory policy</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> set_numa_policy(node<span class="op">:</span> <span class="dt">usize</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">libc::</span><span class="op">{</span>set_mempolicy<span class="op">,</span> MPOL_BIND<span class="op">};</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> nodemask<span class="op">:</span> <span class="dt">u64</span> <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> node<span class="op">;</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> result <span class="op">=</span> set_mempolicy(</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>            MPOL_BIND<span class="op">,</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span>nodemask <span class="kw">as</span> <span class="op">*</span><span class="kw">const</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>            <span class="pp">std::mem::size_of::</span><span class="op">&lt;</span><span class="dt">u64</span><span class="op">&gt;</span>() <span class="op">*</span> <span class="dv">8</span><span class="op">,</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>        )<span class="op">;</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> result <span class="op">!=</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>NumaFailed(<span class="pp">std::io::</span><span class="bu">Error</span><span class="pp">::</span>last_os_error()))<span class="op">;</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Ok</span>(())</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a><span class="co">/// Hardware isolation configuration</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> HardwareIsolation <span class="op">{</span></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Dedicated CPU cores for this waveform</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> cpu_cores<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">usize</span><span class="op">&gt;,</span></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// NUMA node for memory allocation</span></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> numa_node<span class="op">:</span> <span class="dt">usize</span><span class="op">,</span></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// IOMMU group for FPGA isolation</span></span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> iommu_group<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">&gt;,</span></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Enable Intel CAT (Cache Allocation Technology)</span></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> cache_allocation<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span>CacheConfig<span class="op">&gt;,</span></span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Enable AMD SEV (Secure Encrypted Virtualization)</span></span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> memory_encryption<span class="op">:</span> <span class="dt">bool</span><span class="op">,</span></span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> HardwareIsolation <span class="op">{</span></span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> apply(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Pin to dedicated cores</span></span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>        pin_to_cores(<span class="op">&amp;</span><span class="kw">self</span><span class="op">.</span>cpu_cores)<span class="op">?;</span></span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Set NUMA policy</span></span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>        set_numa_policy(<span class="kw">self</span><span class="op">.</span>numa_node)<span class="op">?;</span></span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Configure cache allocation if available</span></span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Some</span>(<span class="kw">ref</span> cache) <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>cache_allocation <span class="op">{</span></span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>            configure_intel_cat(cache)<span class="op">?;</span></span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a>        <span class="co">// IOMMU isolation is configured at boot/VM level</span></span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(())</span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <h3 id="intel-cache-allocation-technology-cat">Intel Cache
    Allocation Technology (CAT)</h3>
    <div class="sourceCode" id="cb13"><pre
    class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co"># configure-cat.sh - Configure Intel CAT for waveform isolation</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Check CAT support</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="ot">!</span> <span class="ot">-d</span> /sys/fs/resctrl <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mount</span> <span class="at">-t</span> resctrl resctrl /sys/fs/resctrl</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Create resource groups for each security level</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> /sys/fs/resctrl/r4w-unclass</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> /sys/fs/resctrl/r4w-secret</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> /sys/fs/resctrl/r4w-topsecret</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Allocate cache ways (assuming 11 ways available, 0-10)</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Unclass: 2 ways (0-1)</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;L3:0=003&quot;</span> <span class="op">&gt;</span> /sys/fs/resctrl/r4w-unclass/schemata</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Secret: 4 ways (2-5)</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;L3:0=03c&quot;</span> <span class="op">&gt;</span> /sys/fs/resctrl/r4w-secret/schemata</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Top Secret: 5 ways (6-10)</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;L3:0=7c0&quot;</span> <span class="op">&gt;</span> /sys/fs/resctrl/r4w-topsecret/schemata</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign PIDs to resource groups</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="co"># (done dynamically when waveforms start)</span></span></code></pre></div>
    <h3 id="iommu-configuration-for-fpga">IOMMU Configuration for
    FPGA</h3>
    <div class="sourceCode" id="cb14"><pre
    class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /etc/default/grub</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="va">GRUB_CMDLINE_LINUX</span><span class="op">=</span><span class="st">&quot;intel_iommu=on iommu=pt&quot;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify IOMMU groups</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> g <span class="kw">in</span> /sys/kernel/iommu_groups/<span class="pp">*</span>/devices/<span class="pp">*</span><span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;IOMMU Group </span><span class="va">$(</span><span class="fu">basename</span> <span class="va">$(</span><span class="fu">dirname</span> <span class="va">$(</span><span class="fu">dirname</span> <span class="va">$g)))</span><span class="st">:&quot;</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;    </span><span class="va">$(</span><span class="ex">lspci</span> <span class="at">-nns</span> <span class="va">$(</span><span class="fu">basename</span> <span class="va">$g))</span><span class="st">&quot;</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Bind FPGA to VFIO for passthrough</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;10ee 9034&quot;</span> <span class="op">&gt;</span> /sys/bus/pci/drivers/vfio-pci/new_id</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;0000:01:00.0&quot;</span> <span class="op">&gt;</span> /sys/bus/pci/drivers/xilinx_dma/unbind</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;0000:01:00.0&quot;</span> <span class="op">&gt;</span> /sys/bus/pci/drivers/vfio-pci/bind</span></code></pre></div>
    <hr />
    <h2 id="level-8-air-gap-isolation">Level 8: Air-Gap Isolation</h2>
    <h3 id="data-diode-architecture">Data Diode Architecture</h3>
    <pre><code>┌────────────────────────────────────────────────────────────────────────────┐
│                      Air-Gap with Data Diode                               │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│  ┌─────────────────────┐         ┌─────────────────────┐                   │
│  │   High-Side System  │         │   Low-Side System   │                   │
│  │   (TOP SECRET)      │         │   (UNCLASS)         │                   │
│  │                     │         │                     │                   │
│  │  ┌───────────────┐  │         │  ┌───────────────┐  │                   │
│  │  │ Link-16       │  │         │  │ ADS-B         │  │                   │
│  │  │ SINCGARS      │  │         │  │ AIS           │  │                   │
│  │  │ HAVEQUICK     │  │         │  │ Commercial FM │  │                   │
│  │  └───────────────┘  │         │  └───────────────┘  │                   │
│  │         │           │         │         ▲           │                   │
│  │         ▼           │         │         │           │                   │
│  │  ┌───────────────┐  │         │  ┌───────────────┐  │                   │
│  │  │ Data Diode TX │──┼────────►│  │ Data Diode RX │  │                   │
│  │  │ (fiber optic) │  │  ONE    │  │ (fiber optic) │  │                   │
│  │  └───────────────┘  │  WAY    │  └───────────────┘  │                   │
│  │                     │         │                     │                   │
│  └─────────────────────┘         └─────────────────────┘                   │
│                                                                            │
│  • Physical fiber ensures unidirectional flow                              │
│  • No electrical connection between systems                                │
│  • High-to-low only (sanitized data)                                       │
│  • Certified for cross-domain transfer                                     │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘</code></pre>
    <hr />
    <h2 id="fpga-isolation">FPGA Isolation</h2>
    <h3 id="bitstream-partitioning">Bitstream Partitioning</h3>
    <pre><code>┌────────────────────────────────────────────────────────────────────────────┐
│                    FPGA Partial Reconfiguration                            │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         FPGA Fabric                                 │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐  │   │
│  │  │   Static    │  │  Partition  │  │  Partition  │  │  Partition │  │   │
│  │  │   Region    │  │     A       │  │     B       │  │     C      │  │   │
│  │  │             │  │             │  │             │  │            │  │   │
│  │  │ • AXI Bus   │  │ • UNCLASS   │  │ • SECRET    │  │ • TOPSECRET│  │   │
│  │  │ • Clocking  │  │ • Waveform  │  │ • Waveform  │  │ • Waveform │  │   │
│  │  │ • Reset     │  │             │  │             │  │            │  │   │
│  │  │ • Firewall  │◄─┤             │◄─┤             │◄─┤            │  │   │
│  │  │             │  │             │  │             │  │            │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └────────────┘  │   │
│  │                         ▲                ▲                ▲         │   │
│  │                         │                │                │         │   │
│  │         ┌───────────────┴────────────────┴────────────────┴──────┐  │   │ 
│  │         │              AXI Firewall                              │  │   │
│  │         │   • Address filtering per partition                    │  │   │
│  │         │   • Transaction logging                                │  │   │
│  │         │   • Illegal access blocking                            │  │   │
│  │         └────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘</code></pre>
    <h3 id="axi-firewall-configuration">AXI Firewall Configuration</h3>
    <div class="sourceCode" id="cb17"><pre
    class="sourceCode rust"><code class="sourceCode rust"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// FPGA partition isolation using AXI Firewall</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> FpgaPartition <span class="op">{</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Partition identifier</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> id<span class="op">:</span> <span class="dt">u8</span><span class="op">,</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Base address in FPGA memory map</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> base_addr<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Size of partition</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> size<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Security level</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> security_level<span class="op">:</span> SecurityLevel<span class="op">,</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Allowed AXI masters</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> allowed_masters<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>AxiMasterId<span class="op">&gt;,</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> FpgaPartition <span class="op">{</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Configure AXI firewall rules for this partition</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> configure_firewall(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> fpga<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> FpgaHandle) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Set address range</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>        fpga<span class="op">.</span>write_reg(</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>            FIREWALL_BASE <span class="op">+</span> <span class="kw">self</span><span class="op">.</span>id <span class="kw">as</span> <span class="dt">u64</span> <span class="op">*</span> FIREWALL_STRIDE <span class="op">+</span> ADDR_LOW<span class="op">,</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>base_addr<span class="op">,</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>        )<span class="op">?;</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>        fpga<span class="op">.</span>write_reg(</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>            FIREWALL_BASE <span class="op">+</span> <span class="kw">self</span><span class="op">.</span>id <span class="kw">as</span> <span class="dt">u64</span> <span class="op">*</span> FIREWALL_STRIDE <span class="op">+</span> ADDR_HIGH<span class="op">,</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>base_addr <span class="op">+</span> <span class="kw">self</span><span class="op">.</span>size <span class="op">-</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>        )<span class="op">?;</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Configure allowed masters</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> master_mask<span class="op">:</span> <span class="dt">u32</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> master <span class="kw">in</span> <span class="op">&amp;</span><span class="kw">self</span><span class="op">.</span>allowed_masters <span class="op">{</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>            master_mask <span class="op">|=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> master<span class="op">.</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>        fpga<span class="op">.</span>write_reg(</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>            FIREWALL_BASE <span class="op">+</span> <span class="kw">self</span><span class="op">.</span>id <span class="kw">as</span> <span class="dt">u64</span> <span class="op">*</span> FIREWALL_STRIDE <span class="op">+</span> MASTER_ALLOW<span class="op">,</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>            master_mask <span class="kw">as</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>        )<span class="op">?;</span></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Enable firewall</span></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>        fpga<span class="op">.</span>write_reg(</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>            FIREWALL_BASE <span class="op">+</span> <span class="kw">self</span><span class="op">.</span>id <span class="kw">as</span> <span class="dt">u64</span> <span class="op">*</span> FIREWALL_STRIDE <span class="op">+</span> CTRL<span class="op">,</span></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>            FIREWALL_ENABLE <span class="op">|</span> FIREWALL_LOG_VIOLATIONS<span class="op">,</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>        )<span class="op">?;</span></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(())</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <hr />
    <h2 id="memory-protection">Memory Protection</h2>
    <h3 id="encrypted-memory-regions">Encrypted Memory Regions</h3>
    <div class="sourceCode" id="cb18"><pre
    class="sourceCode rust"><code class="sourceCode rust"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">zeroize::</span><span class="op">{</span>Zeroize<span class="op">,</span> ZeroizeOnDrop<span class="op">};</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// Secure buffer that is always encrypted in memory</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span>ZeroizeOnDrop<span class="at">)]</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> SecureBuffer <span class="op">{</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Encrypted data</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    data<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;,</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Encryption key (derived from hardware key)</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    key<span class="op">:</span> [<span class="dt">u8</span><span class="op">;</span> <span class="dv">32</span>]<span class="op">,</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Nonce for encryption</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    nonce<span class="op">:</span> [<span class="dt">u8</span><span class="op">;</span> <span class="dv">12</span>]<span class="op">,</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> SecureBuffer <span class="op">{</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Create new secure buffer</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> new(size<span class="op">:</span> <span class="dt">usize</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">Self</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Derive key from hardware (TPM or CPU key)</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> key <span class="op">=</span> derive_hardware_key()<span class="op">?;</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> nonce <span class="op">=</span> generate_nonce()<span class="op">;</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Allocate and lock memory</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> data <span class="op">=</span> <span class="pp">vec!</span>[<span class="dv">0u8</span><span class="op">;</span> size <span class="op">+</span> <span class="dv">16</span>]<span class="op">;</span> <span class="co">// +16 for auth tag</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>        mlock(<span class="op">&amp;</span>data)<span class="op">?;</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(<span class="dt">Self</span> <span class="op">{</span> data<span class="op">,</span> key<span class="op">,</span> nonce <span class="op">}</span>)</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Write data (encrypts automatically)</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> write(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> plaintext<span class="op">:</span> <span class="op">&amp;</span>[<span class="dt">u8</span>]) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>        <span class="kw">use</span> <span class="pp">aes_gcm::</span><span class="op">{</span>Aes256Gcm<span class="op">,</span> Key<span class="op">,</span> Nonce<span class="op">};</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">use</span> <span class="pp">aes_gcm::aead::</span><span class="op">{</span>Aead<span class="op">,</span> NewAead<span class="op">};</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> cipher <span class="op">=</span> <span class="pp">Aes256Gcm::</span>new(<span class="pp">Key::</span>from_slice(<span class="op">&amp;</span><span class="kw">self</span><span class="op">.</span>key))<span class="op">;</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> nonce <span class="op">=</span> <span class="pp">Nonce::</span>from_slice(<span class="op">&amp;</span><span class="kw">self</span><span class="op">.</span>nonce)<span class="op">;</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> ciphertext <span class="op">=</span> cipher<span class="op">.</span>encrypt(nonce<span class="op">,</span> plaintext)</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>map_err(<span class="op">|</span>_<span class="op">|</span> <span class="bu">Error</span><span class="pp">::</span>EncryptionFailed)<span class="op">?;</span></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>data[<span class="op">..</span>ciphertext<span class="op">.</span>len()]<span class="op">.</span>copy_from_slice(<span class="op">&amp;</span>ciphertext)<span class="op">;</span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Increment nonce</span></span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>        increment_nonce(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">.</span>nonce)<span class="op">;</span></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(())</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Read data (decrypts automatically)</span></span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> read(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> len<span class="op">:</span> <span class="dt">usize</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;&gt;</span> <span class="op">{</span></span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>        <span class="kw">use</span> <span class="pp">aes_gcm::</span><span class="op">{</span>Aes256Gcm<span class="op">,</span> Key<span class="op">,</span> Nonce<span class="op">};</span></span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>        <span class="kw">use</span> <span class="pp">aes_gcm::aead::</span><span class="op">{</span>Aead<span class="op">,</span> NewAead<span class="op">};</span></span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> cipher <span class="op">=</span> <span class="pp">Aes256Gcm::</span>new(<span class="pp">Key::</span>from_slice(<span class="op">&amp;</span><span class="kw">self</span><span class="op">.</span>key))<span class="op">;</span></span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Use previous nonce for decryption</span></span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> prev_nonce <span class="op">=</span> decrement_nonce(<span class="op">&amp;</span><span class="kw">self</span><span class="op">.</span>nonce)<span class="op">;</span></span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> nonce <span class="op">=</span> <span class="pp">Nonce::</span>from_slice(<span class="op">&amp;</span>prev_nonce)<span class="op">;</span></span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> plaintext <span class="op">=</span> cipher<span class="op">.</span>decrypt(nonce<span class="op">,</span> <span class="op">&amp;</span><span class="kw">self</span><span class="op">.</span>data[<span class="op">..</span>len <span class="op">+</span> <span class="dv">16</span>])</span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>map_err(<span class="op">|</span>_<span class="op">|</span> <span class="bu">Error</span><span class="pp">::</span>DecryptionFailed)<span class="op">?;</span></span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(plaintext)</span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> <span class="bu">Drop</span> <span class="cf">for</span> SecureBuffer <span class="op">{</span></span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> drop(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">{</span></span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Zeroize is handled by derive macro, but also unlock</span></span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a>        munlock(<span class="op">&amp;</span><span class="kw">self</span><span class="op">.</span>data)<span class="op">.</span>ok()<span class="op">;</span></span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <h3 id="guard-pages">Guard Pages</h3>
    <div class="sourceCode" id="cb19"><pre
    class="sourceCode rust"><code class="sourceCode rust"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// Allocate buffer with guard pages</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> allocate_guarded(size<span class="op">:</span> <span class="dt">usize</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>GuardedBuffer<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> page_size <span class="op">=</span> <span class="kw">unsafe</span> <span class="op">{</span> <span class="pp">libc::</span>sysconf(<span class="pp">libc::</span>_SC_PAGESIZE) <span class="op">}</span> <span class="kw">as</span> <span class="dt">usize</span><span class="op">;</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Round up to page boundary</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> aligned_size <span class="op">=</span> (size <span class="op">+</span> page_size <span class="op">-</span> <span class="dv">1</span>) <span class="op">&amp;</span> <span class="op">!</span>(page_size <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Allocate: guard + data + guard</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> total_size <span class="op">=</span> aligned_size <span class="op">+</span> <span class="dv">2</span> <span class="op">*</span> page_size<span class="op">;</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> ptr <span class="op">=</span> <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>        <span class="pp">libc::</span>mmap(</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>            <span class="pp">std::ptr::</span>null_mut()<span class="op">,</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>            total_size<span class="op">,</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>            <span class="pp">libc::</span>PROT_NONE<span class="op">,</span>  <span class="co">// Start with no permissions</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>            <span class="pp">libc::</span>MAP_PRIVATE <span class="op">|</span> <span class="pp">libc::</span>MAP_ANONYMOUS<span class="op">,</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>            <span class="op">-</span><span class="dv">1</span><span class="op">,</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>            <span class="dv">0</span><span class="op">,</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ptr <span class="op">==</span> <span class="pp">libc::</span>MAP_FAILED <span class="op">{</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>MmapFailed(<span class="pp">std::io::</span><span class="bu">Error</span><span class="pp">::</span>last_os_error()))<span class="op">;</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Make data region readable/writable</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> data_ptr <span class="op">=</span> <span class="kw">unsafe</span> <span class="op">{</span> ptr<span class="op">.</span>add(page_size) <span class="op">};</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>        <span class="pp">libc::</span>mprotect(</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>            data_ptr<span class="op">,</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>            aligned_size<span class="op">,</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>            <span class="pp">libc::</span>PROT_READ <span class="op">|</span> <span class="pp">libc::</span>PROT_WRITE<span class="op">,</span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>        )<span class="op">;</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Guard pages remain PROT_NONE - any access triggers SIGSEGV</span></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Ok</span>(GuardedBuffer <span class="op">{</span></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>        ptr<span class="op">:</span> data_ptr<span class="op">,</span></span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>        size<span class="op">:</span> aligned_size<span class="op">,</span></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>        total_ptr<span class="op">:</span> ptr<span class="op">,</span></span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>        total_size<span class="op">,</span></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span>)</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <hr />
    <h2 id="cross-domain-solutions">Cross-Domain Solutions</h2>
    <h3 id="multi-level-security-architecture">Multi-Level Security
    Architecture</h3>
    <pre><code>┌─────────────────────────────────────────────────────────────────────────────┐
│                    Cross-Domain Solution (CDS)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                      ┌─────────────────────┐                                │
│                      │    Guard Server     │                                │
│                      │                     │                                │
│                      │ • Policy Engine     │                                │
│                      │ • Content Filter    │                                │
│                      │ • Audit Logger      │                                │
│                      │ • Crypto Services   │                                │
│                      └──────────┬──────────┘                                │
│                                 │                                           │
│         ┌───────────────────────┼───────────────────────┐                   │
│         │                       │                       │                   │
│         ▼                       ▼                       ▼                   │
│  ┌──────────────┐       ┌──────────────┐       ┌──────────────┐             │
│  │  UNCLASS     │       │   SECRET     │       │  TOP SECRET  │             │
│  │  Domain      │       │   Domain     │       │   Domain     │             │
│  │              │       │              │       │              │             │
│  │ • ADS-B      │       │ • SINCGARS   │       │ • Link-16    │             │
│  │ • AIS        │       │ • P25        │       │ • HAVEQUICK  │             │
│  │ • Commercial │       │ • MIL-STD    │       │ • JTRS       │             │
│  └──────────────┘       └──────────────┘       └──────────────┘             │
│                                                                             │
│  Data Flow Rules:                                                           │
│  • UNCLASS ──► SECRET ──► TOP SECRET  (upward allowed)                      │
│  • TOP SECRET ──► SECRET ──► UNCLASS  (downward: guard filtered only)       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘</code></pre>
    <hr />
    <h2 id="implementation-guide">Implementation Guide</h2>
    <h3 id="r4w-sandbox-crate-structure">r4w-sandbox Crate
    Structure</h3>
    <pre><code>crates/r4w-sandbox/
├── Cargo.toml
├── src/
│   ├── lib.rs
│   ├── levels/
│   │   ├── mod.rs
│   │   ├── process.rs      # L1-L2: Process/namespace isolation
│   │   ├── lsm.rs          # L3: seccomp/SELinux/AppArmor
│   │   ├── container.rs    # L4: Docker/Podman integration
│   │   ├── microvm.rs      # L5: Firecracker/gVisor
│   │   ├── vm.rs           # L6: KVM/QEMU
│   │   └── hardware.rs     # L7: CPU pinning, NUMA, IOMMU
│   ├── memory/
│   │   ├── mod.rs
│   │   ├── secure.rs       # Encrypted buffers
│   │   ├── guarded.rs      # Guard pages
│   │   └── zeroize.rs      # Secure cleanup
│   ├── ipc/
│   │   ├── mod.rs
│   │   ├── channel.rs      # Secure IPC channels
│   │   └── shm.rs          # Isolated shared memory
│   ├── fpga/
│   │   ├── mod.rs
│   │   ├── partition.rs    # FPGA partitioning
│   │   └── firewall.rs     # AXI firewall config
│   └── policy/
│       ├── mod.rs
│       ├── seccomp.rs      # Seccomp profiles
│       ├── selinux.rs      # SELinux policy generation
│       └── apparmor.rs     # AppArmor profile generation
├── profiles/
│   ├── seccomp-dsp.json
│   ├── seccomp-crypto.json
│   └── apparmor-dsp.profile
└── tests/
    ├── isolation_tests.rs
    └── escape_tests.rs</code></pre>
    <h3 id="basic-usage">Basic Usage</h3>
    <div class="sourceCode" id="cb22"><pre
    class="sourceCode rust"><code class="sourceCode rust"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">r4w_sandbox::</span><span class="op">{</span>Sandbox<span class="op">,</span> IsolationLevel<span class="op">};</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">r4w_core::waveform::bpsk::</span>Bpsk<span class="op">;</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> main() <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create isolated sandbox for BPSK waveform</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> sandbox <span class="op">=</span> <span class="pp">Sandbox::</span>new(<span class="pp">IsolationLevel::</span>L3_LSM)<span class="op">?</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>name(<span class="st">&quot;waveform-bpsk&quot;</span>)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>memory_limit(<span class="dv">256</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>cpu_cores(<span class="op">&amp;</span>[<span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>])</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>seccomp_profile(<span class="st">&quot;dsp&quot;</span>)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>build()<span class="op">?;</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Spawn waveform in sandbox</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> handle <span class="op">=</span> sandbox<span class="op">.</span>spawn(<span class="op">||</span> <span class="op">{</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> waveform <span class="op">=</span> <span class="pp">Bpsk::</span>new(<span class="dv">48000.0</span>)<span class="op">;</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ... process samples</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span>)<span class="op">?;</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Communicate via secure IPC</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> (tx<span class="op">,</span> rx) <span class="op">=</span> sandbox<span class="op">.</span><span class="pp">create_channel::</span><span class="op">&lt;</span>WaveformCommand<span class="op">&gt;</span>()<span class="op">?;</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    tx<span class="op">.</span>send(<span class="pp">WaveformCommand::</span>SetFrequency(<span class="dv">915_000_000</span>))<span class="op">?;</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>    handle<span class="op">.</span>wait()<span class="op">?;</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Ok</span>(())</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <hr />
    <h2 id="deployment-configurations">Deployment Configurations</h2>
    <h3 id="development-l1-l2">Development (L1-L2)</h3>
    <div class="sourceCode" id="cb23"><pre
    class="sourceCode bash"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Minimal isolation for development</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="ex">r4w</span> sandbox <span class="at">--level</span> process <span class="at">--waveform</span> BPSK</span></code></pre></div>
    <h3 id="production-single-tenant-l3">Production Single-Tenant
    (L3)</h3>
    <div class="sourceCode" id="cb24"><pre
    class="sourceCode bash"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Production with LSM enforcement</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="ex">r4w</span> sandbox <span class="at">--level</span> lsm <span class="dt">\</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">--seccomp-profile</span> dsp <span class="dt">\</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">--selinux-context</span> r4w_production_t <span class="dt">\</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">--waveform</span> SINCGARS</span></code></pre></div>
    <h3 id="production-multi-tenant-l4">Production Multi-Tenant
    (L4)</h3>
    <div class="sourceCode" id="cb25"><pre
    class="sourceCode bash"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Container-based multi-waveform</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="ex">docker-compose</span> <span class="at">-f</span> docker-compose.isolation.yml up</span></code></pre></div>
    <h3 id="high-security-multi-tenant-l5">High-Security Multi-Tenant
    (L5)</h3>
    <div class="sourceCode" id="cb26"><pre
    class="sourceCode bash"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Firecracker microVM for each waveform</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Provides VM-level isolation with container-like startup times</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create microVM for SECRET waveform</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="ex">r4w</span> sandbox <span class="at">--level</span> microvm <span class="dt">\</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">--kernel</span> /var/lib/r4w/vmlinux-dsp <span class="dt">\</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">--rootfs</span> /var/lib/r4w/rootfs-sincgars.ext4 <span class="dt">\</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">--vcpus</span> 2 <span class="dt">\</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">--memory</span> 512M <span class="dt">\</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">--network</span> tap-sincgars <span class="dt">\</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">--waveform</span> SINCGARS</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternative: gVisor for OCI container isolation with syscall interception</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">--runtime</span><span class="op">=</span>runsc <span class="dt">\</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">--security-opt</span> seccomp=seccomp-dsp.json <span class="dt">\</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">--cpus</span><span class="op">=</span>2 <span class="at">--memory</span><span class="op">=</span>512m <span class="dt">\</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    r4w/waveform:latest <span class="at">--waveform</span> SINCGARS</span></code></pre></div>
    <div class="sourceCode" id="cb27"><pre
    class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># firecracker-waveform.yaml - Firecracker configuration</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">machine-config</span><span class="kw">:</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">vcpu_count</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">mem_size_mib</span><span class="kw">:</span><span class="at"> </span><span class="dv">512</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">smt</span><span class="kw">:</span><span class="at"> </span><span class="ch">false</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="fu">boot-source</span><span class="kw">:</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">kernel_image_path</span><span class="kw">:</span><span class="at"> /var/lib/r4w/vmlinux-dsp</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">boot_args</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;console=ttyS0 quiet r4w.waveform=SINCGARS r4w.level=SECRET&quot;</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="fu">drives</span><span class="kw">:</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">drive_id</span><span class="kw">:</span><span class="at"> rootfs</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">path_on_host</span><span class="kw">:</span><span class="at"> /var/lib/r4w/rootfs-sincgars.ext4</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">is_root_device</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">is_read_only</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="fu">network-interfaces</span><span class="kw">:</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">iface_id</span><span class="kw">:</span><span class="at"> eth0</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">host_dev_name</span><span class="kw">:</span><span class="at"> tap-sincgars</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">guest_mac</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;06:00:AC:10:00:02&quot;</span></span></code></pre></div>
    <h3 id="high-security-l6-l7">High-Security (L6-L7)</h3>
    <div class="sourceCode" id="cb28"><pre
    class="sourceCode bash"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># VM with hardware isolation</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="ex">r4w</span> sandbox <span class="at">--level</span> vm <span class="dt">\</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">--cpu-pinning</span> 4,5,6,7 <span class="dt">\</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">--numa-node</span> 1 <span class="dt">\</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">--iommu-group</span> 12 <span class="dt">\</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">--waveform</span> LINK16</span></code></pre></div>
    <hr />
    <h2 id="references">References</h2>
    <ul>
    <li><a
    href="https://man7.org/linux/man-pages/man7/namespaces.7.html">Linux
    Namespaces</a></li>
    <li><a
    href="https://www.kernel.org/doc/html/latest/userspace-api/seccomp_filter.html">Seccomp
    BPF</a></li>
    <li><a href="https://selinuxproject.org/">SELinux</a></li>
    <li><a href="https://apparmor.net/">AppArmor</a></li>
    <li><a href="https://firecracker-microvm.github.io/">Firecracker
    MicroVMs</a></li>
    <li><a
    href="https://www.intel.com/content/www/us/en/developer/articles/technical/introduction-to-cache-allocation-technology.html">Intel
    CAT</a></li>
    <li><a href="https://developer.amd.com/sev/">AMD SEV</a></li>
    <li><a
    href="https://www.kernel.org/doc/html/latest/driver-api/vfio.html">VFIO</a></li>
    <li><a
    href="https://www.nsa.gov/What-We-Do/Cybersecurity/Cross-Domain/">Cross
    Domain Solutions</a></li>
    </ul>
</body>
</html>
