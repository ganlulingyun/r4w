<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Waveform Developer's Guide - R4W Documentation</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="nav">
        <a href="../index.html">Presentations</a>
        <a href="index.html">Documentation</a>
    </div>
    <h1 id="waveform-developers-guide">Waveform Developer’s Guide</h1>
    <p><strong>R4W - Rust for Waveforms</strong> <em>Comprehensive Guide
    for Waveform Software Engineers</em></p>
    <hr />
    <h2 id="table-of-contents">Table of Contents</h2>
    <ol type="1">
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#development-environment">Development
    Environment</a></li>
    <li><a href="#waveform-architecture">Waveform Architecture</a></li>
    <li><a href="#implementing-waveforms">Implementing
    Waveforms</a></li>
    <li><a href="#debugging-techniques">Debugging Techniques</a></li>
    <li><a href="#benchmarking-and-profiling">Benchmarking and
    Profiling</a></li>
    <li><a href="#cross-compilation">Cross-Compilation</a></li>
    <li><a href="#deployment">Deployment</a></li>
    <li><a href="#system-integration">System Integration</a></li>
    <li><a href="#memory-and-cpu-constraints">Memory and CPU
    Constraints</a></li>
    <li><a href="#shared-memory-ipc">Shared Memory IPC</a></li>
    <li><a href="#real-time-processing">Real-Time Processing</a></li>
    <li><a href="#testing-strategies">Testing Strategies</a></li>
    <li><a href="#fpga-acceleration">FPGA Acceleration</a></li>
    <li><a href="#security-considerations">Security
    Considerations</a></li>
    </ol>
    <hr />
    <h2 id="introduction">Introduction</h2>
    <h3 id="purpose">Purpose</h3>
    <p>This guide is designed for software engineers developing
    waveforms on the R4W platform. It covers the complete development
    lifecycle from implementation to deployment, including debugging,
    optimization, and system integration.</p>
    <h3 id="prerequisites">Prerequisites</h3>
    <ul>
    <li>Rust programming experience (intermediate level)</li>
    <li>Understanding of digital signal processing fundamentals</li>
    <li>Familiarity with modulation techniques (PSK, FSK, QAM)</li>
    <li>Basic Linux system administration skills</li>
    </ul>
    <h3 id="what-this-guide-covers">What This Guide Covers</h3>
    <table>
    <thead>
    <tr class="header">
    <th>Topic</th>
    <th>Description</th>
    </tr>
    </thead>
    <tbody>
    <tr class="odd">
    <td><strong>Implementation</strong></td>
    <td>Creating waveforms using the R4W trait system</td>
    </tr>
    <tr class="even">
    <td><strong>Debugging</strong></td>
    <td>Tools and techniques for finding issues</td>
    </tr>
    <tr class="odd">
    <td><strong>Benchmarking</strong></td>
    <td>Measuring and optimizing performance</td>
    </tr>
    <tr class="even">
    <td><strong>Cross-Compilation</strong></td>
    <td>Building for ARM, PowerPC, embedded targets</td>
    </tr>
    <tr class="odd">
    <td><strong>Deployment</strong></td>
    <td>Getting waveforms running on target hardware</td>
    </tr>
    <tr class="even">
    <td><strong>Integration</strong></td>
    <td>Working with existing systems and hardware</td>
    </tr>
    <tr class="odd">
    <td><strong>Real-Time</strong></td>
    <td>Meeting timing constraints</td>
    </tr>
    </tbody>
    </table>
    <hr />
    <h2 id="development-environment">Development Environment</h2>
    <h3 id="required-tools">Required Tools</h3>
    <div class="sourceCode" id="cb1"><pre
    class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Core development tools</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">rustup</span> install stable</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="ex">rustup</span> target add aarch64-unknown-linux-gnu  <span class="co"># ARM64</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="ex">rustup</span> target add armv7-unknown-linux-gnueabihf  <span class="co"># ARM32</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="ex">rustup</span> target add x86_64-unknown-linux-musl  <span class="co"># Static linking</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Build essentials</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt install build-essential pkg-config libssl-dev</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Cross-compilation toolchains</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt install gcc-aarch64-linux-gnu g++-aarch64-linux-gnu</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt install gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Analysis tools</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> install cargo-flamegraph  <span class="co"># Profiling</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> install cargo-bloat       <span class="co"># Binary size analysis</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> install cargo-asm         <span class="co"># Assembly inspection</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> install criterion         <span class="co"># Benchmarking (via cargo bench)</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: GUI development</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt install libgtk-3-dev libxcb-render0-dev libxcb-shape0-dev</span></code></pre></div>
    <h3 id="project-structure">Project Structure</h3>
    <pre><code>ai-sdr-lora/
├── crates/
│   ├── r4w-core/           # DSP algorithms and waveform trait
│   │   ├── src/
│   │   │   ├── dsp/        # FFT, filters, chirp generation
│   │   │   ├── waveform/   # Waveform implementations
│   │   │   │   ├── mod.rs
│   │   │   │   ├── trait.rs
│   │   │   │   ├── factory.rs
│   │   │   │   ├── lora.rs
│   │   │   │   ├── psk.rs
│   │   │   │   ├── fsk.rs
│   │   │   │   └── ...
│   │   │   └── lib.rs
│   │   └── benches/        # Criterion benchmarks
│   ├── r4w-sim/            # Channel simulation
│   ├── r4w-fpga/           # FPGA acceleration
│   ├── r4w-cli/            # Command-line interface
│   └── r4w-gui/            # GUI application
├── vivado/                 # Xilinx FPGA designs
├── lattice/                # Lattice FPGA designs
└── docs/                   # Documentation</code></pre>
    <h3 id="ide-setup">IDE Setup</h3>
    <p><strong>VS Code (Recommended):</strong></p>
    <div class="sourceCode" id="cb3"><pre
    class="sourceCode json"><code class="sourceCode json"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="er">//</span> <span class="er">.vscode/settings.json</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;rust-analyzer.cargo.features&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;all&quot;</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;rust-analyzer.checkOnSave.command&quot;</span><span class="fu">:</span> <span class="st">&quot;clippy&quot;</span><span class="fu">,</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;rust-analyzer.lens.enable&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;rust-analyzer.inlayHints.enable&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;editor.formatOnSave&quot;</span><span class="fu">:</span> <span class="kw">true</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
    <p><strong>Recommended Extensions:</strong> - rust-analyzer -
    CodeLLDB (debugging) - Error Lens - Better TOML</p>
    <hr />
    <h2 id="waveform-architecture">Waveform Architecture</h2>
    <h3 id="the-waveform-trait">The Waveform Trait</h3>
    <p>Every waveform in R4W implements the <code>Waveform</code>
    trait:</p>
    <div class="sourceCode" id="cb4"><pre
    class="sourceCode rust"><code class="sourceCode rust"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">trait</span> Waveform<span class="op">:</span> <span class="bu">Send</span> <span class="op">+</span> <span class="bu">Sync</span> <span class="op">{</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Get waveform metadata</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> info(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> WaveformInfo<span class="op">;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Modulate bits to I/Q samples</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> modulate(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> bits<span class="op">:</span> <span class="op">&amp;</span>[<span class="dt">bool</span>]) <span class="op">-&gt;</span> <span class="dt">Vec</span><span class="op">&lt;</span>IQSample<span class="op">&gt;;</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Demodulate I/Q samples to bits</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> demodulate(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> samples<span class="op">:</span> <span class="op">&amp;</span>[IQSample]) <span class="op">-&gt;</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">bool</span><span class="op">&gt;;</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Constellation points for visualization</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> constellation_points(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Vec</span><span class="op">&lt;</span>IQSample<span class="op">&gt;;</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Educational: show modulation pipeline stages</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> get_modulation_stages(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> bits<span class="op">:</span> <span class="op">&amp;</span>[<span class="dt">bool</span>]) <span class="op">-&gt;</span> <span class="dt">Vec</span><span class="op">&lt;</span>ModulationStage<span class="op">&gt;;</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Educational: show demodulation pipeline stages</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> get_demodulation_steps(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> samples<span class="op">:</span> <span class="op">&amp;</span>[IQSample]) <span class="op">-&gt;</span> <span class="dt">Vec</span><span class="op">&lt;</span>DemodulationStep<span class="op">&gt;;</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <h3 id="data-types">Data Types</h3>
    <div class="sourceCode" id="cb5"><pre
    class="sourceCode rust"><code class="sourceCode rust"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// Complex I/Q sample (32-bit float precision)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Clone</span><span class="op">,</span> <span class="bu">Copy</span><span class="op">,</span> <span class="bu">Debug</span><span class="at">)]</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> IQSample <span class="op">{</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> i<span class="op">:</span> <span class="dt">f32</span><span class="op">,</span>  <span class="co">// In-phase (real)</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> q<span class="op">:</span> <span class="dt">f32</span><span class="op">,</span>  <span class="co">// Quadrature (imaginary)</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> IQSample <span class="op">{</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> new(i<span class="op">:</span> <span class="dt">f32</span><span class="op">,</span> q<span class="op">:</span> <span class="dt">f32</span>) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Self</span> <span class="op">{</span> i<span class="op">,</span> q <span class="op">}</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> magnitude(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">f32</span> <span class="op">{</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">self</span><span class="op">.</span>i <span class="op">*</span> <span class="kw">self</span><span class="op">.</span>i <span class="op">+</span> <span class="kw">self</span><span class="op">.</span>q <span class="op">*</span> <span class="kw">self</span><span class="op">.</span>q)<span class="op">.</span>sqrt()</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> phase(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">f32</span> <span class="op">{</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>q<span class="op">.</span>atan2(<span class="kw">self</span><span class="op">.</span>i)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <h3 id="waveform-lifecycle">Waveform Lifecycle</h3>
    <pre><code>┌─────────────────────────────────────────────────────────────────────────────┐
│                         Waveform Processing Flow                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Transmit Path:                                                             │
│  ┌──────────┐   ┌──────────────┐   ┌───────────────┐   ┌─────────────────┐  │
│  │  Data    │──►│  Modulator   │──►│  Channel Sim  │──►│  RF/Transport   │  │
│  │  (bits)  │   │  (waveform)  │   │  (AWGN, etc)  │   │  (UDP/hardware) │  │
│  └──────────┘   └──────────────┘   └───────────────┘   └─────────────────┘  │
│                                                                             │
│  Receive Path:                                                              │
│  ┌─────────────────┐   ┌───────────────┐   ┌──────────────┐   ┌──────────┐  │
│  │  RF/Transport   │──►│  Demodulator  │──►│  Bit Decoder │──►│  Data    │  │
│  │  (samples)      │   │  (waveform)   │   │  (optional)  │   │  (bits)  │  │
│  └─────────────────┘   └───────────────┘   └──────────────┘   └──────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘</code></pre>
    <hr />
    <h2 id="implementing-waveforms">Implementing Waveforms</h2>
    <h3 id="step-1-create-the-waveform-module">Step 1: Create the
    Waveform Module</h3>
    <div class="sourceCode" id="cb7"><pre
    class="sourceCode rust"><code class="sourceCode rust"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">// crates/r4w-core/src/waveform/my_waveform.rs</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="kw">crate</span><span class="pp">::types::</span>IQSample<span class="op">;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="kw">crate</span><span class="pp">::waveform::</span><span class="op">{</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    Waveform<span class="op">,</span> WaveformInfo<span class="op">,</span> ModulationStage<span class="op">,</span> DemodulationStep</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">std::</span><span class="dt">f32</span><span class="pp">::consts::</span>PI<span class="op">;</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co">/// My custom waveform implementation</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> MyWaveform <span class="op">{</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    sample_rate<span class="op">:</span> <span class="dt">f64</span><span class="op">,</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    symbol_rate<span class="op">:</span> <span class="dt">f64</span><span class="op">,</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    samples_per_symbol<span class="op">:</span> <span class="dt">usize</span><span class="op">,</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> MyWaveform <span class="op">{</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> new(sample_rate<span class="op">:</span> <span class="dt">f64</span><span class="op">,</span> symbol_rate<span class="op">:</span> <span class="dt">f64</span>) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> samples_per_symbol <span class="op">=</span> (sample_rate <span class="op">/</span> symbol_rate) <span class="kw">as</span> <span class="dt">usize</span><span class="op">;</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>            sample_rate<span class="op">,</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>            symbol_rate<span class="op">,</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>            samples_per_symbol<span class="op">,</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Default configuration</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> default_config(sample_rate<span class="op">:</span> <span class="dt">f64</span>) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Self</span><span class="pp">::</span>new(sample_rate<span class="op">,</span> sample_rate <span class="op">/</span> <span class="dv">10.0</span>)</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <h3 id="step-2-implement-the-waveform-trait">Step 2: Implement the
    Waveform Trait</h3>
    <div class="sourceCode" id="cb8"><pre
    class="sourceCode rust"><code class="sourceCode rust"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> Waveform <span class="cf">for</span> MyWaveform <span class="op">{</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> info(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> WaveformInfo <span class="op">{</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>        WaveformInfo <span class="op">{</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>            name<span class="op">:</span> <span class="st">&quot;MyWave&quot;</span><span class="op">,</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>            full_name<span class="op">:</span> <span class="st">&quot;My Custom Waveform&quot;</span><span class="op">,</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>            bits_per_symbol<span class="op">:</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>            sample_rate<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>sample_rate<span class="op">,</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>            symbol_rate<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>symbol_rate<span class="op">,</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>            carries_data<span class="op">:</span> <span class="cn">true</span><span class="op">,</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> modulate(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> bits<span class="op">:</span> <span class="op">&amp;</span>[<span class="dt">bool</span>]) <span class="op">-&gt;</span> <span class="dt">Vec</span><span class="op">&lt;</span>IQSample<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> samples <span class="op">=</span> <span class="dt">Vec</span><span class="pp">::</span>with_capacity(</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>            (bits<span class="op">.</span>len() <span class="op">/</span> <span class="dv">2</span>) <span class="op">*</span> <span class="kw">self</span><span class="op">.</span>samples_per_symbol</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        )<span class="op">;</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Process bits in pairs (QPSK-like)</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> chunk <span class="kw">in</span> bits<span class="op">.</span>chunks(<span class="dv">2</span>) <span class="op">{</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> (b0<span class="op">,</span> b1) <span class="op">=</span> (</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>                chunk<span class="op">.</span>get(<span class="dv">0</span>)<span class="op">.</span>copied()<span class="op">.</span>unwrap_or(<span class="cn">false</span>)<span class="op">,</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>                chunk<span class="op">.</span>get(<span class="dv">1</span>)<span class="op">.</span>copied()<span class="op">.</span>unwrap_or(<span class="cn">false</span>)<span class="op">,</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>            )<span class="op">;</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Gray-coded constellation</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> symbol <span class="op">=</span> <span class="cf">match</span> (b0<span class="op">,</span> b1) <span class="op">{</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>                (<span class="cn">false</span><span class="op">,</span> <span class="cn">false</span>) <span class="op">=&gt;</span> <span class="pp">IQSample::</span>new(<span class="op">-</span><span class="dv">0.707</span><span class="op">,</span> <span class="op">-</span><span class="dv">0.707</span>)<span class="op">,</span>  <span class="co">// 225°</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>                (<span class="cn">false</span><span class="op">,</span> <span class="cn">true</span>)  <span class="op">=&gt;</span> <span class="pp">IQSample::</span>new(<span class="op">-</span><span class="dv">0.707</span><span class="op">,</span>  <span class="dv">0.707</span>)<span class="op">,</span>  <span class="co">// 135°</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>                (<span class="cn">true</span><span class="op">,</span>  <span class="cn">true</span>)  <span class="op">=&gt;</span> <span class="pp">IQSample::</span>new( <span class="dv">0.707</span><span class="op">,</span>  <span class="dv">0.707</span>)<span class="op">,</span>  <span class="co">// 45°</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>                (<span class="cn">true</span><span class="op">,</span>  <span class="cn">false</span>) <span class="op">=&gt;</span> <span class="pp">IQSample::</span>new( <span class="dv">0.707</span><span class="op">,</span> <span class="op">-</span><span class="dv">0.707</span>)<span class="op">,</span>  <span class="co">// 315°</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>            <span class="op">};</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Repeat symbol for samples_per_symbol</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> _ <span class="kw">in</span> <span class="dv">0</span><span class="op">..</span><span class="kw">self</span><span class="op">.</span>samples_per_symbol <span class="op">{</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>                samples<span class="op">.</span>push(symbol)<span class="op">;</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>        samples</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> demodulate(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> samples<span class="op">:</span> <span class="op">&amp;</span>[IQSample]) <span class="op">-&gt;</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">bool</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> bits <span class="op">=</span> <span class="dt">Vec</span><span class="pp">::</span>new()<span class="op">;</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> chunk <span class="kw">in</span> samples<span class="op">.</span>chunks(<span class="kw">self</span><span class="op">.</span>samples_per_symbol) <span class="op">{</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> chunk<span class="op">.</span>is_empty() <span class="op">{</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Average samples in symbol period (coherent detection)</span></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> sum<span class="op">:</span> (<span class="dt">f32</span><span class="op">,</span> <span class="dt">f32</span>) <span class="op">=</span> chunk<span class="op">.</span>iter()</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>fold((<span class="dv">0.0</span><span class="op">,</span> <span class="dv">0.0</span>)<span class="op">,</span> <span class="op">|</span>acc<span class="op">,</span> s<span class="op">|</span> (acc<span class="op">.</span><span class="dv">0</span> <span class="op">+</span> s<span class="op">.</span>i<span class="op">,</span> acc<span class="op">.</span><span class="dv">1</span> <span class="op">+</span> s<span class="op">.</span>q))<span class="op">;</span></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> avg <span class="op">=</span> <span class="pp">IQSample::</span>new(</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>                sum<span class="op">.</span><span class="dv">0</span> <span class="op">/</span> chunk<span class="op">.</span>len() <span class="kw">as</span> <span class="dt">f32</span><span class="op">,</span></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>                sum<span class="op">.</span><span class="dv">1</span> <span class="op">/</span> chunk<span class="op">.</span>len() <span class="kw">as</span> <span class="dt">f32</span><span class="op">,</span></span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>            )<span class="op">;</span></span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Decision regions (Gray-coded)</span></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> i_positive <span class="op">=</span> avg<span class="op">.</span>i <span class="op">&gt;</span> <span class="dv">0.0</span><span class="op">;</span></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> q_positive <span class="op">=</span> avg<span class="op">.</span>q <span class="op">&gt;</span> <span class="dv">0.0</span><span class="op">;</span></span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>            bits<span class="op">.</span>push(i_positive)<span class="op">;</span></span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>            bits<span class="op">.</span>push(i_positive <span class="op">^</span> <span class="op">!</span>q_positive)<span class="op">;</span>  <span class="co">// Gray decode</span></span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>        bits</span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> constellation_points(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Vec</span><span class="op">&lt;</span>IQSample<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>        <span class="pp">vec!</span>[</span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>            <span class="pp">IQSample::</span>new(<span class="op">-</span><span class="dv">0.707</span><span class="op">,</span> <span class="op">-</span><span class="dv">0.707</span>)<span class="op">,</span>  <span class="co">// 00</span></span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>            <span class="pp">IQSample::</span>new(<span class="op">-</span><span class="dv">0.707</span><span class="op">,</span>  <span class="dv">0.707</span>)<span class="op">,</span>  <span class="co">// 01</span></span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>            <span class="pp">IQSample::</span>new( <span class="dv">0.707</span><span class="op">,</span>  <span class="dv">0.707</span>)<span class="op">,</span>  <span class="co">// 11</span></span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>            <span class="pp">IQSample::</span>new( <span class="dv">0.707</span><span class="op">,</span> <span class="op">-</span><span class="dv">0.707</span>)<span class="op">,</span>  <span class="co">// 10</span></span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> get_modulation_stages(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> bits<span class="op">:</span> <span class="op">&amp;</span>[<span class="dt">bool</span>]) <span class="op">-&gt;</span> <span class="dt">Vec</span><span class="op">&lt;</span>ModulationStage<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>        <span class="pp">vec!</span>[</span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>            ModulationStage <span class="op">{</span></span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>                name<span class="op">:</span> <span class="st">&quot;Input Bits&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>                description<span class="op">:</span> <span class="pp">format!</span>(<span class="st">&quot;{} bits input&quot;</span><span class="op">,</span> bits<span class="op">.</span>len())<span class="op">,</span></span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>                samples<span class="op">:</span> <span class="pp">vec!</span>[]<span class="op">,</span></span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a>            <span class="op">},</span></span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>            ModulationStage <span class="op">{</span></span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>                name<span class="op">:</span> <span class="st">&quot;Symbol Mapping&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>                description<span class="op">:</span> <span class="st">&quot;Map bit pairs to constellation points&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>                samples<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>modulate(bits)<span class="op">,</span></span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a>            <span class="op">},</span></span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> get_demodulation_steps(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> samples<span class="op">:</span> <span class="op">&amp;</span>[IQSample]) <span class="op">-&gt;</span> <span class="dt">Vec</span><span class="op">&lt;</span>DemodulationStep<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a>        <span class="pp">vec!</span>[</span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a>            DemodulationStep <span class="op">{</span></span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a>                name<span class="op">:</span> <span class="st">&quot;Symbol Detection&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a>                description<span class="op">:</span> <span class="st">&quot;Find nearest constellation point&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a>                data<span class="op">:</span> samples<span class="op">.</span>to_vec()<span class="op">,</span></span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a>                bits<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>demodulate(samples)<span class="op">,</span></span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a>            <span class="op">},</span></span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <h3 id="step-3-register-with-factory">Step 3: Register with
    Factory</h3>
    <div class="sourceCode" id="cb9"><pre
    class="sourceCode rust"><code class="sourceCode rust"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">// In crates/r4w-core/src/waveform/factory.rs</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> WaveformFactory <span class="op">{</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> create(name<span class="op">:</span> <span class="op">&amp;</span><span class="dt">str</span><span class="op">,</span> sample_rate<span class="op">:</span> <span class="dt">f64</span>) <span class="op">-&gt;</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">Box</span><span class="op">&lt;</span><span class="kw">dyn</span> Waveform<span class="op">&gt;&gt;</span> <span class="op">{</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">match</span> name<span class="op">.</span>to_uppercase()<span class="op">.</span>as_str() <span class="op">{</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;BPSK&quot;</span> <span class="op">=&gt;</span> <span class="cn">Some</span>(<span class="dt">Box</span><span class="pp">::</span>new(<span class="pp">BpskWaveform::</span>new(sample_rate)))<span class="op">,</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;QPSK&quot;</span> <span class="op">=&gt;</span> <span class="cn">Some</span>(<span class="dt">Box</span><span class="pp">::</span>new(<span class="pp">QpskWaveform::</span>new(sample_rate)))<span class="op">,</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;LORA&quot;</span> <span class="op">=&gt;</span> <span class="cn">Some</span>(<span class="dt">Box</span><span class="pp">::</span>new(<span class="pp">LoRaWaveform::</span>default_config(sample_rate)))<span class="op">,</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;MYWAVE&quot;</span> <span class="op">=&gt;</span> <span class="cn">Some</span>(<span class="dt">Box</span><span class="pp">::</span>new(<span class="pp">MyWaveform::</span>default_config(sample_rate)))<span class="op">,</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>            _ <span class="op">=&gt;</span> <span class="cn">None</span><span class="op">,</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> list() <span class="op">-&gt;</span> <span class="dt">Vec</span><span class="op">&lt;&amp;</span><span class="ot">&#39;static</span> <span class="dt">str</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>        <span class="pp">vec!</span>[<span class="st">&quot;BPSK&quot;</span><span class="op">,</span> <span class="st">&quot;QPSK&quot;</span><span class="op">,</span> <span class="st">&quot;LoRa&quot;</span><span class="op">,</span> <span class="st">&quot;MyWave&quot;</span>]</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <h3 id="step-4-add-tests">Step 4: Add Tests</h3>
    <div class="sourceCode" id="cb10"><pre
    class="sourceCode rust"><code class="sourceCode rust"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> tests <span class="op">{</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="kw">super</span><span class="pp">::</span><span class="op">*;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">r4w_sim::channel::</span>AwgnChannel<span class="op">;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>test<span class="at">]</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> test_roundtrip_clean() <span class="op">{</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> waveform <span class="op">=</span> <span class="pp">MyWaveform::</span>default_config(<span class="dv">48000.0</span>)<span class="op">;</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> original <span class="op">=</span> <span class="pp">vec!</span>[<span class="cn">true</span><span class="op">,</span> <span class="cn">false</span><span class="op">,</span> <span class="cn">true</span><span class="op">,</span> <span class="cn">true</span><span class="op">,</span> <span class="cn">false</span><span class="op">,</span> <span class="cn">false</span><span class="op">,</span> <span class="cn">true</span><span class="op">,</span> <span class="cn">false</span>]<span class="op">;</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> samples <span class="op">=</span> waveform<span class="op">.</span>modulate(<span class="op">&amp;</span>original)<span class="op">;</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> recovered <span class="op">=</span> waveform<span class="op">.</span>demodulate(<span class="op">&amp;</span>samples)<span class="op">;</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(original<span class="op">,</span> recovered)<span class="op">;</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>test<span class="at">]</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> test_roundtrip_noisy() <span class="op">{</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> waveform <span class="op">=</span> <span class="pp">MyWaveform::</span>default_config(<span class="dv">48000.0</span>)<span class="op">;</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> original<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">bool</span><span class="op">&gt;</span> <span class="op">=</span> (<span class="dv">0</span><span class="op">..</span><span class="dv">1000</span>)<span class="op">.</span>map(<span class="op">|</span>i<span class="op">|</span> i <span class="op">%</span> <span class="dv">3</span> <span class="op">==</span> <span class="dv">0</span>)<span class="op">.</span>collect()<span class="op">;</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> samples <span class="op">=</span> waveform<span class="op">.</span>modulate(<span class="op">&amp;</span>original)<span class="op">;</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> noisy <span class="op">=</span> <span class="pp">AwgnChannel::</span>new(<span class="dv">15.0</span>)<span class="op">.</span>apply(<span class="op">&amp;</span>samples)<span class="op">;</span>  <span class="co">// 15 dB SNR</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> recovered <span class="op">=</span> waveform<span class="op">.</span>demodulate(<span class="op">&amp;</span>noisy)<span class="op">;</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> errors <span class="op">=</span> original<span class="op">.</span>iter()<span class="op">.</span>zip(<span class="op">&amp;</span>recovered)</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>filter(<span class="op">|</span>(a<span class="op">,</span> b)<span class="op">|</span> a <span class="op">!=</span> b)</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>count()<span class="op">;</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> ber <span class="op">=</span> errors <span class="kw">as</span> <span class="dt">f64</span> <span class="op">/</span> original<span class="op">.</span>len() <span class="kw">as</span> <span class="dt">f64</span><span class="op">;</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert!</span>(ber <span class="op">&lt;</span> <span class="dv">0.01</span><span class="op">,</span> <span class="st">&quot;BER {:.4} exceeds 1%&quot;</span><span class="op">,</span> ber)<span class="op">;</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>test<span class="at">]</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> test_info() <span class="op">{</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> waveform <span class="op">=</span> <span class="pp">MyWaveform::</span>default_config(<span class="dv">48000.0</span>)<span class="op">;</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> info <span class="op">=</span> waveform<span class="op">.</span>info()<span class="op">;</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(info<span class="op">.</span>name<span class="op">,</span> <span class="st">&quot;MyWave&quot;</span>)<span class="op">;</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(info<span class="op">.</span>bits_per_symbol<span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>test<span class="at">]</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> test_constellation() <span class="op">{</span></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> waveform <span class="op">=</span> <span class="pp">MyWaveform::</span>default_config(<span class="dv">48000.0</span>)<span class="op">;</span></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> points <span class="op">=</span> waveform<span class="op">.</span>constellation_points()<span class="op">;</span></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(points<span class="op">.</span>len()<span class="op">,</span> <span class="dv">4</span>)<span class="op">;</span></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> point <span class="kw">in</span> <span class="op">&amp;</span>points <span class="op">{</span></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> magnitude <span class="op">=</span> point<span class="op">.</span>magnitude()<span class="op">;</span></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert!</span>((magnitude <span class="op">-</span> <span class="dv">1.0</span>)<span class="op">.</span>abs() <span class="op">&lt;</span> <span class="dv">0.01</span><span class="op">,</span> <span class="st">&quot;Point not unit magnitude&quot;</span>)<span class="op">;</span></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <hr />
    <h2 id="debugging-techniques">Debugging Techniques</h2>
    <h3 id="log-based-debugging">Log-Based Debugging</h3>
    <div class="sourceCode" id="cb11"><pre
    class="sourceCode rust"><code class="sourceCode rust"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">tracing::</span><span class="op">{</span>debug<span class="op">,</span> info<span class="op">,</span> warn<span class="op">,</span> error<span class="op">,</span> instrument<span class="op">};</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> MyWaveform <span class="op">{</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>instrument<span class="at">(</span>skip<span class="at">(</span><span class="kw">self</span><span class="op">,</span> samples<span class="at">)</span><span class="op">,</span> fields<span class="at">(</span>n_samples <span class="op">=</span> samples<span class="op">.</span>len<span class="at">()))]</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> demodulate_debug(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> samples<span class="op">:</span> <span class="op">&amp;</span>[IQSample]) <span class="op">-&gt;</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">bool</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> bits <span class="op">=</span> <span class="dt">Vec</span><span class="pp">::</span>new()<span class="op">;</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (i<span class="op">,</span> chunk) <span class="kw">in</span> samples<span class="op">.</span>chunks(<span class="kw">self</span><span class="op">.</span>samples_per_symbol)<span class="op">.</span>enumerate() <span class="op">{</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> sum<span class="op">:</span> (<span class="dt">f32</span><span class="op">,</span> <span class="dt">f32</span>) <span class="op">=</span> chunk<span class="op">.</span>iter()</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>fold((<span class="dv">0.0</span><span class="op">,</span> <span class="dv">0.0</span>)<span class="op">,</span> <span class="op">|</span>acc<span class="op">,</span> s<span class="op">|</span> (acc<span class="op">.</span><span class="dv">0</span> <span class="op">+</span> s<span class="op">.</span>i<span class="op">,</span> acc<span class="op">.</span><span class="dv">1</span> <span class="op">+</span> s<span class="op">.</span>q))<span class="op">;</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> avg <span class="op">=</span> <span class="pp">IQSample::</span>new(</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>                sum<span class="op">.</span><span class="dv">0</span> <span class="op">/</span> chunk<span class="op">.</span>len() <span class="kw">as</span> <span class="dt">f32</span><span class="op">,</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>                sum<span class="op">.</span><span class="dv">1</span> <span class="op">/</span> chunk<span class="op">.</span>len() <span class="kw">as</span> <span class="dt">f32</span><span class="op">,</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>            )<span class="op">;</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>            <span class="pp">debug!</span>(</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>                symbol <span class="op">=</span> i<span class="op">,</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>                avg_i <span class="op">=</span> <span class="op">%</span>avg<span class="op">.</span>i<span class="op">,</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>                avg_q <span class="op">=</span> <span class="op">%</span>avg<span class="op">.</span>q<span class="op">,</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>                magnitude <span class="op">=</span> <span class="op">%</span>avg<span class="op">.</span>magnitude()<span class="op">,</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>                phase_deg <span class="op">=</span> <span class="op">%</span>(avg<span class="op">.</span>phase() <span class="op">*</span> <span class="dv">180.0</span> <span class="op">/</span> <span class="pp">std::</span><span class="dt">f32</span><span class="pp">::consts::</span>PI)<span class="op">,</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;Processing symbol&quot;</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>            )<span class="op">;</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> (b0<span class="op">,</span> b1) <span class="op">=</span> (avg<span class="op">.</span>i <span class="op">&gt;</span> <span class="dv">0.0</span><span class="op">,</span> avg<span class="op">.</span>q <span class="op">&gt;</span> <span class="dv">0.0</span>)<span class="op">;</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>            bits<span class="op">.</span>push(b0)<span class="op">;</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>            bits<span class="op">.</span>push(b1)<span class="op">;</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>        <span class="pp">info!</span>(n_bits <span class="op">=</span> bits<span class="op">.</span>len()<span class="op">,</span> <span class="st">&quot;Demodulation complete&quot;</span>)<span class="op">;</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>        bits</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a><span class="co">// Initialize tracing in your application</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> init_tracing() <span class="op">{</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    <span class="pp">tracing_subscriber::</span>fmt()</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>with_env_filter(<span class="st">&quot;r4w_core=debug&quot;</span>)</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>with_target(<span class="cn">false</span>)</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>init()<span class="op">;</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <h3 id="visual-debugging-with-gui">Visual Debugging with GUI</h3>
    <p>The R4W GUI provides visual debugging tools:</p>
    <div class="sourceCode" id="cb12"><pre
    class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run GUI explorer</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> run <span class="at">--bin</span> r4w-explorer</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Navigate to:</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co"># - Constellation view: See symbol decision regions</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co"># - Spectrum view: Frequency domain analysis</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># - Waterfall view: Time-frequency visualization</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co"># - Pipeline view: Step-by-step modulation/demodulation</span></span></code></pre></div>
    <h3 id="dumping-samples-to-file">Dumping Samples to File</h3>
    <div class="sourceCode" id="cb13"><pre
    class="sourceCode rust"><code class="sourceCode rust"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">std::fs::</span>File<span class="op">;</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">std::io::</span><span class="bu">Write</span><span class="op">;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> dump_samples_to_csv(samples<span class="op">:</span> <span class="op">&amp;</span>[IQSample]<span class="op">,</span> path<span class="op">:</span> <span class="op">&amp;</span><span class="dt">str</span>) <span class="op">-&gt;</span> <span class="pp">std::io::</span><span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> file <span class="op">=</span> <span class="pp">File::</span>create(path)<span class="op">?;</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="pp">writeln!</span>(file<span class="op">,</span> <span class="st">&quot;index,i,q,magnitude,phase_deg&quot;</span>)<span class="op">?;</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (idx<span class="op">,</span> sample) <span class="kw">in</span> samples<span class="op">.</span>iter()<span class="op">.</span>enumerate() <span class="op">{</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>        <span class="pp">writeln!</span>(</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>            file<span class="op">,</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;{},{:.6},{:.6},{:.6},{:.2}&quot;</span><span class="op">,</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>            idx<span class="op">,</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>            sample<span class="op">.</span>i<span class="op">,</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>            sample<span class="op">.</span>q<span class="op">,</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>            sample<span class="op">.</span>magnitude()<span class="op">,</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>            sample<span class="op">.</span>phase() <span class="op">*</span> <span class="dv">180.0</span> <span class="op">/</span> <span class="pp">std::</span><span class="dt">f32</span><span class="pp">::consts::</span>PI</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>        )<span class="op">?;</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Ok</span>(())</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a><span class="co">// Use in tests</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>test<span class="at">]</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> debug_modulation() <span class="op">{</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> waveform <span class="op">=</span> <span class="pp">MyWaveform::</span>default_config(<span class="dv">48000.0</span>)<span class="op">;</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> bits <span class="op">=</span> <span class="pp">vec!</span>[<span class="cn">true</span><span class="op">,</span> <span class="cn">false</span><span class="op">,</span> <span class="cn">true</span><span class="op">,</span> <span class="cn">true</span>]<span class="op">;</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> samples <span class="op">=</span> waveform<span class="op">.</span>modulate(<span class="op">&amp;</span>bits)<span class="op">;</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>    dump_samples_to_csv(<span class="op">&amp;</span>samples<span class="op">,</span> <span class="st">&quot;/tmp/modulated.csv&quot;</span>)<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Open in Python/MATLAB/Excel for analysis</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <h3 id="interactive-debugging-with-lldb">Interactive Debugging with
    LLDB</h3>
    <div class="sourceCode" id="cb14"><pre
    class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Build with debug info</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> build</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Debug with CodeLLDB (VS Code) or command line</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="ex">lldb</span> target/debug/r4w</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="ex">lldb</span><span class="kw">)</span> <span class="ex">breakpoint</span> set <span class="at">--name</span> <span class="st">&quot;my_waveform::MyWaveform::demodulate&quot;</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="ex">lldb</span><span class="kw">)</span> <span class="ex">run</span> simulate <span class="at">--waveform</span> MyWave <span class="at">--message</span> <span class="st">&quot;test&quot;</span></span></code></pre></div>
    <h3 id="signal-analysis-with-python">Signal Analysis with
    Python</h3>
    <div class="sourceCode" id="cb15"><pre
    class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env python3</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co"># analyze_samples.py</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> signal</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Load samples exported from R4W</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> np.loadtxt(<span class="st">&#39;/tmp/modulated.csv&#39;</span>, delimiter<span class="op">=</span><span class="st">&#39;,&#39;</span>, skiprows<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>i_samples <span class="op">=</span> data[:, <span class="dv">1</span>]</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>q_samples <span class="op">=</span> data[:, <span class="dv">2</span>]</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>complex_samples <span class="op">=</span> i_samples <span class="op">+</span> <span class="ot">1j</span> <span class="op">*</span> q_samples</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Constellation diagram</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">4</span>))</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">1</span>)</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>plt.scatter(i_samples, q_samples, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&#39;I&#39;</span>)</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&#39;Q&#39;</span>)</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&#39;Constellation&#39;</span>)</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">&#39;equal&#39;</span>)</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Power spectrum</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">2</span>)</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>f, psd <span class="op">=</span> signal.welch(complex_samples, fs<span class="op">=</span><span class="dv">48000</span>, nperseg<span class="op">=</span><span class="dv">256</span>)</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>plt.semilogy(f, psd)</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&#39;Frequency (Hz)&#39;</span>)</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&#39;PSD&#39;</span>)</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&#39;Power Spectrum&#39;</span>)</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Eye diagram (for PSK)</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>samples_per_symbol <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">3</span>)</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> start <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(i_samples) <span class="op">-</span> <span class="dv">2</span><span class="op">*</span>samples_per_symbol, samples_per_symbol):</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>    segment <span class="op">=</span> i_samples[start:start <span class="op">+</span> <span class="dv">2</span><span class="op">*</span>samples_per_symbol]</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>    plt.plot(segment, <span class="st">&#39;b-&#39;</span>, alpha<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&#39;Sample&#39;</span>)</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&#39;I&#39;</span>)</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&#39;Eye Diagram&#39;</span>)</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="st">&#39;/tmp/signal_analysis.png&#39;</span>)</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
    <hr />
    <h2 id="benchmarking-and-profiling">Benchmarking and Profiling</h2>
    <h3 id="criterion-benchmarks">Criterion Benchmarks</h3>
    <p>Create benchmarks in <code>crates/r4w-core/benches/</code>:</p>
    <div class="sourceCode" id="cb16"><pre
    class="sourceCode rust"><code class="sourceCode rust"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">// benches/waveform_bench.rs</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">criterion::</span><span class="op">{</span>black_box<span class="op">,</span> criterion_group<span class="op">,</span> criterion_main<span class="op">,</span> Criterion<span class="op">,</span> BenchmarkId<span class="op">};</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">r4w_core::waveform::</span><span class="op">{</span>Waveform<span class="op">,</span> WaveformFactory<span class="op">};</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> bench_modulation(c<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> Criterion) <span class="op">{</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> group <span class="op">=</span> c<span class="op">.</span>benchmark_group(<span class="st">&quot;modulation&quot;</span>)<span class="op">;</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">&amp;</span>bit_count <span class="kw">in</span> <span class="op">&amp;</span>[<span class="dv">100</span><span class="op">,</span> <span class="dv">1000</span><span class="op">,</span> <span class="dv">10000</span>] <span class="op">{</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> bits<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">bool</span><span class="op">&gt;</span> <span class="op">=</span> (<span class="dv">0</span><span class="op">..</span>bit_count)<span class="op">.</span>map(<span class="op">|</span>i<span class="op">|</span> i <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">0</span>)<span class="op">.</span>collect()<span class="op">;</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> waveform_name <span class="kw">in</span> [<span class="st">&quot;BPSK&quot;</span><span class="op">,</span> <span class="st">&quot;QPSK&quot;</span><span class="op">,</span> <span class="st">&quot;LoRa&quot;</span>] <span class="op">{</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> waveform <span class="op">=</span> <span class="pp">WaveformFactory::</span>create(waveform_name<span class="op">,</span> <span class="dv">48000.0</span>)<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>            group<span class="op">.</span>bench_with_input(</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>                <span class="pp">BenchmarkId::</span>new(waveform_name<span class="op">,</span> bit_count)<span class="op">,</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>                <span class="op">&amp;</span>bits<span class="op">,</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>                <span class="op">|</span>b<span class="op">,</span> bits<span class="op">|</span> <span class="op">{</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>                    b<span class="op">.</span>iter(<span class="op">||</span> waveform<span class="op">.</span>modulate(black_box(bits)))</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>                <span class="op">},</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>            )<span class="op">;</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>    group<span class="op">.</span>finish()<span class="op">;</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> bench_demodulation(c<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> Criterion) <span class="op">{</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> group <span class="op">=</span> c<span class="op">.</span>benchmark_group(<span class="st">&quot;demodulation&quot;</span>)<span class="op">;</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">&amp;</span>sample_count <span class="kw">in</span> <span class="op">&amp;</span>[<span class="dv">1000</span><span class="op">,</span> <span class="dv">10000</span><span class="op">,</span> <span class="dv">100000</span>] <span class="op">{</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> waveform_name <span class="kw">in</span> [<span class="st">&quot;BPSK&quot;</span><span class="op">,</span> <span class="st">&quot;QPSK&quot;</span><span class="op">,</span> <span class="st">&quot;LoRa&quot;</span>] <span class="op">{</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> waveform <span class="op">=</span> <span class="pp">WaveformFactory::</span>create(waveform_name<span class="op">,</span> <span class="dv">48000.0</span>)<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Generate samples</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> bit_count <span class="op">=</span> sample_count <span class="op">/</span> <span class="dv">10</span><span class="op">;</span>  <span class="co">// Approximate</span></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> bits<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">bool</span><span class="op">&gt;</span> <span class="op">=</span> (<span class="dv">0</span><span class="op">..</span>bit_count)<span class="op">.</span>map(<span class="op">|</span>i<span class="op">|</span> i <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">0</span>)<span class="op">.</span>collect()<span class="op">;</span></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> samples <span class="op">=</span> waveform<span class="op">.</span>modulate(<span class="op">&amp;</span>bits)<span class="op">;</span></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>            group<span class="op">.</span>bench_with_input(</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>                <span class="pp">BenchmarkId::</span>new(waveform_name<span class="op">,</span> samples<span class="op">.</span>len())<span class="op">,</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>                <span class="op">&amp;</span>samples<span class="op">,</span></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>                <span class="op">|</span>b<span class="op">,</span> samples<span class="op">|</span> <span class="op">{</span></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>                    b<span class="op">.</span>iter(<span class="op">||</span> waveform<span class="op">.</span>demodulate(black_box(samples)))</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>                <span class="op">},</span></span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>            )<span class="op">;</span></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>    group<span class="op">.</span>finish()<span class="op">;</span></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> bench_fft(c<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> Criterion) <span class="op">{</span></span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">r4w_core::dsp::fft::</span>Fft<span class="op">;</span></span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> group <span class="op">=</span> c<span class="op">.</span>benchmark_group(<span class="st">&quot;fft&quot;</span>)<span class="op">;</span></span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">&amp;</span>size <span class="kw">in</span> <span class="op">&amp;</span>[<span class="dv">256</span><span class="op">,</span> <span class="dv">1024</span><span class="op">,</span> <span class="dv">4096</span>] <span class="op">{</span></span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> samples<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>_<span class="op">&gt;</span> <span class="op">=</span> (<span class="dv">0</span><span class="op">..</span>size)</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>map(<span class="op">|</span>i<span class="op">|</span> <span class="pp">IQSample::</span>new((i <span class="kw">as</span> <span class="dt">f32</span>)<span class="op">.</span>cos()<span class="op">,</span> (i <span class="kw">as</span> <span class="dt">f32</span>)<span class="op">.</span>sin()))</span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>collect()<span class="op">;</span></span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> fft <span class="op">=</span> <span class="pp">Fft::</span>new(size)<span class="op">;</span></span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>        group<span class="op">.</span>bench_with_input(</span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>            <span class="pp">BenchmarkId::</span>from_parameter(size)<span class="op">,</span></span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span>samples<span class="op">,</span></span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>            <span class="op">|</span>b<span class="op">,</span> samples<span class="op">|</span> <span class="op">{</span></span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a>                b<span class="op">.</span>iter(<span class="op">||</span> fft<span class="op">.</span>forward(black_box(samples)))</span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a>            <span class="op">},</span></span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a>        )<span class="op">;</span></span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a>    group<span class="op">.</span>finish()<span class="op">;</span></span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a><span class="pp">criterion_group!</span>(benches<span class="op">,</span> bench_modulation<span class="op">,</span> bench_demodulation<span class="op">,</span> bench_fft)<span class="op">;</span></span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a><span class="pp">criterion_main!</span>(benches)<span class="op">;</span></span></code></pre></div>
    <h3 id="running-benchmarks">Running Benchmarks</h3>
    <div class="sourceCode" id="cb17"><pre
    class="sourceCode bash"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run all benchmarks</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> bench</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Run specific benchmark</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> bench <span class="at">--</span> modulation</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate HTML report</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> bench <span class="at">--</span> <span class="at">--save-baseline</span> main</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare to baseline</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> bench <span class="at">--</span> <span class="at">--baseline</span> main</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Output to JSON for CI</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> bench <span class="at">--</span> <span class="at">--format</span> json <span class="op">&gt;</span> bench_results.json</span></code></pre></div>
    <h3 id="flamegraph-profiling">Flamegraph Profiling</h3>
    <div class="sourceCode" id="cb18"><pre
    class="sourceCode bash"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install perf and flamegraph</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt install linux-tools-common linux-tools-generic</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> install flamegraph</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Profile release build</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> flamegraph <span class="at">--bin</span> r4w <span class="at">--</span> simulate <span class="at">--waveform</span> LoRa <span class="at">--message</span> <span class="st">&quot;test&quot;</span> <span class="at">--duration</span> 10</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Output: flamegraph.svg</span></span></code></pre></div>
    <h3 id="memory-profiling">Memory Profiling</h3>
    <div class="sourceCode" id="cb19"><pre
    class="sourceCode bash"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Using valgrind/massif</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> build <span class="at">--release</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="fu">valgrind</span> <span class="at">--tool</span><span class="op">=</span>massif target/release/r4w simulate <span class="at">--waveform</span> LoRa</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Using heaptrack (better for Rust)</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="ex">heaptrack</span> target/release/r4w simulate <span class="at">--waveform</span> LoRa</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="ex">heaptrack_gui</span> heaptrack.r4w.<span class="pp">*</span>.zst</span></code></pre></div>
    <h3 id="performance-metrics">Performance Metrics</h3>
    <p>Track these metrics for your waveforms:</p>
    <table>
    <thead>
    <tr class="header">
    <th>Metric</th>
    <th>Target</th>
    <th>How to Measure</th>
    </tr>
    </thead>
    <tbody>
    <tr class="odd">
    <td>Modulation throughput</td>
    <td>&gt;1 Msps</td>
    <td><code>criterion</code> benchmark</td>
    </tr>
    <tr class="even">
    <td>Demodulation throughput</td>
    <td>&gt;500 ksps</td>
    <td><code>criterion</code> benchmark</td>
    </tr>
    <tr class="odd">
    <td>Latency (single symbol)</td>
    <td>&lt;100 μs</td>
    <td><code>std::time::Instant</code></td>
    </tr>
    <tr class="even">
    <td>Memory per 1k samples</td>
    <td>&lt;100 KB</td>
    <td><code>heaptrack</code></td>
    </tr>
    <tr class="odd">
    <td>CPU usage (real-time)</td>
    <td>&lt;50%</td>
    <td><code>top</code> / <code>htop</code></td>
    </tr>
    </tbody>
    </table>
    <hr />
    <h2 id="cross-compilation">Cross-Compilation</h2>
    <h3 id="target-configuration">Target Configuration</h3>
    <div class="sourceCode" id="cb20"><pre
    class="sourceCode toml"><code class="sourceCode toml"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># .cargo/config.toml</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="kw">[target.aarch64-unknown-linux-gnu]</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="dt">linker</span> <span class="op">=</span> <span class="st">&quot;aarch64-linux-gnu-gcc&quot;</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="kw">[target.armv7-unknown-linux-gnueabihf]</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="dt">linker</span> <span class="op">=</span> <span class="st">&quot;arm-linux-gnueabihf-gcc&quot;</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="kw">[target.x86_64-unknown-linux-musl]</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="dt">linker</span> <span class="op">=</span> <span class="st">&quot;musl-gcc&quot;</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="kw">[target.powerpc-unknown-linux-gnu]</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="dt">linker</span> <span class="op">=</span> <span class="st">&quot;powerpc-linux-gnu-gcc&quot;</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="co"># For Zynq (bare metal)</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="kw">[target.armv7-unknown-none-eabihf]</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="dt">linker</span> <span class="op">=</span> <span class="st">&quot;arm-none-eabi-gcc&quot;</span></span></code></pre></div>
    <h3 id="building-for-arm64-raspberry-pi-45">Building for ARM64
    (Raspberry Pi 4/5)</h3>
    <div class="sourceCode" id="cb21"><pre
    class="sourceCode bash"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install toolchain</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt install gcc-aarch64-linux-gnu</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="ex">rustup</span> target add aarch64-unknown-linux-gnu</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Build</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> build <span class="at">--release</span> <span class="at">--target</span> aarch64-unknown-linux-gnu <span class="at">--bin</span> r4w</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="fu">file</span> target/aarch64-unknown-linux-gnu/release/r4w</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Output: ELF 64-bit LSB executable, ARM aarch64</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Deploy</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="fu">scp</span> target/aarch64-unknown-linux-gnu/release/r4w pi@raspberrypi:/home/pi/</span></code></pre></div>
    <h3 id="building-for-arm32-raspberry-pi-3-beaglebone">Building for
    ARM32 (Raspberry Pi 3, BeagleBone)</h3>
    <div class="sourceCode" id="cb22"><pre
    class="sourceCode bash"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install toolchain</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt install gcc-arm-linux-gnueabihf</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="ex">rustup</span> target add armv7-unknown-linux-gnueabihf</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Build</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> build <span class="at">--release</span> <span class="at">--target</span> armv7-unknown-linux-gnueabihf <span class="at">--bin</span> r4w</span></code></pre></div>
    <h3 id="static-linking-portable-binary">Static Linking (Portable
    Binary)</h3>
    <div class="sourceCode" id="cb23"><pre
    class="sourceCode bash"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For maximum portability</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="ex">rustup</span> target add x86_64-unknown-linux-musl</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> build <span class="at">--release</span> <span class="at">--target</span> x86_64-unknown-linux-musl</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Result: static binary, no glibc dependency</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ldd</span> target/x86_64-unknown-linux-musl/release/r4w</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Output: not a dynamic executable</span></span></code></pre></div>
    <h3 id="cross-compilation-makefile">Cross-Compilation Makefile</h3>
    <div class="sourceCode" id="cb24"><pre
    class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Makefile</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="dt">TARGETS</span> <span class="ch">:=</span><span class="st"> x86_64-unknown-linux-gnu </span><span class="ch">\</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="st">           aarch64-unknown-linux-gnu </span><span class="ch">\</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="st">           armv7-unknown-linux-gnueabihf</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="ot">.PHONY:</span><span class="dt"> all clean </span><span class="ch">$(</span><span class="dt">TARGETS</span><span class="ch">)</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="dv">all:</span><span class="dt"> </span><span class="ch">$(</span><span class="dt">TARGETS</span><span class="ch">)</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="dv">x86_64-unknown-linux-gnu:</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="er">    </span>cargo build --release --target <span class="ch">$@</span> --bin r4w</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="dv">aarch64-unknown-linux-gnu:</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="er">    </span>cargo build --release --target <span class="ch">$@</span> --bin r4w</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a><span class="dv">armv7-unknown-linux-gnueabihf:</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a><span class="er">    </span>cargo build --release --target <span class="ch">$@</span> --bin r4w</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a><span class="dv">deploy-arm64:</span><span class="dt"> aarch64-unknown-linux-gnu</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a><span class="er">    </span>scp target/aarch64-unknown-linux-gnu/release/r4w <span class="ch">$(</span><span class="dt">REMOTE_HOST</span><span class="ch">)</span>:/opt/r4w/</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="dv">clean:</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a><span class="er">    </span>cargo clean</span></code></pre></div>
    <h3 id="conditional-compilation">Conditional Compilation</h3>
    <div class="sourceCode" id="cb25"><pre
    class="sourceCode rust"><code class="sourceCode rust"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Platform-specific code</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>target_arch <span class="op">=</span> <span class="st">&quot;aarch64&quot;</span><span class="at">)]</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> use_neon_simd(samples<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> [IQSample]) <span class="op">{</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ARM NEON optimizations</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>target_arch <span class="op">=</span> <span class="st">&quot;x86_64&quot;</span><span class="at">)]</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> use_avx_simd(samples<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> [IQSample]) <span class="op">{</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// x86 AVX2 optimizations</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>not<span class="at">(</span>any<span class="at">(</span>target_arch <span class="op">=</span> <span class="st">&quot;aarch64&quot;</span><span class="op">,</span> target_arch <span class="op">=</span> <span class="st">&quot;x86_64&quot;</span><span class="at">)))]</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> use_scalar(samples<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> [IQSample]) <span class="op">{</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Fallback scalar implementation</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a><span class="co">// Feature-based compilation</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;fpga&quot;</span><span class="at">)]</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> fpga_accel<span class="op">;</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>not<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;fpga&quot;</span><span class="at">))]</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> software_impl<span class="op">;</span></span></code></pre></div>
    <hr />
    <h2 id="deployment">Deployment</h2>
    <h3 id="deployment-checklist">Deployment Checklist</h3>
    <ul class="task-list">
    <li><label><input type="checkbox" />Binary compiled for target
    architecture</label></li>
    <li><label><input type="checkbox" />Dependencies met (glibc version,
    etc.)</label></li>
    <li><label><input type="checkbox" />Configuration files in
    place</label></li>
    <li><label><input type="checkbox" />Permissions set (GPIO, /dev/mem
    access)</label></li>
    <li><label><input type="checkbox" />Systemd service created (if
    daemon)</label></li>
    <li><label><input type="checkbox" />Logging configured</label></li>
    <li><label><input type="checkbox" />Resource limits set (memory,
    CPU)</label></li>
    </ul>
    <h3 id="systemd-service">Systemd Service</h3>
    <div class="sourceCode" id="cb26"><pre
    class="sourceCode ini"><code class="sourceCode ini"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /etc/systemd/system/r4w-agent.service</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="kw">[Unit]</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="dt">Description</span><span class="ot">=</span><span class="st">R4W Waveform Agent</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="dt">After</span><span class="ot">=</span><span class="st">network.target</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="kw">[Service]</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="dt">Type</span><span class="ot">=</span><span class="st">simple</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="dt">User</span><span class="ot">=</span><span class="st">r4w</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="dt">Group</span><span class="ot">=</span><span class="st">r4w</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="dt">WorkingDirectory</span><span class="ot">=</span><span class="st">/opt/r4w</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="dt">ExecStart</span><span class="ot">=</span><span class="st">/opt/r4w/r4w agent --port 6000</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="dt">Restart</span><span class="ot">=</span><span class="st">always</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="dt">RestartSec</span><span class="ot">=</span><span class="dv">5</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Resource limits</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a><span class="dt">MemoryMax</span><span class="ot">=</span><span class="st">512M</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a><span class="dt">CPUQuota</span><span class="ot">=</span><span class="st">80%</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Security</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a><span class="dt">NoNewPrivileges</span><span class="ot">=</span><span class="kw">true</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a><span class="dt">ProtectSystem</span><span class="ot">=</span><span class="st">strict</span></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a><span class="dt">ProtectHome</span><span class="ot">=</span><span class="kw">true</span></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a><span class="dt">ReadWritePaths</span><span class="ot">=</span><span class="st">/var/lib/r4w</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Real-time priority (if needed)</span></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a><span class="co"># CPUSchedulingPolicy=fifo</span></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a><span class="co"># CPUSchedulingPriority=50</span></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a><span class="kw">[Install]</span></span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a><span class="dt">WantedBy</span><span class="ot">=</span><span class="st">multi-user.target</span></span></code></pre></div>
    <h3 id="docker-deployment">Docker Deployment</h3>
    <div class="sourceCode" id="cb27"><pre
    class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Dockerfile</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> rust:1.75 as builder</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="kw">WORKDIR</span> /app</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> . .</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">cargo</span> build <span class="at">--release</span> <span class="at">--bin</span> r4w</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> debian:bookworm-slim</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">apt-get</span> update <span class="kw">&amp;&amp;</span> <span class="ex">apt-get</span> install <span class="at">-y</span> libssl3 <span class="kw">&amp;&amp;</span> <span class="fu">rm</span> <span class="at">-rf</span> /var/lib/apt/lists/<span class="pp">*</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> <span class="op">--from=builder</span> /app/target/release/r4w /usr/local/bin/</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="kw">EXPOSE</span> 5000/udp 6000/tcp</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">&quot;r4w&quot;</span>, <span class="st">&quot;agent&quot;</span>, <span class="st">&quot;--port&quot;</span>, <span class="st">&quot;6000&quot;</span>]</span></code></pre></div>
    <div class="sourceCode" id="cb28"><pre
    class="sourceCode bash"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Build and run</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> build <span class="at">-t</span> r4w:latest .</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">-p</span> 5000:5000/udp <span class="at">-p</span> 6000:6000/tcp r4w:latest</span></code></pre></div>
    <h3 id="configuration-management">Configuration Management</h3>
    <div class="sourceCode" id="cb29"><pre
    class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /etc/r4w/config.yaml</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">server</span><span class="kw">:</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">host</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;0.0.0.0&quot;</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">6000</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="fu">waveform</span><span class="kw">:</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">default</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;LoRa&quot;</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">sample_rate</span><span class="kw">:</span><span class="at"> </span><span class="dv">500000</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="fu">fpga</span><span class="kw">:</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">enabled</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">platform</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;zynq&quot;</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">bitstream</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;/opt/r4w/bitstream/r4w_design.bit&quot;</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="fu">logging</span><span class="kw">:</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">level</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;info&quot;</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">file</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;/var/log/r4w/r4w.log&quot;</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">max_size_mb</span><span class="kw">:</span><span class="at"> </span><span class="dv">100</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">max_files</span><span class="kw">:</span><span class="at"> </span><span class="dv">5</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">max_memory_mb</span><span class="kw">:</span><span class="at"> </span><span class="dv">512</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">max_dma_buffers</span><span class="kw">:</span><span class="at"> </span><span class="dv">8</span></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">worker_threads</span><span class="kw">:</span><span class="at"> </span><span class="dv">4</span></span></code></pre></div>
    <hr />
    <h2 id="system-integration">System Integration</h2>
    <h3 id="hardware-interface-abstraction">Hardware Interface
    Abstraction</h3>
    <div class="sourceCode" id="cb30"><pre
    class="sourceCode rust"><code class="sourceCode rust"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// Trait for SDR hardware backends</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">trait</span> SdrDevice<span class="op">:</span> <span class="bu">Send</span> <span class="op">+</span> <span class="bu">Sync</span> <span class="op">{</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Get device info</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> info(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> DeviceInfo<span class="op">;</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Set center frequency</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> set_frequency(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> freq_hz<span class="op">:</span> <span class="dt">u64</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> DeviceError<span class="op">&gt;;</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Set sample rate</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> set_sample_rate(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> rate_hz<span class="op">:</span> <span class="dt">u64</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> DeviceError<span class="op">&gt;;</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Set gain</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> set_gain(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> gain_db<span class="op">:</span> <span class="dt">f32</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> DeviceError<span class="op">&gt;;</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Start streaming</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> start_rx(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> DeviceError<span class="op">&gt;;</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> start_tx(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> DeviceError<span class="op">&gt;;</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Stop streaming</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> stop(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> DeviceError<span class="op">&gt;;</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Read samples (blocking)</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> read(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> buffer<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> [IQSample]) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">usize</span><span class="op">,</span> DeviceError<span class="op">&gt;;</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Write samples (blocking)</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> write(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> samples<span class="op">:</span> <span class="op">&amp;</span>[IQSample]) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">usize</span><span class="op">,</span> DeviceError<span class="op">&gt;;</span></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <h3 id="udp-iq-transport">UDP I/Q Transport</h3>
    <p>For integration with GNU Radio or other systems:</p>
    <div class="sourceCode" id="cb31"><pre
    class="sourceCode rust"><code class="sourceCode rust"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">std::net::</span>UdpSocket<span class="op">;</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> UdpIqTransport <span class="op">{</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    socket<span class="op">:</span> UdpSocket<span class="op">,</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    remote_addr<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="pp">std::net::</span>SocketAddr<span class="op">&gt;,</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> UdpIqTransport <span class="op">{</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> bind(port<span class="op">:</span> <span class="dt">u16</span>) <span class="op">-&gt;</span> <span class="pp">std::io::</span><span class="dt">Result</span><span class="op">&lt;</span><span class="dt">Self</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> socket <span class="op">=</span> <span class="pp">UdpSocket::</span>bind(<span class="pp">format!</span>(<span class="st">&quot;0.0.0.0:{}&quot;</span><span class="op">,</span> port))<span class="op">?;</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>        socket<span class="op">.</span>set_nonblocking(<span class="cn">true</span>)<span class="op">?;</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(<span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>            socket<span class="op">,</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>            remote_addr<span class="op">:</span> <span class="cn">None</span><span class="op">,</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span>)</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> connect(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> addr<span class="op">:</span> <span class="op">&amp;</span><span class="dt">str</span>) <span class="op">-&gt;</span> <span class="pp">std::io::</span><span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>remote_addr <span class="op">=</span> <span class="cn">Some</span>(addr<span class="op">.</span>parse()<span class="op">.</span>map_err(<span class="op">|</span>e<span class="op">|</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>            <span class="pp">std::io::</span><span class="bu">Error</span><span class="pp">::</span>new(<span class="pp">std::io::ErrorKind::</span>InvalidInput<span class="op">,</span> e)</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>        )<span class="op">?</span>)<span class="op">;</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(())</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> send_samples(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> samples<span class="op">:</span> <span class="op">&amp;</span>[IQSample]) <span class="op">-&gt;</span> <span class="pp">std::io::</span><span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> addr <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>remote_addr<span class="op">.</span>ok_or_else(<span class="op">||</span></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>            <span class="pp">std::io::</span><span class="bu">Error</span><span class="pp">::</span>new(<span class="pp">std::io::ErrorKind::</span>NotConnected<span class="op">,</span> <span class="st">&quot;No remote address&quot;</span>)</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>        )<span class="op">?;</span></span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Convert to bytes (I16 interleaved format, GNU Radio compatible)</span></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> buffer <span class="op">=</span> <span class="dt">Vec</span><span class="pp">::</span>with_capacity(samples<span class="op">.</span>len() <span class="op">*</span> <span class="dv">4</span>)<span class="op">;</span></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> sample <span class="kw">in</span> samples <span class="op">{</span></span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> i <span class="op">=</span> (sample<span class="op">.</span>i <span class="op">*</span> <span class="dv">32767.0</span>) <span class="kw">as</span> <span class="dt">i16</span><span class="op">;</span></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> q <span class="op">=</span> (sample<span class="op">.</span>q <span class="op">*</span> <span class="dv">32767.0</span>) <span class="kw">as</span> <span class="dt">i16</span><span class="op">;</span></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>            buffer<span class="op">.</span>extend_from_slice(<span class="op">&amp;</span>i<span class="op">.</span>to_le_bytes())<span class="op">;</span></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>            buffer<span class="op">.</span>extend_from_slice(<span class="op">&amp;</span>q<span class="op">.</span>to_le_bytes())<span class="op">;</span></span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>socket<span class="op">.</span>send_to(<span class="op">&amp;</span>buffer<span class="op">,</span> addr)<span class="op">?;</span></span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(())</span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> recv_samples(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> buffer<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> [IQSample]) <span class="op">-&gt;</span> <span class="pp">std::io::</span><span class="dt">Result</span><span class="op">&lt;</span><span class="dt">usize</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> raw_buffer <span class="op">=</span> <span class="pp">vec!</span>[<span class="dv">0u8</span><span class="op">;</span> buffer<span class="op">.</span>len() <span class="op">*</span> <span class="dv">4</span>]<span class="op">;</span></span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">match</span> <span class="kw">self</span><span class="op">.</span>socket<span class="op">.</span>recv_from(<span class="op">&amp;</span><span class="kw">mut</span> raw_buffer) <span class="op">{</span></span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>((n_bytes<span class="op">,</span> _addr)) <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> n_samples <span class="op">=</span> n_bytes <span class="op">/</span> <span class="dv">4</span><span class="op">;</span></span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> i <span class="kw">in</span> <span class="dv">0</span><span class="op">..</span>n_samples<span class="op">.</span>min(buffer<span class="op">.</span>len()) <span class="op">{</span></span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">let</span> i_bytes <span class="op">=</span> [raw_buffer[i <span class="op">*</span> <span class="dv">4</span>]<span class="op">,</span> raw_buffer[i <span class="op">*</span> <span class="dv">4</span> <span class="op">+</span> <span class="dv">1</span>]]<span class="op">;</span></span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">let</span> q_bytes <span class="op">=</span> [raw_buffer[i <span class="op">*</span> <span class="dv">4</span> <span class="op">+</span> <span class="dv">2</span>]<span class="op">,</span> raw_buffer[i <span class="op">*</span> <span class="dv">4</span> <span class="op">+</span> <span class="dv">3</span>]]<span class="op">;</span></span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">let</span> i_val <span class="op">=</span> <span class="dt">i16</span><span class="pp">::</span>from_le_bytes(i_bytes)<span class="op">;</span></span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">let</span> q_val <span class="op">=</span> <span class="dt">i16</span><span class="pp">::</span>from_le_bytes(q_bytes)<span class="op">;</span></span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a>                    buffer[i] <span class="op">=</span> <span class="pp">IQSample::</span>new(</span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a>                        i_val <span class="kw">as</span> <span class="dt">f32</span> <span class="op">/</span> <span class="dv">32767.0</span><span class="op">,</span></span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a>                        q_val <span class="kw">as</span> <span class="dt">f32</span> <span class="op">/</span> <span class="dv">32767.0</span><span class="op">,</span></span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a>                    )<span class="op">;</span></span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb31-59"><a href="#cb31-59" aria-hidden="true" tabindex="-1"></a>                <span class="cn">Ok</span>(n_samples)</span>
<span id="cb31-60"><a href="#cb31-60" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb31-61"><a href="#cb31-61" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Err</span>(<span class="kw">ref</span> e) <span class="cf">if</span> e<span class="op">.</span>kind() <span class="op">==</span> <span class="pp">std::io::ErrorKind::</span>WouldBlock <span class="op">=&gt;</span> <span class="cn">Ok</span>(<span class="dv">0</span>)<span class="op">,</span></span>
<span id="cb31-62"><a href="#cb31-62" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Err</span>(e) <span class="op">=&gt;</span> <span class="cn">Err</span>(e)<span class="op">,</span></span>
<span id="cb31-63"><a href="#cb31-63" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb31-64"><a href="#cb31-64" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb31-65"><a href="#cb31-65" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <h3 id="gnu-radio-integration">GNU Radio Integration</h3>
    <div class="sourceCode" id="cb32"><pre
    class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env python3</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="co"># GNU Radio flowgraph to interface with R4W</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> gnuradio <span class="im">import</span> gr, blocks, uhd</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> socket</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> R4WSource(gr.sync_block):</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;GNU Radio source that receives I/Q from R4W&quot;&quot;&quot;</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, port<span class="op">=</span><span class="dv">5000</span>):</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>        gr.sync_block.<span class="fu">__init__</span>(</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>,</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>            name<span class="op">=</span><span class="st">&#39;R4W Source&#39;</span>,</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>            in_sig<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>            out_sig<span class="op">=</span>[numpy.complex64]</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.sock <span class="op">=</span> socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.sock.bind((<span class="st">&#39;0.0.0.0&#39;</span>, port))</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.sock.setblocking(<span class="va">False</span>)</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> work(<span class="va">self</span>, input_items, output_items):</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>        out <span class="op">=</span> output_items[<span class="dv">0</span>]</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>            data, _ <span class="op">=</span> <span class="va">self</span>.sock.recvfrom(<span class="bu">len</span>(out) <span class="op">*</span> <span class="dv">4</span>)</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>            samples <span class="op">=</span> numpy.frombuffer(data, dtype<span class="op">=</span>numpy.int16)</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>            samples <span class="op">=</span> samples.astype(numpy.float32) <span class="op">/</span> <span class="fl">32767.0</span></span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>            iq <span class="op">=</span> samples[<span class="dv">0</span>::<span class="dv">2</span>] <span class="op">+</span> <span class="ot">1j</span> <span class="op">*</span> samples[<span class="dv">1</span>::<span class="dv">2</span>]</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>            n <span class="op">=</span> <span class="bu">min</span>(<span class="bu">len</span>(iq), <span class="bu">len</span>(out))</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>            out[:n] <span class="op">=</span> iq[:n]</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> n</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">BlockingIOError</span>:</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">0</span></span></code></pre></div>
    <hr />
    <h2 id="memory-and-cpu-constraints">Memory and CPU Constraints</h2>
    <h3 id="memory-management-strategies">Memory Management
    Strategies</h3>
    <div class="sourceCode" id="cb33"><pre
    class="sourceCode rust"><code class="sourceCode rust"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// Pre-allocated sample buffer pool</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> SampleBufferPool <span class="op">{</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    buffers<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span>IQSample<span class="op">&gt;&gt;,</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    buffer_size<span class="op">:</span> <span class="dt">usize</span><span class="op">,</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> SampleBufferPool <span class="op">{</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> new(num_buffers<span class="op">:</span> <span class="dt">usize</span><span class="op">,</span> buffer_size<span class="op">:</span> <span class="dt">usize</span>) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> buffers <span class="op">=</span> (<span class="dv">0</span><span class="op">..</span>num_buffers)</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>map(<span class="op">|</span>_<span class="op">|</span> <span class="pp">vec!</span>[<span class="pp">IQSample::</span>new(<span class="dv">0.0</span><span class="op">,</span> <span class="dv">0.0</span>)<span class="op">;</span> buffer_size])</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>collect()<span class="op">;</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Self</span> <span class="op">{</span> buffers<span class="op">,</span> buffer_size <span class="op">}</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> acquire(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span>IQSample<span class="op">&gt;&gt;</span> <span class="op">{</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>buffers<span class="op">.</span>pop()</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> release(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> <span class="kw">mut</span> buffer<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>IQSample<span class="op">&gt;</span>) <span class="op">{</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>        buffer<span class="op">.</span>clear()<span class="op">;</span></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>        buffer<span class="op">.</span>resize(<span class="kw">self</span><span class="op">.</span>buffer_size<span class="op">,</span> <span class="pp">IQSample::</span>new(<span class="dv">0.0</span><span class="op">,</span> <span class="dv">0.0</span>))<span class="op">;</span></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>buffers<span class="op">.</span>push(buffer)<span class="op">;</span></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a><span class="co">/// Streaming processor that avoids allocations</span></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> StreamingProcessor <span class="op">{</span></span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>    waveform<span class="op">:</span> <span class="dt">Box</span><span class="op">&lt;</span><span class="kw">dyn</span> Waveform<span class="op">&gt;,</span></span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>    input_buffer<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>IQSample<span class="op">&gt;,</span></span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>    output_buffer<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">bool</span><span class="op">&gt;,</span></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>    scratch<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">f32</span><span class="op">&gt;,</span></span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> StreamingProcessor <span class="op">{</span></span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> new(waveform<span class="op">:</span> <span class="dt">Box</span><span class="op">&lt;</span><span class="kw">dyn</span> Waveform<span class="op">&gt;,</span> max_samples<span class="op">:</span> <span class="dt">usize</span>) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> max_bits <span class="op">=</span> max_samples <span class="op">/</span> <span class="dv">10</span><span class="op">;</span>  <span class="co">// Conservative estimate</span></span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>            waveform<span class="op">,</span></span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a>            input_buffer<span class="op">:</span> <span class="dt">Vec</span><span class="pp">::</span>with_capacity(max_samples)<span class="op">,</span></span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a>            output_buffer<span class="op">:</span> <span class="dt">Vec</span><span class="pp">::</span>with_capacity(max_bits)<span class="op">,</span></span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a>            scratch<span class="op">:</span> <span class="dt">Vec</span><span class="pp">::</span>with_capacity(max_samples)<span class="op">,</span></span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> process(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> samples<span class="op">:</span> <span class="op">&amp;</span>[IQSample]) <span class="op">-&gt;</span> <span class="op">&amp;</span>[<span class="dt">bool</span>] <span class="op">{</span></span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Clear but don&#39;t deallocate</span></span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>output_buffer<span class="op">.</span>clear()<span class="op">;</span></span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-49"><a href="#cb33-49" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Process using pre-allocated scratch space</span></span>
<span id="cb33-50"><a href="#cb33-50" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> bits <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>waveform<span class="op">.</span>demodulate(samples)<span class="op">;</span></span>
<span id="cb33-51"><a href="#cb33-51" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>output_buffer<span class="op">.</span>extend(bits)<span class="op">;</span></span>
<span id="cb33-52"><a href="#cb33-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-53"><a href="#cb33-53" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span><span class="kw">self</span><span class="op">.</span>output_buffer</span>
<span id="cb33-54"><a href="#cb33-54" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb33-55"><a href="#cb33-55" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <h3 id="cpu-affinity-and-priority">CPU Affinity and Priority</h3>
    <div class="sourceCode" id="cb34"><pre
    class="sourceCode rust"><code class="sourceCode rust"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">nix::sched::</span><span class="op">{</span>sched_setaffinity<span class="op">,</span> CpuSet<span class="op">};</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">nix::unistd::</span>Pid<span class="op">;</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="co">/// Pin current thread to specific CPU core</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> pin_to_cpu(cpu<span class="op">:</span> <span class="dt">usize</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="pp">nix::</span><span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> cpuset <span class="op">=</span> <span class="pp">CpuSet::</span>new()<span class="op">;</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    cpuset<span class="op">.</span>set(cpu)<span class="op">?;</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    sched_setaffinity(<span class="pp">Pid::</span>from_raw(<span class="dv">0</span>)<span class="op">,</span> <span class="op">&amp;</span>cpuset)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="co">/// Set real-time scheduling priority</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> set_realtime_priority(priority<span class="op">:</span> <span class="dt">i32</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="pp">nix::</span><span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">nix::sched::</span><span class="op">{</span>sched_setscheduler<span class="op">,</span> Scheduler<span class="op">};</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> param <span class="op">=</span> <span class="pp">nix::sched::</span>sched_param <span class="op">{</span> sched_priority<span class="op">:</span> priority <span class="op">};</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>    sched_setscheduler(<span class="pp">Pid::</span>from_raw(<span class="dv">0</span>)<span class="op">,</span> <span class="pp">Scheduler::</span>FIFO<span class="op">,</span> <span class="op">&amp;</span>param)</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a><span class="co">/// Example: Configure worker thread</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> setup_worker_thread() <span class="op">{</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Pin to CPU 2 (avoid CPU 0 which handles interrupts)</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Err</span>(e) <span class="op">=</span> pin_to_cpu(<span class="dv">2</span>) <span class="op">{</span></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>        <span class="pp">eprintln!</span>(<span class="st">&quot;Warning: Could not pin to CPU: {}&quot;</span><span class="op">,</span> e)<span class="op">;</span></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Set real-time priority (requires CAP_SYS_NICE)</span></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Err</span>(e) <span class="op">=</span> set_realtime_priority(<span class="dv">50</span>) <span class="op">{</span></span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>        <span class="pp">eprintln!</span>(<span class="st">&quot;Warning: Could not set RT priority: {}&quot;</span><span class="op">,</span> e)<span class="op">;</span></span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <h3 id="resource-monitoring">Resource Monitoring</h3>
    <div class="sourceCode" id="cb35"><pre
    class="sourceCode rust"><code class="sourceCode rust"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">std::time::</span><span class="op">{</span>Duration<span class="op">,</span> Instant<span class="op">};</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> ResourceMonitor <span class="op">{</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    start_time<span class="op">:</span> Instant<span class="op">,</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    samples_processed<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    peak_latency_us<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    total_latency_us<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    measurement_count<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> ResourceMonitor <span class="op">{</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> new() <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>            start_time<span class="op">:</span> <span class="pp">Instant::</span>now()<span class="op">,</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>            samples_processed<span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>            peak_latency_us<span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>            total_latency_us<span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>            measurement_count<span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> record_processing(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> samples<span class="op">:</span> <span class="dt">usize</span><span class="op">,</span> latency<span class="op">:</span> Duration) <span class="op">{</span></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>samples_processed <span class="op">+=</span> samples <span class="kw">as</span> <span class="dt">u64</span><span class="op">;</span></span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> latency_us <span class="op">=</span> latency<span class="op">.</span>as_micros() <span class="kw">as</span> <span class="dt">u64</span><span class="op">;</span></span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>peak_latency_us <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>peak_latency_us<span class="op">.</span>max(latency_us)<span class="op">;</span></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>total_latency_us <span class="op">+=</span> latency_us<span class="op">;</span></span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>measurement_count <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> report(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> ResourceReport <span class="op">{</span></span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> elapsed <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>start_time<span class="op">.</span>elapsed()<span class="op">;</span></span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>        ResourceReport <span class="op">{</span></span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>            throughput_sps<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>samples_processed <span class="kw">as</span> <span class="dt">f64</span> <span class="op">/</span> elapsed<span class="op">.</span>as_secs_f64()<span class="op">,</span></span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>            avg_latency_us<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>total_latency_us <span class="op">/</span> <span class="kw">self</span><span class="op">.</span>measurement_count<span class="op">.</span>max(<span class="dv">1</span>)<span class="op">,</span></span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>            peak_latency_us<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>peak_latency_us<span class="op">,</span></span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>            uptime_secs<span class="op">:</span> elapsed<span class="op">.</span>as_secs()<span class="op">,</span></span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="at">)]</span></span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> ResourceReport <span class="op">{</span></span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> throughput_sps<span class="op">:</span> <span class="dt">f64</span><span class="op">,</span></span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> avg_latency_us<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> peak_latency_us<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> uptime_secs<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <hr />
    <h2 id="shared-memory-ipc">Shared Memory IPC</h2>
    <h3 id="posix-shared-memory">POSIX Shared Memory</h3>
    <p>For high-performance inter-process communication:</p>
    <div class="sourceCode" id="cb36"><pre
    class="sourceCode rust"><code class="sourceCode rust"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">std::ffi::</span>CString<span class="op">;</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">std::</span>ptr<span class="op">;</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="co">/// Shared memory region for I/Q samples</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> SharedMemoryRegion <span class="op">{</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    name<span class="op">:</span> CString<span class="op">,</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    ptr<span class="op">:</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span><span class="op">,</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    size<span class="op">:</span> <span class="dt">usize</span><span class="op">,</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    fd<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> SharedMemoryRegion <span class="op">{</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> create(name<span class="op">:</span> <span class="op">&amp;</span><span class="dt">str</span><span class="op">,</span> size<span class="op">:</span> <span class="dt">usize</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">Self</span><span class="op">,</span> <span class="pp">std::io::</span><span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> name <span class="op">=</span> <span class="pp">CString::</span>new(name)<span class="op">?;</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Create shared memory object</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> fd <span class="op">=</span> <span class="pp">libc::</span>shm_open(</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>                name<span class="op">.</span>as_ptr()<span class="op">,</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>                <span class="pp">libc::</span><span class="cn">O_CREAT</span> <span class="op">|</span> <span class="pp">libc::</span><span class="cn">O_RDWR</span><span class="op">,</span></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>                <span class="dv">0o666</span><span class="op">,</span></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>            )<span class="op">;</span></span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> fd <span class="op">&lt;</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="pp">std::io::</span><span class="bu">Error</span><span class="pp">::</span>last_os_error())<span class="op">;</span></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Set size</span></span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="pp">libc::</span>ftruncate(fd<span class="op">,</span> size <span class="kw">as</span> <span class="pp">libc::</span><span class="dt">off_t</span>) <span class="op">&lt;</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>                <span class="pp">libc::</span>close(fd)<span class="op">;</span></span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="pp">std::io::</span><span class="bu">Error</span><span class="pp">::</span>last_os_error())<span class="op">;</span></span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Map to memory</span></span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> ptr <span class="op">=</span> <span class="pp">libc::</span>mmap(</span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a>                <span class="pp">ptr::</span>null_mut()<span class="op">,</span></span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a>                size<span class="op">,</span></span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a>                <span class="pp">libc::</span>PROT_READ <span class="op">|</span> <span class="pp">libc::</span>PROT_WRITE<span class="op">,</span></span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a>                <span class="pp">libc::</span>MAP_SHARED<span class="op">,</span></span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a>                fd<span class="op">,</span></span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a>                <span class="dv">0</span><span class="op">,</span></span>
<span id="cb36-41"><a href="#cb36-41" aria-hidden="true" tabindex="-1"></a>            )<span class="op">;</span></span>
<span id="cb36-42"><a href="#cb36-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-43"><a href="#cb36-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> ptr <span class="op">==</span> <span class="pp">libc::</span>MAP_FAILED <span class="op">{</span></span>
<span id="cb36-44"><a href="#cb36-44" aria-hidden="true" tabindex="-1"></a>                <span class="pp">libc::</span>close(fd)<span class="op">;</span></span>
<span id="cb36-45"><a href="#cb36-45" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="pp">std::io::</span><span class="bu">Error</span><span class="pp">::</span>last_os_error())<span class="op">;</span></span>
<span id="cb36-46"><a href="#cb36-46" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb36-47"><a href="#cb36-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-48"><a href="#cb36-48" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(<span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb36-49"><a href="#cb36-49" aria-hidden="true" tabindex="-1"></a>                name<span class="op">,</span></span>
<span id="cb36-50"><a href="#cb36-50" aria-hidden="true" tabindex="-1"></a>                ptr<span class="op">:</span> ptr <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span><span class="op">,</span></span>
<span id="cb36-51"><a href="#cb36-51" aria-hidden="true" tabindex="-1"></a>                size<span class="op">,</span></span>
<span id="cb36-52"><a href="#cb36-52" aria-hidden="true" tabindex="-1"></a>                fd<span class="op">,</span></span>
<span id="cb36-53"><a href="#cb36-53" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)</span>
<span id="cb36-54"><a href="#cb36-54" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb36-55"><a href="#cb36-55" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb36-56"><a href="#cb36-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-57"><a href="#cb36-57" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> open(name<span class="op">:</span> <span class="op">&amp;</span><span class="dt">str</span><span class="op">,</span> size<span class="op">:</span> <span class="dt">usize</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">Self</span><span class="op">,</span> <span class="pp">std::io::</span><span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb36-58"><a href="#cb36-58" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> name <span class="op">=</span> <span class="pp">CString::</span>new(name)<span class="op">?;</span></span>
<span id="cb36-59"><a href="#cb36-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-60"><a href="#cb36-60" aria-hidden="true" tabindex="-1"></a>        <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb36-61"><a href="#cb36-61" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> fd <span class="op">=</span> <span class="pp">libc::</span>shm_open(name<span class="op">.</span>as_ptr()<span class="op">,</span> <span class="pp">libc::</span><span class="cn">O_RDWR</span><span class="op">,</span> <span class="dv">0o666</span>)<span class="op">;</span></span>
<span id="cb36-62"><a href="#cb36-62" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> fd <span class="op">&lt;</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb36-63"><a href="#cb36-63" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="pp">std::io::</span><span class="bu">Error</span><span class="pp">::</span>last_os_error())<span class="op">;</span></span>
<span id="cb36-64"><a href="#cb36-64" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb36-65"><a href="#cb36-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-66"><a href="#cb36-66" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> ptr <span class="op">=</span> <span class="pp">libc::</span>mmap(</span>
<span id="cb36-67"><a href="#cb36-67" aria-hidden="true" tabindex="-1"></a>                <span class="pp">ptr::</span>null_mut()<span class="op">,</span></span>
<span id="cb36-68"><a href="#cb36-68" aria-hidden="true" tabindex="-1"></a>                size<span class="op">,</span></span>
<span id="cb36-69"><a href="#cb36-69" aria-hidden="true" tabindex="-1"></a>                <span class="pp">libc::</span>PROT_READ <span class="op">|</span> <span class="pp">libc::</span>PROT_WRITE<span class="op">,</span></span>
<span id="cb36-70"><a href="#cb36-70" aria-hidden="true" tabindex="-1"></a>                <span class="pp">libc::</span>MAP_SHARED<span class="op">,</span></span>
<span id="cb36-71"><a href="#cb36-71" aria-hidden="true" tabindex="-1"></a>                fd<span class="op">,</span></span>
<span id="cb36-72"><a href="#cb36-72" aria-hidden="true" tabindex="-1"></a>                <span class="dv">0</span><span class="op">,</span></span>
<span id="cb36-73"><a href="#cb36-73" aria-hidden="true" tabindex="-1"></a>            )<span class="op">;</span></span>
<span id="cb36-74"><a href="#cb36-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-75"><a href="#cb36-75" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> ptr <span class="op">==</span> <span class="pp">libc::</span>MAP_FAILED <span class="op">{</span></span>
<span id="cb36-76"><a href="#cb36-76" aria-hidden="true" tabindex="-1"></a>                <span class="pp">libc::</span>close(fd)<span class="op">;</span></span>
<span id="cb36-77"><a href="#cb36-77" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="pp">std::io::</span><span class="bu">Error</span><span class="pp">::</span>last_os_error())<span class="op">;</span></span>
<span id="cb36-78"><a href="#cb36-78" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb36-79"><a href="#cb36-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-80"><a href="#cb36-80" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(<span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb36-81"><a href="#cb36-81" aria-hidden="true" tabindex="-1"></a>                name<span class="op">,</span></span>
<span id="cb36-82"><a href="#cb36-82" aria-hidden="true" tabindex="-1"></a>                ptr<span class="op">:</span> ptr <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span><span class="op">,</span></span>
<span id="cb36-83"><a href="#cb36-83" aria-hidden="true" tabindex="-1"></a>                size<span class="op">,</span></span>
<span id="cb36-84"><a href="#cb36-84" aria-hidden="true" tabindex="-1"></a>                fd<span class="op">,</span></span>
<span id="cb36-85"><a href="#cb36-85" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)</span>
<span id="cb36-86"><a href="#cb36-86" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb36-87"><a href="#cb36-87" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb36-88"><a href="#cb36-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-89"><a href="#cb36-89" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> write_samples(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> samples<span class="op">:</span> <span class="op">&amp;</span>[IQSample]) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="pp">std::io::</span><span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb36-90"><a href="#cb36-90" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> byte_len <span class="op">=</span> samples<span class="op">.</span>len() <span class="op">*</span> <span class="pp">std::mem::size_of::</span><span class="op">&lt;</span>IQSample<span class="op">&gt;</span>()<span class="op">;</span></span>
<span id="cb36-91"><a href="#cb36-91" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> byte_len <span class="op">&gt;</span> <span class="kw">self</span><span class="op">.</span>size <span class="op">{</span></span>
<span id="cb36-92"><a href="#cb36-92" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="pp">std::io::</span><span class="bu">Error</span><span class="pp">::</span>new(</span>
<span id="cb36-93"><a href="#cb36-93" aria-hidden="true" tabindex="-1"></a>                <span class="pp">std::io::ErrorKind::</span>InvalidInput<span class="op">,</span></span>
<span id="cb36-94"><a href="#cb36-94" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;Buffer too large&quot;</span><span class="op">,</span></span>
<span id="cb36-95"><a href="#cb36-95" aria-hidden="true" tabindex="-1"></a>            ))<span class="op">;</span></span>
<span id="cb36-96"><a href="#cb36-96" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb36-97"><a href="#cb36-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-98"><a href="#cb36-98" aria-hidden="true" tabindex="-1"></a>        <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb36-99"><a href="#cb36-99" aria-hidden="true" tabindex="-1"></a>            <span class="pp">ptr::</span>copy_nonoverlapping(</span>
<span id="cb36-100"><a href="#cb36-100" aria-hidden="true" tabindex="-1"></a>                samples<span class="op">.</span>as_ptr() <span class="kw">as</span> <span class="op">*</span><span class="kw">const</span> <span class="dt">u8</span><span class="op">,</span></span>
<span id="cb36-101"><a href="#cb36-101" aria-hidden="true" tabindex="-1"></a>                <span class="kw">self</span><span class="op">.</span>ptr<span class="op">,</span></span>
<span id="cb36-102"><a href="#cb36-102" aria-hidden="true" tabindex="-1"></a>                byte_len<span class="op">,</span></span>
<span id="cb36-103"><a href="#cb36-103" aria-hidden="true" tabindex="-1"></a>            )<span class="op">;</span></span>
<span id="cb36-104"><a href="#cb36-104" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb36-105"><a href="#cb36-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-106"><a href="#cb36-106" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(())</span>
<span id="cb36-107"><a href="#cb36-107" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb36-108"><a href="#cb36-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-109"><a href="#cb36-109" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> read_samples(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> count<span class="op">:</span> <span class="dt">usize</span>) <span class="op">-&gt;</span> <span class="dt">Vec</span><span class="op">&lt;</span>IQSample<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb36-110"><a href="#cb36-110" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> samples <span class="op">=</span> <span class="pp">vec!</span>[<span class="pp">IQSample::</span>new(<span class="dv">0.0</span><span class="op">,</span> <span class="dv">0.0</span>)<span class="op">;</span> count]<span class="op">;</span></span>
<span id="cb36-111"><a href="#cb36-111" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> byte_len <span class="op">=</span> count <span class="op">*</span> <span class="pp">std::mem::size_of::</span><span class="op">&lt;</span>IQSample<span class="op">&gt;</span>()<span class="op">;</span></span>
<span id="cb36-112"><a href="#cb36-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-113"><a href="#cb36-113" aria-hidden="true" tabindex="-1"></a>        <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb36-114"><a href="#cb36-114" aria-hidden="true" tabindex="-1"></a>            <span class="pp">ptr::</span>copy_nonoverlapping(</span>
<span id="cb36-115"><a href="#cb36-115" aria-hidden="true" tabindex="-1"></a>                <span class="kw">self</span><span class="op">.</span>ptr<span class="op">,</span></span>
<span id="cb36-116"><a href="#cb36-116" aria-hidden="true" tabindex="-1"></a>                samples<span class="op">.</span>as_mut_ptr() <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">u8</span><span class="op">,</span></span>
<span id="cb36-117"><a href="#cb36-117" aria-hidden="true" tabindex="-1"></a>                byte_len<span class="op">.</span>min(<span class="kw">self</span><span class="op">.</span>size)<span class="op">,</span></span>
<span id="cb36-118"><a href="#cb36-118" aria-hidden="true" tabindex="-1"></a>            )<span class="op">;</span></span>
<span id="cb36-119"><a href="#cb36-119" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb36-120"><a href="#cb36-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-121"><a href="#cb36-121" aria-hidden="true" tabindex="-1"></a>        samples</span>
<span id="cb36-122"><a href="#cb36-122" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb36-123"><a href="#cb36-123" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb36-124"><a href="#cb36-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-125"><a href="#cb36-125" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> <span class="bu">Drop</span> <span class="cf">for</span> SharedMemoryRegion <span class="op">{</span></span>
<span id="cb36-126"><a href="#cb36-126" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> drop(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">{</span></span>
<span id="cb36-127"><a href="#cb36-127" aria-hidden="true" tabindex="-1"></a>        <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb36-128"><a href="#cb36-128" aria-hidden="true" tabindex="-1"></a>            <span class="pp">libc::</span>munmap(<span class="kw">self</span><span class="op">.</span>ptr <span class="kw">as</span> <span class="op">*</span><span class="kw">mut</span> <span class="pp">libc::</span><span class="dt">c_void</span><span class="op">,</span> <span class="kw">self</span><span class="op">.</span>size)<span class="op">;</span></span>
<span id="cb36-129"><a href="#cb36-129" aria-hidden="true" tabindex="-1"></a>            <span class="pp">libc::</span>close(<span class="kw">self</span><span class="op">.</span>fd)<span class="op">;</span></span>
<span id="cb36-130"><a href="#cb36-130" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Optionally unlink:</span></span>
<span id="cb36-131"><a href="#cb36-131" aria-hidden="true" tabindex="-1"></a>            <span class="co">// libc::shm_unlink(self.name.as_ptr());</span></span>
<span id="cb36-132"><a href="#cb36-132" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb36-133"><a href="#cb36-133" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb36-134"><a href="#cb36-134" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <h3 id="ring-buffer-for-streaming">Ring Buffer for Streaming</h3>
    <div class="sourceCode" id="cb37"><pre
    class="sourceCode rust"><code class="sourceCode rust"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">std::sync::atomic::</span><span class="op">{</span>AtomicUsize<span class="op">,</span> Ordering<span class="op">};</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// Lock-free SPSC ring buffer for real-time streaming</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> RingBuffer <span class="op">{</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    buffer<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>IQSample<span class="op">&gt;,</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    capacity<span class="op">:</span> <span class="dt">usize</span><span class="op">,</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    write_idx<span class="op">:</span> AtomicUsize<span class="op">,</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    read_idx<span class="op">:</span> AtomicUsize<span class="op">,</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> RingBuffer <span class="op">{</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> new(capacity<span class="op">:</span> <span class="dt">usize</span>) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Power of 2 for efficient modulo</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> capacity <span class="op">=</span> capacity<span class="op">.</span>next_power_of_two()<span class="op">;</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>            buffer<span class="op">:</span> <span class="pp">vec!</span>[<span class="pp">IQSample::</span>new(<span class="dv">0.0</span><span class="op">,</span> <span class="dv">0.0</span>)<span class="op">;</span> capacity]<span class="op">,</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>            capacity<span class="op">,</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>            write_idx<span class="op">:</span> <span class="pp">AtomicUsize::</span>new(<span class="dv">0</span>)<span class="op">,</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>            read_idx<span class="op">:</span> <span class="pp">AtomicUsize::</span>new(<span class="dv">0</span>)<span class="op">,</span></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> push(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> sample<span class="op">:</span> IQSample) <span class="op">-&gt;</span> <span class="dt">bool</span> <span class="op">{</span></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> write <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>write_idx<span class="op">.</span>load(<span class="pp">Ordering::</span>Relaxed)<span class="op">;</span></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> read <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>read_idx<span class="op">.</span>load(<span class="pp">Ordering::</span>Acquire)<span class="op">;</span></span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> next_write <span class="op">=</span> (write <span class="op">+</span> <span class="dv">1</span>) <span class="op">&amp;</span> (<span class="kw">self</span><span class="op">.</span>capacity <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> next_write <span class="op">==</span> read <span class="op">{</span></span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">false</span><span class="op">;</span>  <span class="co">// Full</span></span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>buffer[write] <span class="op">=</span> sample<span class="op">;</span></span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>write_idx<span class="op">.</span>store(next_write<span class="op">,</span> <span class="pp">Ordering::</span>Release)<span class="op">;</span></span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a>        <span class="cn">true</span></span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> pop(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Option</span><span class="op">&lt;</span>IQSample<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> read <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>read_idx<span class="op">.</span>load(<span class="pp">Ordering::</span>Relaxed)<span class="op">;</span></span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> write <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>write_idx<span class="op">.</span>load(<span class="pp">Ordering::</span>Acquire)<span class="op">;</span></span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> read <span class="op">==</span> write <span class="op">{</span></span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">None</span><span class="op">;</span>  <span class="co">// Empty</span></span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> sample <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>buffer[read]<span class="op">;</span></span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>read_idx<span class="op">.</span>store((read <span class="op">+</span> <span class="dv">1</span>) <span class="op">&amp;</span> (<span class="kw">self</span><span class="op">.</span>capacity <span class="op">-</span> <span class="dv">1</span>)<span class="op">,</span> <span class="pp">Ordering::</span>Release)<span class="op">;</span></span>
<span id="cb37-47"><a href="#cb37-47" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Some</span>(sample)</span>
<span id="cb37-48"><a href="#cb37-48" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb37-49"><a href="#cb37-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-50"><a href="#cb37-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> available(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">usize</span> <span class="op">{</span></span>
<span id="cb37-51"><a href="#cb37-51" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> write <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>write_idx<span class="op">.</span>load(<span class="pp">Ordering::</span>Acquire)<span class="op">;</span></span>
<span id="cb37-52"><a href="#cb37-52" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> read <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>read_idx<span class="op">.</span>load(<span class="pp">Ordering::</span>Acquire)<span class="op">;</span></span>
<span id="cb37-53"><a href="#cb37-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-54"><a href="#cb37-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> write <span class="op">&gt;=</span> read <span class="op">{</span></span>
<span id="cb37-55"><a href="#cb37-55" aria-hidden="true" tabindex="-1"></a>            write <span class="op">-</span> read</span>
<span id="cb37-56"><a href="#cb37-56" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb37-57"><a href="#cb37-57" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>capacity <span class="op">-</span> read <span class="op">+</span> write</span>
<span id="cb37-58"><a href="#cb37-58" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb37-59"><a href="#cb37-59" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb37-60"><a href="#cb37-60" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <hr />
    <h2 id="real-time-processing">Real-Time Processing</h2>
    <h3 id="real-time-design-principles">Real-Time Design
    Principles</h3>
    <ol type="1">
    <li><strong>Avoid Allocations</strong>: Pre-allocate all
    buffers</li>
    <li><strong>No Locks in Hot Path</strong>: Use lock-free data
    structures</li>
    <li><strong>Bounded Latency</strong>: Know worst-case execution
    time</li>
    <li><strong>Priority Inheritance</strong>: Use appropriate mutex
    types</li>
    </ol>
    <div class="sourceCode" id="cb38"><pre
    class="sourceCode rust"><code class="sourceCode rust"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">std::sync::</span>Arc<span class="op">;</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">parking_lot::</span>Mutex<span class="op">;</span>  <span class="co">// Better for real-time than std::sync::Mutex</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> RealtimeProcessor <span class="op">{</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    waveform<span class="op">:</span> Arc<span class="op">&lt;</span><span class="kw">dyn</span> Waveform<span class="op">&gt;,</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    input_pool<span class="op">:</span> Mutex<span class="op">&lt;</span>SampleBufferPool<span class="op">&gt;,</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    output_pool<span class="op">:</span> Mutex<span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">bool</span><span class="op">&gt;&gt;&gt;,</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Pre-allocated scratch buffers</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    scratch_fft<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>IQSample<span class="op">&gt;,</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    scratch_filter<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>IQSample<span class="op">&gt;,</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> RealtimeProcessor <span class="op">{</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> process_realtime(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> samples<span class="op">:</span> <span class="op">&amp;</span>[IQSample]) <span class="op">-&gt;</span> <span class="op">&amp;</span>[<span class="dt">bool</span>] <span class="op">{</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Reuse pre-allocated buffers</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>scratch_fft<span class="op">.</span>clear()<span class="op">;</span></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>scratch_fft<span class="op">.</span>extend_from_slice(samples)<span class="op">;</span></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Process without allocation</span></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> bits <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>waveform<span class="op">.</span>demodulate(<span class="op">&amp;</span><span class="kw">self</span><span class="op">.</span>scratch_fft)<span class="op">;</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Store result in pre-allocated output</span></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ...</span></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>        <span class="pp">todo!</span>()</span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <h3 id="latency-measurement">Latency Measurement</h3>
    <div class="sourceCode" id="cb39"><pre
    class="sourceCode rust"><code class="sourceCode rust"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">std::time::</span>Instant<span class="op">;</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> LatencyTracker <span class="op">{</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    samples<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u64</span><span class="op">&gt;,</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    position<span class="op">:</span> <span class="dt">usize</span><span class="op">,</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    capacity<span class="op">:</span> <span class="dt">usize</span><span class="op">,</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> LatencyTracker <span class="op">{</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> new(capacity<span class="op">:</span> <span class="dt">usize</span>) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>            samples<span class="op">:</span> <span class="pp">vec!</span>[<span class="dv">0</span><span class="op">;</span> capacity]<span class="op">,</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>            position<span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>            capacity<span class="op">,</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> record(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> latency_ns<span class="op">:</span> <span class="dt">u64</span>) <span class="op">{</span></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>samples[<span class="kw">self</span><span class="op">.</span>position] <span class="op">=</span> latency_ns<span class="op">;</span></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>position <span class="op">=</span> (<span class="kw">self</span><span class="op">.</span>position <span class="op">+</span> <span class="dv">1</span>) <span class="op">%</span> <span class="kw">self</span><span class="op">.</span>capacity<span class="op">;</span></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> percentile(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> p<span class="op">:</span> <span class="dt">f64</span>) <span class="op">-&gt;</span> <span class="dt">u64</span> <span class="op">{</span></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> sorted<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>_<span class="op">&gt;</span> <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>samples<span class="op">.</span>iter()<span class="op">.</span>copied()<span class="op">.</span>filter(<span class="op">|&amp;</span>x<span class="op">|</span> x <span class="op">&gt;</span> <span class="dv">0</span>)<span class="op">.</span>collect()<span class="op">;</span></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>        sorted<span class="op">.</span>sort_unstable()<span class="op">;</span></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> sorted<span class="op">.</span>is_empty() <span class="op">{</span></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> idx <span class="op">=</span> ((sorted<span class="op">.</span>len() <span class="kw">as</span> <span class="dt">f64</span> <span class="op">*</span> p <span class="op">/</span> <span class="dv">100.0</span>) <span class="kw">as</span> <span class="dt">usize</span>)<span class="op">.</span>min(sorted<span class="op">.</span>len() <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>        sorted[idx]</span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> stats(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> LatencyStats <span class="op">{</span></span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a>        LatencyStats <span class="op">{</span></span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a>            p50_ns<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>percentile(<span class="dv">50.0</span>)<span class="op">,</span></span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a>            p95_ns<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>percentile(<span class="dv">95.0</span>)<span class="op">,</span></span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a>            p99_ns<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>percentile(<span class="dv">99.0</span>)<span class="op">,</span></span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a>            max_ns<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>samples<span class="op">.</span>iter()<span class="op">.</span>copied()<span class="op">.</span>max()<span class="op">.</span>unwrap_or(<span class="dv">0</span>)<span class="op">,</span></span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb39-43"><a href="#cb39-43" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb39-44"><a href="#cb39-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-45"><a href="#cb39-45" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="at">)]</span></span>
<span id="cb39-46"><a href="#cb39-46" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> LatencyStats <span class="op">{</span></span>
<span id="cb39-47"><a href="#cb39-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> p50_ns<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb39-48"><a href="#cb39-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> p95_ns<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb39-49"><a href="#cb39-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> p99_ns<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb39-50"><a href="#cb39-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> max_ns<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb39-51"><a href="#cb39-51" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <hr />
    <h2 id="testing-strategies">Testing Strategies</h2>
    <h3 id="unit-tests">Unit Tests</h3>
    <div class="sourceCode" id="cb40"><pre
    class="sourceCode rust"><code class="sourceCode rust"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> tests <span class="op">{</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="kw">super</span><span class="pp">::</span><span class="op">*;</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>test<span class="at">]</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> test_modulation_basic() <span class="op">{</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> waveform <span class="op">=</span> <span class="pp">MyWaveform::</span>default_config(<span class="dv">48000.0</span>)<span class="op">;</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> bits <span class="op">=</span> <span class="pp">vec!</span>[<span class="cn">true</span><span class="op">,</span> <span class="cn">false</span>]<span class="op">;</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> samples <span class="op">=</span> waveform<span class="op">.</span>modulate(<span class="op">&amp;</span>bits)<span class="op">;</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert!</span>(<span class="op">!</span>samples<span class="op">.</span>is_empty())<span class="op">;</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(samples<span class="op">.</span>len() <span class="op">%</span> waveform<span class="op">.</span>samples_per_symbol<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>test<span class="at">]</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> test_roundtrip_all_patterns() <span class="op">{</span></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> waveform <span class="op">=</span> <span class="pp">MyWaveform::</span>default_config(<span class="dv">48000.0</span>)<span class="op">;</span></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Test all 2-bit patterns</span></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> pattern <span class="kw">in</span> <span class="dv">0</span><span class="op">..</span><span class="dv">4u8</span> <span class="op">{</span></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> bits <span class="op">=</span> <span class="pp">vec!</span>[pattern <span class="op">&amp;</span> <span class="dv">1</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">,</span> pattern <span class="op">&amp;</span> <span class="dv">2</span> <span class="op">!=</span> <span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> samples <span class="op">=</span> waveform<span class="op">.</span>modulate(<span class="op">&amp;</span>bits)<span class="op">;</span></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> recovered <span class="op">=</span> waveform<span class="op">.</span>demodulate(<span class="op">&amp;</span>samples)<span class="op">;</span></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(bits<span class="op">,</span> recovered<span class="op">,</span> <span class="st">&quot;Pattern {:02b} failed&quot;</span><span class="op">,</span> pattern)<span class="op">;</span></span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <h3 id="integration-tests">Integration Tests</h3>
    <div class="sourceCode" id="cb41"><pre
    class="sourceCode rust"><code class="sourceCode rust"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co">// tests/integration_test.rs</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">r4w_core::waveform::</span>WaveformFactory<span class="op">;</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">r4w_sim::channel::</span>AwgnChannel<span class="op">;</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>test<span class="at">]</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> test_waveform_through_channel() <span class="op">{</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> waveform <span class="op">=</span> <span class="pp">WaveformFactory::</span>create(<span class="st">&quot;LoRa&quot;</span><span class="op">,</span> <span class="dv">500000.0</span>)<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> message <span class="op">=</span> <span class="st">&quot;Hello, R4W!&quot;</span><span class="op">;</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> bits<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">bool</span><span class="op">&gt;</span> <span class="op">=</span> message<span class="op">.</span>bytes()</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>flat_map(<span class="op">|</span>b<span class="op">|</span> (<span class="dv">0</span><span class="op">..</span><span class="dv">8</span>)<span class="op">.</span>map(<span class="kw">move</span> <span class="op">|</span>i<span class="op">|</span> (b <span class="op">&gt;&gt;</span> i) <span class="op">&amp;</span> <span class="dv">1</span> <span class="op">!=</span> <span class="dv">0</span>))</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>collect()<span class="op">;</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> samples <span class="op">=</span> waveform<span class="op">.</span>modulate(<span class="op">&amp;</span>bits)<span class="op">;</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> noisy <span class="op">=</span> <span class="pp">AwgnChannel::</span>new(<span class="dv">10.0</span>)<span class="op">.</span>apply(<span class="op">&amp;</span>samples)<span class="op">;</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> recovered_bits <span class="op">=</span> waveform<span class="op">.</span>demodulate(<span class="op">&amp;</span>noisy)<span class="op">;</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> recovered_bytes<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;</span> <span class="op">=</span> recovered_bits<span class="op">.</span>chunks(<span class="dv">8</span>)</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>map(<span class="op">|</span>chunk<span class="op">|</span> <span class="op">{</span></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>            chunk<span class="op">.</span>iter()<span class="op">.</span>enumerate()</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>fold(<span class="dv">0u8</span><span class="op">,</span> <span class="op">|</span>acc<span class="op">,</span> (i<span class="op">,</span> <span class="op">&amp;</span>b)<span class="op">|</span> acc <span class="op">|</span> ((b <span class="kw">as</span> <span class="dt">u8</span>) <span class="op">&lt;&lt;</span> i))</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span>)</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>collect()<span class="op">;</span></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> recovered_message<span class="op">:</span> <span class="dt">String</span> <span class="op">=</span> recovered_bytes<span class="op">.</span>iter()</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>take_while(<span class="op">|&amp;&amp;</span>b<span class="op">|</span> b <span class="op">!=</span> <span class="dv">0</span>)</span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>map(<span class="op">|&amp;</span>b<span class="op">|</span> b <span class="kw">as</span> <span class="dt">char</span>)</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>collect()<span class="op">;</span></span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>    <span class="pp">assert_eq!</span>(message<span class="op">,</span> recovered_message)<span class="op">;</span></span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <h3 id="property-based-testing">Property-Based Testing</h3>
    <div class="sourceCode" id="cb42"><pre
    class="sourceCode rust"><code class="sourceCode rust"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">proptest::prelude::</span><span class="op">*;</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="pp">proptest!</span> <span class="op">{</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>test<span class="at">]</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> test_roundtrip_any_bits(bits <span class="kw">in</span> <span class="pp">prop::collection::</span>vec(<span class="pp">any::</span><span class="op">&lt;</span><span class="dt">bool</span><span class="op">&gt;</span>()<span class="op">,</span> <span class="dv">2</span><span class="op">..</span><span class="dv">100</span>)) <span class="op">{</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> waveform <span class="op">=</span> <span class="pp">MyWaveform::</span>default_config(<span class="dv">48000.0</span>)<span class="op">;</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Pad to even length</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> bits <span class="op">=</span> bits<span class="op">;</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> bits<span class="op">.</span>len() <span class="op">%</span> <span class="dv">2</span> <span class="op">!=</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>            bits<span class="op">.</span>push(<span class="cn">false</span>)<span class="op">;</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> samples <span class="op">=</span> waveform<span class="op">.</span>modulate(<span class="op">&amp;</span>bits)<span class="op">;</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> recovered <span class="op">=</span> waveform<span class="op">.</span>demodulate(<span class="op">&amp;</span>samples)<span class="op">;</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>        <span class="pp">prop_assert_eq!</span>(bits<span class="op">,</span> recovered)<span class="op">;</span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>test<span class="at">]</span></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> test_constellation_unit_magnitude(</span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>        waveform_name <span class="kw">in</span> <span class="pp">prop::sample::</span>select(<span class="pp">vec!</span>[<span class="st">&quot;BPSK&quot;</span><span class="op">,</span> <span class="st">&quot;QPSK&quot;</span><span class="op">,</span> <span class="st">&quot;MyWave&quot;</span>])</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">{</span></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> waveform <span class="op">=</span> <span class="pp">WaveformFactory::</span>create(<span class="op">&amp;</span>waveform_name<span class="op">,</span> <span class="dv">48000.0</span>)<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> points <span class="op">=</span> waveform<span class="op">.</span>constellation_points()<span class="op">;</span></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> point <span class="kw">in</span> points <span class="op">{</span></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> mag <span class="op">=</span> point<span class="op">.</span>magnitude()<span class="op">;</span></span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>            <span class="pp">prop_assert!</span>((mag <span class="op">-</span> <span class="dv">1.0</span>)<span class="op">.</span>abs() <span class="op">&lt;</span> <span class="dv">0.1</span><span class="op">,</span> <span class="st">&quot;Magnitude {} not near 1.0&quot;</span><span class="op">,</span> mag)<span class="op">;</span></span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <h3 id="fuzz-testing">Fuzz Testing</h3>
    <div class="sourceCode" id="cb43"><pre
    class="sourceCode rust"><code class="sourceCode rust"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co">// fuzz/fuzz_targets/demodulate.rs</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="at">#![</span>no_main<span class="at">]</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">libfuzzer_sys::</span>fuzz_target<span class="op">;</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">r4w_core::types::</span>IQSample<span class="op">;</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">r4w_core::waveform::</span>WaveformFactory<span class="op">;</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="pp">fuzz_target!</span>(<span class="op">|</span>data<span class="op">:</span> <span class="op">&amp;</span>[<span class="dt">u8</span>]<span class="op">|</span> <span class="op">{</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> data<span class="op">.</span>len() <span class="op">&lt;</span> <span class="dv">8</span> <span class="op">{</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Convert bytes to samples</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> samples<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>IQSample<span class="op">&gt;</span> <span class="op">=</span> data<span class="op">.</span>chunks(<span class="dv">4</span>)</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>filter_map(<span class="op">|</span>chunk<span class="op">|</span> <span class="op">{</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> chunk<span class="op">.</span>len() <span class="op">&lt;</span> <span class="dv">4</span> <span class="op">{</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">None</span><span class="op">;</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> i <span class="op">=</span> <span class="dt">i16</span><span class="pp">::</span>from_le_bytes([chunk[<span class="dv">0</span>]<span class="op">,</span> chunk[<span class="dv">1</span>]]) <span class="kw">as</span> <span class="dt">f32</span> <span class="op">/</span> <span class="dv">32767.0</span><span class="op">;</span></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> q <span class="op">=</span> <span class="dt">i16</span><span class="pp">::</span>from_le_bytes([chunk[<span class="dv">2</span>]<span class="op">,</span> chunk[<span class="dv">3</span>]]) <span class="kw">as</span> <span class="dt">f32</span> <span class="op">/</span> <span class="dv">32767.0</span><span class="op">;</span></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Some</span>(<span class="pp">IQSample::</span>new(i<span class="op">,</span> q))</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span>)</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>collect()<span class="op">;</span></span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Some</span>(waveform) <span class="op">=</span> <span class="pp">WaveformFactory::</span>create(<span class="st">&quot;QPSK&quot;</span><span class="op">,</span> <span class="dv">48000.0</span>) <span class="op">{</span></span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Should not panic or crash</span></span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> _ <span class="op">=</span> waveform<span class="op">.</span>demodulate(<span class="op">&amp;</span>samples)<span class="op">;</span></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>)<span class="op">;</span></span></code></pre></div>
    <hr />
    <h2 id="fpga-acceleration">FPGA Acceleration</h2>
    <h3 id="using-the-fpgaaccelerator-trait">Using the FpgaAccelerator
    Trait</h3>
    <div class="sourceCode" id="cb44"><pre
    class="sourceCode rust"><code class="sourceCode rust"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">r4w_fpga::</span><span class="op">{</span>FpgaAccelerator<span class="op">,</span> ZynqFpga<span class="op">,</span> SimulatedFpga<span class="op">};</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> create_accelerator() <span class="op">-&gt;</span> <span class="dt">Box</span><span class="op">&lt;</span><span class="kw">dyn</span> FpgaAccelerator<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Try real hardware first, fall back to simulation</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">match</span> <span class="pp">ZynqFpga::</span>auto_detect() <span class="op">{</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(fpga) <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>            <span class="pp">println!</span>(<span class="st">&quot;Using Zynq FPGA: {:?}&quot;</span><span class="op">,</span> fpga<span class="op">.</span>info())<span class="op">;</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Box</span><span class="pp">::</span>new(fpga)</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Err</span>(e) <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>            <span class="pp">println!</span>(<span class="st">&quot;FPGA not available ({}), using simulation&quot;</span><span class="op">,</span> e)<span class="op">;</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Box</span><span class="pp">::</span>new(<span class="pp">SimulatedFpga::</span>new())</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> process_with_acceleration(</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>    fpga<span class="op">:</span> <span class="op">&amp;</span><span class="kw">dyn</span> FpgaAccelerator<span class="op">,</span></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>    samples<span class="op">:</span> <span class="op">&amp;</span>[IQSample]<span class="op">,</span></span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="dt">Vec</span><span class="op">&lt;</span>IQSample<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> caps <span class="op">=</span> fpga<span class="op">.</span>capabilities()<span class="op">;</span></span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Use hardware FFT if available and large enough</span></span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> samples<span class="op">.</span>len() <span class="op">&lt;=</span> caps<span class="op">.</span>max_fft_size <span class="op">{</span></span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">match</span> fpga<span class="op">.</span>fft(samples<span class="op">,</span> <span class="cn">false</span>) <span class="op">{</span></span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(result) <span class="op">=&gt;</span> <span class="cf">return</span> result<span class="op">,</span></span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Err</span>(e) <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>                <span class="pp">println!</span>(<span class="st">&quot;FPGA FFT failed: {}, using software&quot;</span><span class="op">,</span> e)<span class="op">;</span></span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Fall back to software</span></span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a>    software_fft(samples)</span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <h3 id="fpga-accelerated-waveform">FPGA-Accelerated Waveform</h3>
    <div class="sourceCode" id="cb45"><pre
    class="sourceCode rust"><code class="sourceCode rust"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// Waveform that automatically uses FPGA when available</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> AcceleratedLoRa <span class="op">{</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    software<span class="op">:</span> LoRaWaveform<span class="op">,</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    fpga<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">Box</span><span class="op">&lt;</span><span class="kw">dyn</span> FpgaAccelerator<span class="op">&gt;&gt;,</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> AcceleratedLoRa <span class="op">{</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> new(sample_rate<span class="op">:</span> <span class="dt">f64</span>) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> fpga <span class="op">=</span> <span class="pp">ZynqFpga::</span>auto_detect()<span class="op">.</span>ok()<span class="op">.</span>map(<span class="op">|</span>f<span class="op">|</span> <span class="dt">Box</span><span class="pp">::</span>new(f) <span class="kw">as</span> _)<span class="op">;</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>            software<span class="op">:</span> <span class="pp">LoRaWaveform::</span>new(sample_rate)<span class="op">,</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>            fpga<span class="op">,</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> Waveform <span class="cf">for</span> AcceleratedLoRa <span class="op">{</span></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> modulate(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> bits<span class="op">:</span> <span class="op">&amp;</span>[<span class="dt">bool</span>]) <span class="op">-&gt;</span> <span class="dt">Vec</span><span class="op">&lt;</span>IQSample<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Some</span>(<span class="kw">ref</span> fpga) <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>fpga <span class="op">{</span></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Some</span>(waveform_id) <span class="op">=</span> fpga<span class="op">.</span>waveform_id(<span class="st">&quot;LoRa&quot;</span>) <span class="op">{</span></span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Ok</span>(samples) <span class="op">=</span> fpga<span class="op">.</span>modulate(waveform_id<span class="op">,</span> bits) <span class="op">{</span></span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> samples<span class="op">;</span></span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>software<span class="op">.</span>modulate(bits)</span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> demodulate(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> samples<span class="op">:</span> <span class="op">&amp;</span>[IQSample]) <span class="op">-&gt;</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">bool</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Some</span>(<span class="kw">ref</span> fpga) <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>fpga <span class="op">{</span></span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Some</span>(waveform_id) <span class="op">=</span> fpga<span class="op">.</span>waveform_id(<span class="st">&quot;LoRa&quot;</span>) <span class="op">{</span></span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Ok</span>(bits) <span class="op">=</span> fpga<span class="op">.</span>demodulate(waveform_id<span class="op">,</span> samples) <span class="op">{</span></span>
<span id="cb45-33"><a href="#cb45-33" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> bits<span class="op">;</span></span>
<span id="cb45-34"><a href="#cb45-34" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb45-35"><a href="#cb45-35" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb45-36"><a href="#cb45-36" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb45-37"><a href="#cb45-37" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>software<span class="op">.</span>demodulate(samples)</span>
<span id="cb45-38"><a href="#cb45-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb45-39"><a href="#cb45-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-40"><a href="#cb45-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Delegate other methods to software implementation</span></span>
<span id="cb45-41"><a href="#cb45-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> info(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> WaveformInfo <span class="op">{</span> <span class="kw">self</span><span class="op">.</span>software<span class="op">.</span>info() <span class="op">}</span></span>
<span id="cb45-42"><a href="#cb45-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> constellation_points(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Vec</span><span class="op">&lt;</span>IQSample<span class="op">&gt;</span> <span class="op">{</span> <span class="kw">self</span><span class="op">.</span>software<span class="op">.</span>constellation_points() <span class="op">}</span></span>
<span id="cb45-43"><a href="#cb45-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> get_modulation_stages(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> bits<span class="op">:</span> <span class="op">&amp;</span>[<span class="dt">bool</span>]) <span class="op">-&gt;</span> <span class="dt">Vec</span><span class="op">&lt;</span>ModulationStage<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb45-44"><a href="#cb45-44" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>software<span class="op">.</span>get_modulation_stages(bits)</span>
<span id="cb45-45"><a href="#cb45-45" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb45-46"><a href="#cb45-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> get_demodulation_steps(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> samples<span class="op">:</span> <span class="op">&amp;</span>[IQSample]) <span class="op">-&gt;</span> <span class="dt">Vec</span><span class="op">&lt;</span>DemodulationStep<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb45-47"><a href="#cb45-47" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>software<span class="op">.</span>get_demodulation_steps(samples)</span>
<span id="cb45-48"><a href="#cb45-48" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb45-49"><a href="#cb45-49" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <hr />
    <h2 id="security-considerations">Security Considerations</h2>
    <p>For detailed security guidance, see the <a
    href="./SECURITY_GUIDE.md">Security Guide</a>.</p>
    <h3 id="key-security-principles">Key Security Principles</h3>
    <ol type="1">
    <li><strong>Memory Safety</strong>: Rust’s ownership system prevents
    buffer overflows</li>
    <li><strong>Input Validation</strong>: Always validate sample counts
    and parameters</li>
    <li><strong>Zeroization</strong>: Clear sensitive data (keys,
    TRANSEC) from memory</li>
    <li><strong>Isolation</strong>: Use process isolation for classified
    components</li>
    <li><strong>Audit Logging</strong>: Log security-relevant
    events</li>
    </ol>
    <h3 id="secure-memory-handling">Secure Memory Handling</h3>
    <div class="sourceCode" id="cb46"><pre
    class="sourceCode rust"><code class="sourceCode rust"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">zeroize::</span>Zeroize<span class="op">;</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// Key material that is automatically zeroized on drop</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span>Zeroize<span class="at">)]</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>zeroize<span class="at">(</span>drop<span class="at">)]</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> TransecKey <span class="op">{</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>    key_data<span class="op">:</span> [<span class="dt">u8</span><span class="op">;</span> <span class="dv">32</span>]<span class="op">,</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> TransecKey <span class="op">{</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> from_bytes(bytes<span class="op">:</span> <span class="op">&amp;</span>[<span class="dt">u8</span>]) <span class="op">-&gt;</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">Self</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> bytes<span class="op">.</span>len() <span class="op">!=</span> <span class="dv">32</span> <span class="op">{</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">None</span><span class="op">;</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> key_data <span class="op">=</span> [<span class="dv">0u8</span><span class="op">;</span> <span class="dv">32</span>]<span class="op">;</span></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>        key_data<span class="op">.</span>copy_from_slice(bytes)<span class="op">;</span></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Some</span>(<span class="dt">Self</span> <span class="op">{</span> key_data <span class="op">}</span>)</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <h3 id="input-validation">Input Validation</h3>
    <div class="sourceCode" id="cb47"><pre
    class="sourceCode rust"><code class="sourceCode rust"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> validate_samples(samples<span class="op">:</span> <span class="op">&amp;</span>[IQSample]) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> ValidationError<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check for NaN or Inf</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i<span class="op">,</span> sample) <span class="kw">in</span> samples<span class="op">.</span>iter()<span class="op">.</span>enumerate() <span class="op">{</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">!</span>sample<span class="op">.</span>i<span class="op">.</span>is_finite() <span class="op">||</span> <span class="op">!</span>sample<span class="op">.</span>q<span class="op">.</span>is_finite() <span class="op">{</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="pp">ValidationError::</span>InvalidSample <span class="op">{</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>                index<span class="op">:</span> i<span class="op">,</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>                i<span class="op">:</span> sample<span class="op">.</span>i<span class="op">,</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>                q<span class="op">:</span> sample<span class="op">.</span>q<span class="op">,</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check for unreasonable magnitudes</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> mag <span class="op">=</span> sample<span class="op">.</span>magnitude()<span class="op">;</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> mag <span class="op">&gt;</span> <span class="dv">100.0</span> <span class="op">{</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="pp">ValidationError::</span>MagnitudeTooLarge <span class="op">{</span></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>                index<span class="op">:</span> i<span class="op">,</span></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>                magnitude<span class="op">:</span> mag<span class="op">,</span></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Ok</span>(())</span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <hr />
    <h2 id="appendix-a-quick-reference">Appendix A: Quick Reference</h2>
    <h3 id="common-commands">Common Commands</h3>
    <div class="sourceCode" id="cb48"><pre
    class="sourceCode bash"><code class="sourceCode bash"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Build</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> build <span class="at">--release</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Test</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> test</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> test <span class="at">--release</span>  <span class="co"># Test optimized build</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Benchmark</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> bench</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Run CLI</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> run <span class="at">--bin</span> r4w <span class="at">--</span> <span class="at">--help</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> run <span class="at">--bin</span> r4w <span class="at">--</span> waveform <span class="at">--list</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> run <span class="at">--bin</span> r4w <span class="at">--</span> simulate <span class="at">--waveform</span> QPSK <span class="at">--snr</span> 10</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Run GUI</span></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> run <span class="at">--bin</span> r4w-explorer</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Cross-compile</span></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> build <span class="at">--release</span> <span class="at">--target</span> aarch64-unknown-linux-gnu</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Profile</span></span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> flamegraph <span class="at">--bin</span> r4w <span class="at">--</span> simulate <span class="at">--duration</span> 10</span></code></pre></div>
    <h3 id="performance-targets">Performance Targets</h3>
    <table>
    <thead>
    <tr class="header">
    <th>Operation</th>
    <th>Target</th>
    <th>Platform</th>
    </tr>
    </thead>
    <tbody>
    <tr class="odd">
    <td>PSK modulation</td>
    <td>&gt;10 Msps</td>
    <td>x86_64</td>
    </tr>
    <tr class="even">
    <td>PSK demodulation</td>
    <td>&gt;5 Msps</td>
    <td>x86_64</td>
    </tr>
    <tr class="odd">
    <td>LoRa modulation</td>
    <td>&gt;1 Msps</td>
    <td>x86_64</td>
    </tr>
    <tr class="even">
    <td>LoRa demodulation</td>
    <td>&gt;500 ksps</td>
    <td>x86_64</td>
    </tr>
    <tr class="odd">
    <td>FFT (1024 pt)</td>
    <td>&lt;50 μs</td>
    <td>x86_64</td>
    </tr>
    <tr class="even">
    <td>Single symbol latency</td>
    <td>&lt;100 μs</td>
    <td>ARM64</td>
    </tr>
    </tbody>
    </table>
    <h3 id="memory-estimates">Memory Estimates</h3>
    <table>
    <thead>
    <tr class="header">
    <th>Component</th>
    <th>Memory</th>
    </tr>
    </thead>
    <tbody>
    <tr class="odd">
    <td>Base runtime</td>
    <td>~10 MB</td>
    </tr>
    <tr class="even">
    <td>Per waveform instance</td>
    <td>~1 MB</td>
    </tr>
    <tr class="odd">
    <td>FFT (1024 pt) buffers</td>
    <td>~64 KB</td>
    </tr>
    <tr class="even">
    <td>Sample buffer (1 sec @ 1 Msps)</td>
    <td>~8 MB</td>
    </tr>
    <tr class="odd">
    <td>GUI application</td>
    <td>~50 MB</td>
    </tr>
    </tbody>
    </table>
    <hr />
    <h2 id="appendix-b-troubleshooting">Appendix B: Troubleshooting</h2>
    <table>
    <thead>
    <tr class="header">
    <th>Issue</th>
    <th>Cause</th>
    <th>Solution</th>
    </tr>
    </thead>
    <tbody>
    <tr class="odd">
    <td>Poor BER</td>
    <td>Low SNR or sync issues</td>
    <td>Check channel, add preamble</td>
    </tr>
    <tr class="even">
    <td>High latency</td>
    <td>Allocations in hot path</td>
    <td>Pre-allocate buffers</td>
    </tr>
    <tr class="odd">
    <td>Memory growth</td>
    <td>Buffer leaks</td>
    <td>Use buffer pools</td>
    </tr>
    <tr class="even">
    <td>Cross-compile fails</td>
    <td>Missing linker</td>
    <td>Install cross toolchain</td>
    </tr>
    <tr class="odd">
    <td>FPGA not detected</td>
    <td>Permission denied</td>
    <td>Add user to <code>uio</code> group</td>
    </tr>
    <tr class="even">
    <td>Timing jitter</td>
    <td>System interrupts</td>
    <td>Use RT priority, CPU pinning</td>
    </tr>
    </tbody>
    </table>
    <hr />
    <p><em>For questions or contributions, please open an issue on the
    R4W GitHub repository.</em></p>
</body>
</html>
