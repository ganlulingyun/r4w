<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>R4W - isolation-guide</title>
  <style>
    html {
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: white;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">R4W - isolation-guide</h1>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#r4w-waveform-isolation-guide"
id="toc-r4w-waveform-isolation-guide">R4W Waveform Isolation Guide</a>
<ul>
<li><a href="#table-of-contents" id="toc-table-of-contents">Table of
Contents</a></li>
<li><a href="#overview" id="toc-overview">Overview</a>
<ul>
<li><a href="#why-waveform-isolation"
id="toc-why-waveform-isolation">Why Waveform Isolation?</a></li>
<li><a href="#isolation-spectrum" id="toc-isolation-spectrum">Isolation
Spectrum</a></li>
</ul></li>
<li><a href="#threat-model" id="toc-threat-model">Threat Model</a>
<ul>
<li><a href="#adversary-capabilities"
id="toc-adversary-capabilities">Adversary Capabilities</a></li>
<li><a href="#assets-to-protect" id="toc-assets-to-protect">Assets to
Protect</a></li>
</ul></li>
<li><a href="#isolation-levels" id="toc-isolation-levels">Isolation
Levels</a>
<ul>
<li><a href="#quick-reference" id="toc-quick-reference">Quick
Reference</a></li>
</ul></li>
<li><a href="#level-1-3-process-isolation"
id="toc-level-1-3-process-isolation">Level 1-3: Process Isolation</a>
<ul>
<li><a href="#architecture" id="toc-architecture">Architecture</a></li>
<li><a href="#r4w-sandbox-api" id="toc-r4w-sandbox-api">r4w-sandbox
API</a></li>
<li><a href="#seccomp-profile-for-dsp"
id="toc-seccomp-profile-for-dsp">Seccomp Profile for DSP</a></li>
<li><a href="#selinux-policy-module"
id="toc-selinux-policy-module">SELinux Policy Module</a></li>
</ul></li>
<li><a href="#level-1.5-webassembly-isolation"
id="toc-level-1.5-webassembly-isolation">Level 1.5: WebAssembly
Isolation</a>
<ul>
<li><a href="#architecture-1"
id="toc-architecture-1">Architecture</a></li>
<li><a href="#r4w-sandbox-wasm-api"
id="toc-r4w-sandbox-wasm-api">r4w-sandbox WASM API</a></li>
<li><a href="#wasi-capability-presets"
id="toc-wasi-capability-presets">WASI Capability Presets</a></li>
<li><a href="#benchmark-results-measured"
id="toc-benchmark-results-measured">Benchmark Results
(Measured)</a></li>
<li><a href="#understanding-the-wasm-call-trampoline"
id="toc-understanding-the-wasm-call-trampoline">Understanding the WASM
Call Trampoline</a></li>
<li><a href="#is-wasm-viable-for-production-waveforms"
id="toc-is-wasm-viable-for-production-waveforms">Is WASM Viable for
Production Waveforms?</a></li>
<li><a href="#hybrid-architecture-native-dsp-wasm-logic"
id="toc-hybrid-architecture-native-dsp-wasm-logic">Hybrid Architecture:
Native DSP + WASM Logic</a></li>
<li><a href="#summary-wasm-production-viability"
id="toc-summary-wasm-production-viability">Summary: WASM Production
Viability</a></li>
<li><a href="#trade-offs" id="toc-trade-offs">Trade-offs</a></li>
<li><a href="#when-to-use-wasm-isolation"
id="toc-when-to-use-wasm-isolation">When to Use WASM Isolation</a></li>
<li><a href="#compiling-waveforms-to-wasm"
id="toc-compiling-waveforms-to-wasm">Compiling Waveforms to
WASM</a></li>
<li><a href="#benchmark-example" id="toc-benchmark-example">Benchmark
Example</a></li>
</ul></li>
<li><a href="#level-4-5-container-isolation"
id="toc-level-4-5-container-isolation">Level 4-5: Container
Isolation</a>
<ul>
<li><a href="#docker-compose-for-multi-waveform-deployment"
id="toc-docker-compose-for-multi-waveform-deployment">Docker Compose for
Multi-Waveform Deployment</a></li>
<li><a href="#firecracker-microvm-level-5"
id="toc-firecracker-microvm-level-5">Firecracker MicroVM (Level
5)</a></li>
</ul></li>
<li><a href="#level-6-virtual-machine-isolation"
id="toc-level-6-virtual-machine-isolation">Level 6: Virtual Machine
Isolation</a>
<ul>
<li><a href="#kvmqemu-with-vfio-passthrough"
id="toc-kvmqemu-with-vfio-passthrough">KVM/QEMU with VFIO
Passthrough</a></li>
<li><a href="#libvirt-configuration"
id="toc-libvirt-configuration">libvirt Configuration</a></li>
</ul></li>
<li><a href="#level-7-hardware-isolation"
id="toc-level-7-hardware-isolation">Level 7: Hardware Isolation</a>
<ul>
<li><a href="#cpu-and-memory-isolation"
id="toc-cpu-and-memory-isolation">CPU and Memory Isolation</a></li>
<li><a href="#intel-cache-allocation-technology-cat"
id="toc-intel-cache-allocation-technology-cat">Intel Cache Allocation
Technology (CAT)</a></li>
<li><a href="#iommu-configuration-for-fpga"
id="toc-iommu-configuration-for-fpga">IOMMU Configuration for
FPGA</a></li>
</ul></li>
<li><a href="#level-8-air-gap-isolation"
id="toc-level-8-air-gap-isolation">Level 8: Air-Gap Isolation</a>
<ul>
<li><a href="#data-diode-architecture"
id="toc-data-diode-architecture">Data Diode Architecture</a></li>
</ul></li>
<li><a href="#fpga-isolation" id="toc-fpga-isolation">FPGA Isolation</a>
<ul>
<li><a href="#bitstream-partitioning"
id="toc-bitstream-partitioning">Bitstream Partitioning</a></li>
<li><a href="#axi-firewall-configuration"
id="toc-axi-firewall-configuration">AXI Firewall Configuration</a></li>
</ul></li>
<li><a href="#memory-protection" id="toc-memory-protection">Memory
Protection</a>
<ul>
<li><a href="#encrypted-memory-regions"
id="toc-encrypted-memory-regions">Encrypted Memory Regions</a></li>
<li><a href="#guard-pages" id="toc-guard-pages">Guard Pages</a></li>
</ul></li>
<li><a href="#cross-domain-solutions"
id="toc-cross-domain-solutions">Cross-Domain Solutions</a>
<ul>
<li><a href="#multi-level-security-architecture"
id="toc-multi-level-security-architecture">Multi-Level Security
Architecture</a></li>
</ul></li>
<li><a href="#implementation-guide"
id="toc-implementation-guide">Implementation Guide</a>
<ul>
<li><a href="#r4w-sandbox-crate-structure"
id="toc-r4w-sandbox-crate-structure">r4w-sandbox Crate
Structure</a></li>
<li><a href="#basic-usage" id="toc-basic-usage">Basic Usage</a></li>
</ul></li>
<li><a href="#deployment-configurations"
id="toc-deployment-configurations">Deployment Configurations</a>
<ul>
<li><a href="#development-l1-l2" id="toc-development-l1-l2">Development
(L1-L2)</a></li>
<li><a href="#production-single-tenant-l3"
id="toc-production-single-tenant-l3">Production Single-Tenant
(L3)</a></li>
<li><a href="#production-multi-tenant-l4"
id="toc-production-multi-tenant-l4">Production Multi-Tenant
(L4)</a></li>
<li><a href="#high-security-multi-tenant-l5"
id="toc-high-security-multi-tenant-l5">High-Security Multi-Tenant
(L5)</a></li>
<li><a href="#high-security-l6-l7"
id="toc-high-security-l6-l7">High-Security (L6-L7)</a></li>
</ul></li>
<li><a href="#references" id="toc-references">References</a></li>
</ul></li>
</ul>
</nav>
<h1 id="r4w-waveform-isolation-guide">R4W Waveform Isolation Guide</h1>
<p>This document provides comprehensive guidance for isolating waveforms
from each other in R4W deployments. It covers scenarios from basic
process separation to hardware-enforced isolation for multi-level
security (MLS) environments.</p>
<h2 id="table-of-contents">Table of Contents</h2>
<ol type="1">
<li><a href="#overview">Overview</a></li>
<li><a href="#threat-model">Threat Model</a></li>
<li><a href="#isolation-levels">Isolation Levels</a></li>
<li><a href="#level-1-3-process-isolation">Level 1-3: Process
Isolation</a></li>
<li><a href="#level-15-webassembly-isolation">Level 1.5: WebAssembly
Isolation</a></li>
<li><a href="#level-4-5-container-isolation">Level 4-5: Container
Isolation</a></li>
<li><a href="#level-6-virtual-machine-isolation">Level 6: Virtual
Machine Isolation</a></li>
<li><a href="#level-7-hardware-isolation">Level 7: Hardware
Isolation</a></li>
<li><a href="#level-8-air-gap-isolation">Level 8: Air-Gap
Isolation</a></li>
<li><a href="#fpga-isolation">FPGA Isolation</a></li>
<li><a href="#memory-protection">Memory Protection</a></li>
<li><a href="#cross-domain-solutions">Cross-Domain Solutions</a></li>
<li><a href="#implementation-guide">Implementation Guide</a></li>
<li><a href="#deployment-configurations">Deployment
Configurations</a></li>
</ol>
<hr />
<h2 id="overview">Overview</h2>
<h3 id="why-waveform-isolation">Why Waveform Isolation?</h3>
<p>In SDR systems processing multiple waveforms, several security
concerns arise:</p>
<pre><code>┌─────────────────────────────────────────────────────────────────────────────┐
│                    Multi-Waveform Security Concerns                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. Data Leakage                                                            │
│     • Encrypted traffic mixed with unencrypted                              │
│     • Classified waveform data accessible to unclassified processes         │
│     • I/Q samples from one waveform visible to another                      │
│                                                                             │
│  2. Cross-Contamination                                                     │
│     • Bug in one waveform affecting others                                  │
│     • Malicious waveform attacking system                                   │
│     • Resource exhaustion (CPU, memory, FPGA)                               │
│                                                                             │
│  3. Covert Channels                                                         │
│     • Timing side-channels between waveforms                                │
│     • Cache-based information leakage                                       │
│     • Shared resource contention as communication                           │
│                                                                             │
│  4. Privilege Escalation                                                    │
│     • Low-security waveform gaining access to high-security resources       │
│     • FPGA reconfiguration attacks                                          │
│     • Key material exposure                                                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="isolation-spectrum">Isolation Spectrum</h3>
<pre><code>┌─────────────────────────────────────────────────────────────────────────────┐
│                         Isolation Level Spectrum                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Overhead ──────────────────────────────────────────────────────► Security  │
│  (Low)                                                              (High)  │
│                                                                             │
│  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐   │
│  │ L1  │ │L1.5 │ │ L2  │ │ L3  │ │ L4  │ │ L5  │ │ L6  │ │ L7  │ │ L8  │   │
│  │     │ │     │ │     │ │     │ │     │ │     │ │     │ │     │ │     │   │
│  │Proc │ │WASM │ │ NS  │ │LSM  │ │Cont │ │uVM  │ │ VM  │ │ HW  │ │ Air │   │
│  │     │ │     │ │     │ │     │ │     │ │     │ │     │ │     │ │ Gap │   │
│  └─────┘ └─────┘ └─────┘ └─────┘ └─────┘ └─────┘ └─────┘ └─────┘ └─────┘   │
│                                                                             │
│  L1:   Process        - Separate processes, shared kernel                   │
│  L1.5: WebAssembly    - WASM sandbox with WASI capability control           │
│  L2:   Namespace      - + Linux namespaces (pid, net, mount, user)          │
│  L3:   LSM            - + seccomp + SELinux/AppArmor                        │
│  L4:   Container      - Docker/Podman with security profiles                │
│  L5:   MicroVM        - Firecracker/gVisor (lightweight VMs)                │
│  L6:   Full VM        - KVM/QEMU with dedicated resources                   │
│  L7:   Hardware       - CPU pinning + IOMMU + memory encryption             │
│  L8:   Air Gap        - Physically separate systems with data diodes        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="threat-model">Threat Model</h2>
<h3 id="adversary-capabilities">Adversary Capabilities</h3>
<table>
<colgroup>
<col style="width: 35%" />
<col style="width: 28%" />
<col style="width: 35%" />
</colgroup>
<thead>
<tr class="header">
<th>Threat Level</th>
<th>Adversary</th>
<th>Capabilities</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>T1</strong></td>
<td>Buggy Waveform</td>
<td>Unintentional memory corruption, resource exhaustion</td>
</tr>
<tr class="even">
<td><strong>T2</strong></td>
<td>Malicious User</td>
<td>Intentional attacks within waveform code</td>
</tr>
<tr class="odd">
<td><strong>T3</strong></td>
<td>Sophisticated</td>
<td>Side-channel attacks, timing analysis</td>
</tr>
<tr class="even">
<td><strong>T4</strong></td>
<td>Nation State</td>
<td>Hardware attacks, supply chain compromise</td>
</tr>
</tbody>
</table>
<h3 id="assets-to-protect">Assets to Protect</h3>
<pre><code>┌─────────────────────────────────────────────────────────────────┐
│                      Asset Classification                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Critical (must never leak)                                     │
│  ├── Cryptographic keys (TRANSEC, COMSEC)                       │
│  ├── Classified message content                                 │
│  └── Frequency hopping sequences                                │
│                                                                 │
│  Sensitive (controlled access)                                  │
│  ├── Waveform parameters and configurations                     │
│  ├── Network topology and routing                               │
│  └── User credentials and certificates                          │
│                                                                 │
│  Operational (availability matters)                             │
│  ├── I/Q sample streams                                         │
│  ├── Timing synchronization                                     │
│  └── System health metrics                                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="isolation-levels">Isolation Levels</h2>
<h3 id="quick-reference">Quick Reference</h3>
<table>
<thead>
<tr class="header">
<th>Level</th>
<th>Mechanism</th>
<th>Use Case</th>
<th>Latency Impact</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>L1</td>
<td>Process</td>
<td>Development, testing</td>
<td>~0%</td>
</tr>
<tr class="even">
<td>L1.5</td>
<td>WebAssembly</td>
<td>Plugin isolation, portability</td>
<td>10-50%</td>
</tr>
<tr class="odd">
<td>L2</td>
<td>Namespace</td>
<td>Multi-tenant non-critical</td>
<td>~0%</td>
</tr>
<tr class="even">
<td>L3</td>
<td>LSM</td>
<td>Production single-security</td>
<td>&lt;1%</td>
</tr>
<tr class="odd">
<td>L4</td>
<td>Container</td>
<td>Multi-tenant production</td>
<td>1-5%</td>
</tr>
<tr class="even">
<td>L5</td>
<td>MicroVM</td>
<td>High-security multi-tenant</td>
<td>5-10%</td>
</tr>
<tr class="odd">
<td>L6</td>
<td>Full VM</td>
<td>MLS environments</td>
<td>10-20%</td>
</tr>
<tr class="even">
<td>L7</td>
<td>Hardware</td>
<td>Critical infrastructure</td>
<td>20-50%</td>
</tr>
<tr class="odd">
<td>L8</td>
<td>Air Gap</td>
<td>Absolute separation</td>
<td>N/A</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="level-1-3-process-isolation">Level 1-3: Process Isolation</h2>
<h3 id="architecture">Architecture</h3>
<pre><code>┌────────────────────────────────────────────────────────────────────────────┐
│                    Process-Level Isolation (L1-L3)                         │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         Linux Kernel                                │   │
│  │  ┌──────────────────────────────────────────────────────────────┐   │   │
│  │  │                    Security Modules                          │   │   │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐   │   │   │
│  │  │  │  seccomp    │  │  SELinux    │  │     AppArmor        │   │   │   │
│  │  │  │  BPF filter │  │  MAC policy │  │   Path-based MAC    │   │   │   │
│  │  │  └─────────────┘  └─────────────┘  └─────────────────────┘   │   │   │
│  │  └──────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                            │
│  ┌──────────────┐   ┌──────────────┐   ┌──────────────┐                    │
│  │  Waveform A  │   │  Waveform B  │   │  Waveform C  │                    │
│  │              │   │              │   │              │                    │
│  │ PID NS: 1000 │   │ PID NS: 2000 │   │ PID NS: 3000 │                    │
│  │ NET NS: wf-a │   │ NET NS: wf-b │   │ NET NS: wf-c │                    │
│  │ User: wf-a   │   │ User: wf-b   │   │ User: wf-c   │                    │
│  │              │   │              │   │              │                    │
│  │ seccomp: dsp │   │ seccomp: dsp │   │ seccomp: dsp │                    │
│  │ caps: NICE   │   │ caps: NICE   │   │ caps: NICE   │                    │
│  └──────────────┘   └──────────────┘   └──────────────┘                    │
│         │                  │                  │                            │
│         └─────────────────┬┴──────────────────┘                            │
│                           │                                                │
│                    ┌──────▼──────┐                                         │
│                    │   Control   │                                         │
│                    │   Process   │                                         │
│                    │ (r4w-ctl)   │                                         │
│                    └─────────────┘                                         │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="r4w-sandbox-api">r4w-sandbox API</h3>
<div class="sourceCode" id="cb5"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">r4w_sandbox::</span><span class="op">{</span>Sandbox<span class="op">,</span> IsolationLevel<span class="op">,</span> WaveformConfig<span class="op">};</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Create sandbox for a waveform</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> sandbox <span class="op">=</span> <span class="pp">Sandbox::</span>builder()</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>isolation_level(<span class="pp">IsolationLevel::</span>L3_LSM)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>waveform(<span class="st">&quot;BPSK&quot;</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>user(<span class="st">&quot;wf-bpsk&quot;</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>namespaces(<span class="pp">Namespaces::</span>PID <span class="op">|</span> <span class="pp">Namespaces::</span>NET <span class="op">|</span> <span class="pp">Namespaces::</span>MOUNT)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>seccomp_profile(<span class="pp">SeccompProfile::</span>DSP)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>capabilities(<span class="op">&amp;</span>[<span class="pp">Capability::</span>SYS_NICE<span class="op">,</span> <span class="pp">Capability::</span>IPC_LOCK])</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>memory_limit(<span class="dv">512</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>)  <span class="co">// 512 MB</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>cpu_quota(<span class="dv">200</span>)  <span class="co">// 200% = 2 cores</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>build()<span class="op">?;</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Spawn isolated waveform process</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> handle <span class="op">=</span> sandbox<span class="op">.</span>spawn(<span class="op">||</span> <span class="op">{</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// This runs in isolated context</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> waveform <span class="op">=</span> <span class="pp">Bpsk::</span>new(<span class="dv">48000.0</span>)<span class="op">;</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    waveform<span class="op">.</span>run_loop()</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>)<span class="op">?;</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="co">// IPC between control and waveform</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>sandbox<span class="op">.</span>send_command(<span class="pp">Command::</span>SetFrequency(<span class="dv">915_000_000</span>))<span class="op">?;</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> status <span class="op">=</span> sandbox<span class="op">.</span>recv_status()<span class="op">?;</span></span></code></pre></div>
<h3 id="seccomp-profile-for-dsp">Seccomp Profile for DSP</h3>
<div class="sourceCode" id="cb6"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// Minimal syscall allowlist for DSP processing</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> dsp_seccomp_profile() <span class="op">-&gt;</span> SeccompProfile <span class="op">{</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="pp">SeccompProfile::</span>new()</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Memory operations (required for signal processing)</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_mmap)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_munmap)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_mprotect)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_mlock)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_madvise)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Basic I/O (for IPC with control process)</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_read)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_write)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_close)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_recvmsg)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_sendmsg)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Shared memory (for sample transfer)</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_shmat)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_shmget)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_shmdt)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_shmctl)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Time (for real-time scheduling)</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_clock_gettime)</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_clock_nanosleep)</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_nanosleep)</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Thread operations</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_futex)</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_clone)  <span class="co">// Restricted to CLONE_THREAD only</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">// FPGA access (restricted paths)</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow_with_args(SYS_openat<span class="op">,</span> <span class="op">|</span>args<span class="op">|</span> <span class="op">{</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Only allow /dev/uio* and /dev/mem</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>            args<span class="op">.</span>path_matches(<span class="st">&quot;/dev/uio*&quot;</span>) <span class="op">||</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>            args<span class="op">.</span>path_matches(<span class="st">&quot;/dev/mem&quot;</span>)</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span>)</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>allow(SYS_ioctl)  <span class="co">// For UIO</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Default: kill process on violation</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>default_action(<span class="pp">SeccompAction::</span>Kill)</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="selinux-policy-module">SELinux Policy Module</h3>
<pre><code># r4w_waveform.te - SELinux Type Enforcement for R4W Waveforms

policy_module(r4w_waveform, 1.0.0)

# Define types for each security level
type r4w_unclass_t;      # Unclassified waveforms
type r4w_secret_t;       # Secret waveforms
type r4w_topsecret_t;    # Top Secret waveforms
type r4w_control_t;      # Control process

# File contexts
type r4w_samples_t;      # I/Q sample files
type r4w_keys_t;         # Cryptographic keys
type r4w_config_t;       # Configuration files

# Domain transitions
domain_auto_trans(r4w_control_t, r4w_unclass_exec_t, r4w_unclass_t)
domain_auto_trans(r4w_control_t, r4w_secret_exec_t, r4w_secret_t)

# Isolation rules - prevent cross-level access
neverallow r4w_unclass_t r4w_secret_t:process signal;
neverallow r4w_unclass_t r4w_topsecret_t:process signal;
neverallow r4w_secret_t r4w_topsecret_t:process signal;

# Prevent reading higher classification samples
neverallow r4w_unclass_t { r4w_secret_t r4w_topsecret_t }:shm { read write };

# Key material access
allow r4w_secret_t r4w_keys_t:file { read };
neverallow r4w_unclass_t r4w_keys_t:file *;

# FPGA access controlled by classification
allow r4w_topsecret_t fpga_device_t:chr_file { read write ioctl };
allow r4w_secret_t fpga_device_t:chr_file { read write ioctl };
neverallow r4w_unclass_t fpga_device_t:chr_file *;</code></pre>
<hr />
<h2 id="level-1.5-webassembly-isolation">Level 1.5: WebAssembly
Isolation</h2>
<p>WebAssembly (WASM) provides a lightweight isolation mechanism that
sits between basic process isolation and Linux namespaces. It’s
particularly well-suited for:</p>
<ul>
<li><strong>Plugin/waveform isolation</strong>: Run untrusted waveform
code safely</li>
<li><strong>Portable deployment</strong>: Same binary runs on any
platform</li>
<li><strong>Fast cold-start</strong>: ~10-15x faster than
containers</li>
<li><strong>Capability-based security</strong>: Deny-by-default via
WASI</li>
</ul>
<h3 id="architecture-1">Architecture</h3>
<pre><code>┌────────────────────────────────────────────────────────────────────────────┐
│                    WebAssembly Isolation (L1.5)                            │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         Host Process                                │   │
│  │  ┌───────────────────────────────────────────────────────────────┐  │   │
│  │  │                     Wasmtime Runtime                          │  │   │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐    │  │   │
│  │  │  │  Waveform A │  │  Waveform B │  │    Waveform C       │    │  │   │
│  │  │  │  (WASM)     │  │  (WASM)     │  │    (WASM)           │    │  │   │
│  │  │  │             │  │             │  │                     │    │  │   │
│  │  │  │ Linear Mem  │  │ Linear Mem  │  │   Linear Memory     │    │  │   │
│  │  │  │ (isolated)  │  │ (isolated)  │  │   (isolated)        │    │  │   │
│  │  │  └─────────────┘  └─────────────┘  └─────────────────────┘    │  │   │
│  │  │                                                               │  │   │
│  │  │  WASI Capabilities (per-module):                              │  │   │
│  │  │  • stdio: stdout/stderr for logging                           │  │   │
│  │  │  • clocks: timing for DSP                                     │  │   │
│  │  │  • random: crypto operations                                  │  │   │
│  │  │  • filesystem: DENIED                                         │  │   │
│  │  │  • network: DENIED                                            │  │   │
│  │  │  • env vars: DENIED                                           │  │   │
│  │  └───────────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="r4w-sandbox-wasm-api">r4w-sandbox WASM API</h3>
<div class="sourceCode" id="cb9"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">r4w_sandbox::</span><span class="op">{</span>WasmSandbox<span class="op">,</span> WasmConfig<span class="op">,</span> WasiCapabilities<span class="op">};</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Create sandbox with DSP-appropriate capabilities</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> config <span class="op">=</span> <span class="pp">WasmConfig::</span>dsp()</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>max_memory(<span class="dv">512</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>)  <span class="co">// 512 MB for sample buffers</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>fuel_limit(<span class="dv">10_000_000_000</span>)<span class="op">;</span>     <span class="co">// Limit execution time</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> sandbox <span class="op">=</span> <span class="pp">WasmSandbox::</span>new(config)<span class="op">?;</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Load waveform compiled to WASM</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> module <span class="op">=</span> sandbox<span class="op">.</span>load_module(<span class="st">&quot;waveforms/bpsk.wasm&quot;</span>)<span class="op">?;</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="kw">mut</span> instance <span class="op">=</span> sandbox<span class="op">.</span>instantiate(<span class="op">&amp;</span>module)<span class="op">?;</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Call waveform functions</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> result <span class="op">=</span> instance<span class="op">.</span>call_i32(<span class="st">&quot;modulate&quot;</span>)<span class="op">?;</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="pp">println!</span>(<span class="st">&quot;Executed in {}us, consumed {} fuel&quot;</span><span class="op">,</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    result<span class="op">.</span>execution_time_us<span class="op">,</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    result<span class="op">.</span>fuel_consumed<span class="op">.</span>unwrap_or(<span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="co">// Direct memory access for sample buffers</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>instance<span class="op">.</span>write_memory(<span class="dv">0x1000</span><span class="op">,</span> <span class="op">&amp;</span>samples)<span class="op">?;</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> output <span class="op">=</span> instance<span class="op">.</span>read_memory(<span class="dv">0x2000</span><span class="op">,</span> output_len)<span class="op">?;</span></span></code></pre></div>
<h3 id="wasi-capability-presets">WASI Capability Presets</h3>
<div class="sourceCode" id="cb10"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Maximum isolation - no capabilities</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> caps <span class="op">=</span> <span class="pp">WasiCapabilities::</span>none()<span class="op">;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">// DSP workloads - stdout/stderr for logging, clocks for timing</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> caps <span class="op">=</span> <span class="pp">WasiCapabilities::</span>dsp()<span class="op">;</span>  <span class="co">// Recommended for waveforms</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Development - full stdio for debugging</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> caps <span class="op">=</span> <span class="pp">WasiCapabilities::</span>with_stdio()<span class="op">;</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Custom capabilities</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> caps <span class="op">=</span> <span class="pp">WasiCapabilities::</span>none()</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>stdout(<span class="cn">true</span>)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>stderr(<span class="cn">true</span>)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>clocks(<span class="cn">true</span>)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>random(<span class="cn">true</span>)  <span class="co">// For crypto operations</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>preopened_dir_ro(<span class="st">&quot;/data/samples&quot;</span>)<span class="op">;</span>  <span class="co">// Read-only sample files</span></span></code></pre></div>
<h3 id="benchmark-results-measured">Benchmark Results (Measured)</h3>
<p>The following benchmarks were measured on an x86_64 Linux system
using release builds:</p>
<h4 id="startup-costs">Startup Costs</h4>
<table>
<thead>
<tr class="header">
<th>Operation</th>
<th>Time</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Module loading</td>
<td>~9ms</td>
<td>One-time cost per module</td>
</tr>
<tr class="even">
<td>Instantiation</td>
<td>~70μs</td>
<td>Per-instance cost</td>
</tr>
<tr class="odd">
<td>Total cold start</td>
<td>&lt;10ms</td>
<td>Module load + instantiate</td>
</tr>
</tbody>
</table>
<h4 id="function-call-overhead">Function Call Overhead</h4>
<table>
<thead>
<tr class="header">
<th>Signature</th>
<th>Latency</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>() -&gt; i32</code></td>
<td>&lt;1μs</td>
<td>Simple getters</td>
</tr>
<tr class="even">
<td><code>(i32) -&gt; i32</code></td>
<td>&lt;1μs</td>
<td>Single-arg functions</td>
</tr>
<tr class="odd">
<td><code>(i32, i32) -&gt; i32</code></td>
<td>&lt;1μs</td>
<td>Two-arg functions</td>
</tr>
<tr class="even">
<td>DSP function (modulate)</td>
<td>~0.2μs</td>
<td>Includes memory allocation</td>
</tr>
</tbody>
</table>
<h4 id="memory-operations">Memory Operations</h4>
<table>
<thead>
<tr class="header">
<th>Operation</th>
<th>Throughput</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Memory read</td>
<td>80 GB/s</td>
<td>Host reading WASM memory</td>
</tr>
<tr class="even">
<td>Memory write</td>
<td>48 GB/s</td>
<td>Host writing WASM memory</td>
</tr>
<tr class="odd">
<td>alloc(64 bytes)</td>
<td>~380ns</td>
<td>In-WASM allocation</td>
</tr>
<tr class="even">
<td>alloc(4KB)</td>
<td>~2μs</td>
<td>Larger allocations</td>
</tr>
</tbody>
</table>
<h4 id="dsp-performance">DSP Performance</h4>
<table>
<thead>
<tr class="header">
<th>Metric</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Symbol rate</td>
<td>650k symbols/sec</td>
</tr>
<tr class="even">
<td>Sample throughput</td>
<td>400 Msamples/sec</td>
</tr>
<tr class="odd">
<td>BPSK modulation</td>
<td>1.5ms / 1000 bits</td>
</tr>
</tbody>
</table>
<h4 id="native-vs-wasm-comparison">Native vs WASM Comparison</h4>
<table>
<thead>
<tr class="header">
<th>Operation</th>
<th>Native</th>
<th>WASM</th>
<th>Overhead</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Simple <code>add(a,b)</code></td>
<td>1ns</td>
<td>302ns</td>
<td><strong>300x</strong></td>
</tr>
<tr class="even">
<td>BPSK modulate</td>
<td>0.5μs</td>
<td>1.6μs</td>
<td><strong>2.8x</strong></td>
</tr>
</tbody>
</table>
<p><strong>Key Insight</strong>: The 300x overhead on trivial operations
is due to the WASM call trampoline. For real DSP work where computation
dominates, overhead drops to 2.8x because actual work amortizes the call
cost.</p>
<h3 id="understanding-the-wasm-call-trampoline">Understanding the WASM
Call Trampoline</h3>
<p>The 300x overhead for simple operations like <code>add(a, b)</code>
is not a bug or inefficiency—it’s an inherent cost of the isolation
boundary. Understanding this is critical for designing WASM-based
systems.</p>
<h4 id="what-is-the-call-trampoline">What is the Call Trampoline?</h4>
<p>When the host calls a WASM function, the runtime must perform several
steps:</p>
<pre><code>Host Code                     WASM Sandbox
    │                              │
    │  1. Marshal arguments        │
    │  ─────────────────────►      │
    │                              │
    │  2. Validate types           │
    │  ─────────────────────►      │
    │                              │
    │  3. Set up WASM stack        │
    │  ─────────────────────►      │
    │                              │
    │  4. Bounds check setup       │
    │  ─────────────────────►      │
    │                              │
    │  5. Context switch           │
    │  ═══════════════════════►    │
    │                              │  ← WASM code executes here
    │  6. Context switch back      │
    │  ◄═══════════════════════    │
    │                              │
    │  7. Validate return value    │
    │  ◄─────────────────────      │
    │                              │
    │  8. Unmarshal result         │
    │  ◄─────────────────────      │
    │                              │</code></pre>
<p>For <code>add(a, b)</code> which is a single CPU instruction (~1ns),
these 8 steps take ~300ns. The actual computation is less than 1% of the
total time.</p>
<h4 id="why-cant-this-be-optimized-away">Why Can’t This Be Optimized
Away?</h4>
<p>The trampoline exists to enforce isolation guarantees:</p>
<table>
<colgroup>
<col style="width: 15%" />
<col style="width: 23%" />
<col style="width: 61%" />
</colgroup>
<thead>
<tr class="header">
<th>Step</th>
<th>Purpose</th>
<th>Cannot Skip Because…</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Marshal args</td>
<td>Convert host types to WASM types</td>
<td>Type system boundary enforcement</td>
</tr>
<tr class="even">
<td>Validate types</td>
<td>Ensure WASM ABI compliance</td>
<td>Prevents type confusion attacks</td>
</tr>
<tr class="odd">
<td>Stack setup</td>
<td>Initialize WASM stack frame</td>
<td>Sandboxed stack isolation</td>
</tr>
<tr class="even">
<td>Bounds check</td>
<td>Configure linear memory guards</td>
<td>Memory safety is fundamental</td>
</tr>
<tr class="odd">
<td>Context switch</td>
<td>Enter sandboxed execution</td>
<td>This IS the isolation</td>
</tr>
</tbody>
</table>
<p>If you skip these steps, you lose the isolation guarantees. The
overhead is the <strong>cost of isolation</strong>, not
inefficiency.</p>
<h4 id="when-overhead-doesnt-matter">When Overhead Doesn’t Matter</h4>
<p>The key insight is that call overhead is <strong>fixed per
call</strong>, not per operation. This means:</p>
<pre><code>Overhead Impact = Trampoline_Time / Total_Work_Time

Example 1: Single add
  Work: 1ns, Trampoline: 300ns → Overhead = 300x (99.7% overhead)

Example 2: 1000 adds in a loop (inside WASM)
  Work: 1000ns, Trampoline: 300ns → Overhead = 1.3x (23% overhead)

Example 3: FFT of 1024 samples
  Work: 50000ns, Trampoline: 300ns → Overhead = 1.006x (0.6% overhead)</code></pre>
<p><strong>Design Rule</strong>: Minimize host-WASM boundary crossings.
Do more work per call.</p>
<h3 id="is-wasm-viable-for-production-waveforms">Is WASM Viable for
Production Waveforms?</h3>
<p><strong>Yes, but with the right architecture.</strong> Here’s the
decision framework:</p>
<h4 id="wasm-is-viable-when">WASM is Viable When:</h4>
<table>
<colgroup>
<col style="width: 28%" />
<col style="width: 43%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr class="header">
<th>Pattern</th>
<th>Why It Works</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Batch Processing</strong></td>
<td>Amortizes call overhead over many samples</td>
<td>Process 1000 samples per call instead of 1</td>
</tr>
<tr class="even">
<td><strong>Complex Per-Call Work</strong></td>
<td>Computation dominates trampoline cost</td>
<td>FFT, FIR filter, correlation</td>
</tr>
<tr class="odd">
<td><strong>Control Flow</strong></td>
<td>Logic is cheap, computation happens in batches</td>
<td>State machine, protocol parsing</td>
</tr>
<tr class="even">
<td><strong>Plugin Architecture</strong></td>
<td>Safety trumps raw performance</td>
<td>Third-party waveforms</td>
</tr>
</tbody>
</table>
<h4 id="wasm-is-not-viable-when">WASM is NOT Viable When:</h4>
<table>
<colgroup>
<col style="width: 28%" />
<col style="width: 43%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr class="header">
<th>Pattern</th>
<th>Why It Fails</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Sample-by-Sample</strong></td>
<td>Every sample pays 300ns overhead</td>
<td>Real-time audio callback per sample</td>
</tr>
<tr class="even">
<td><strong>Tight Inner Loops</strong></td>
<td>Call overhead dominates</td>
<td>Calling host for each multiply</td>
</tr>
<tr class="odd">
<td><strong>Hard Real-Time</strong></td>
<td>Overhead adds jitter</td>
<td>&lt;1μs latency requirements</td>
</tr>
<tr class="even">
<td><strong>Frequent Host Interaction</strong></td>
<td>Boundary crossings kill performance</td>
<td>Reading host state every sample</td>
</tr>
</tbody>
</table>
<h3 id="hybrid-architecture-native-dsp-wasm-logic">Hybrid Architecture:
Native DSP + WASM Logic</h3>
<p>The optimal architecture separates concerns:</p>
<ul>
<li><strong>WASM</strong>: Waveform logic, configuration, protocol
handling (safe, portable)</li>
<li><strong>Native</strong>: DSP primitives, SIMD operations, FFT (fast,
reusable)</li>
</ul>
<pre><code>┌─────────────────────────────────────────────────────────────────────────────┐
│                    Hybrid WASM/Native Architecture                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                    WASM Sandbox (Isolated)                            │  │
│  │                                                                       │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │              Waveform Plugin (untrusted code)                   │  │  │
│  │  │                                                                 │  │  │
│  │  │  • State machine logic                                          │  │  │
│  │  │  • Protocol parsing/generation                                  │  │  │
│  │  │  • Configuration handling                                       │  │  │
│  │  │  • Symbol mapping                                               │  │  │
│  │  │  • Error correction control flow                                │  │  │
│  │  │                                                                 │  │  │
│  │  │         │                │                │                     │  │  │
│  │  │         │ call           │ call           │ call                │  │  │
│  │  │         ▼                ▼                ▼                     │  │  │
│  │  └─────────┼────────────────┼────────────────┼─────────────────────┘  │  │
│  │            │                │                │                        │  │
│  └────────────┼────────────────┼────────────────┼────────────────────────┘  │
│               │                │                │                           │
│  ┌────────────▼────────────────▼────────────────▼────────────────────────┐  │
│  │                 Native Host Functions (trusted, fast)                 │  │
│  │                                                                       │  │
│  │  ┌───────────────┐  ┌───────────────┐  ┌───────────────────────────┐  │  │
│  │  │   fft_1024    │  │  fir_filter   │  │   simd_complex_multiply   │  │  │
│  │  │               │  │               │  │                           │  │  │
│  │  │ • FFTW/MKL    │  │ • AVX-512     │  │ • ARM NEON                │  │  │
│  │  │ • SIMD        │  │ • Optimized   │  │ • Vectorized              │  │  │
│  │  │ • Native      │  │ • Native      │  │ • Native                  │  │  │
│  │  └───────────────┘  └───────────────┘  └───────────────────────────┘  │  │
│  │                                                                       │  │
│  │  Additional host functions:                                           │  │
│  │  • correlate(samples, pattern) → peak position                        │  │
│  │  • demodulate_batch(samples, constellation) → symbols                 │  │
│  │  • apply_agc(samples, target_level) → normalized samples              │  │
│  │  • resample(samples, ratio) → resampled                               │  │
│  │                                                                       │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘</code></pre>
<h4 id="implementing-host-functions">Implementing Host Functions</h4>
<p>Host functions are native Rust functions exposed to WASM:</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">wasmtime::</span><span class="op">*;</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// Native DSP library exposed to WASM</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> DspHostFunctions <span class="op">{</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    fft_planner<span class="op">:</span> FftPlanner<span class="op">&lt;</span><span class="dt">f32</span><span class="op">&gt;,</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> DspHostFunctions <span class="op">{</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Register all DSP host functions with the linker</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> register(linker<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> Linker<span class="op">&lt;</span>WasmHostState<span class="op">&gt;</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">// FFT: (input_ptr, input_len, output_ptr) -&gt; ()</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>        linker<span class="op">.</span>func_wrap(</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;r4w_dsp&quot;</span><span class="op">,</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;fft_1024&quot;</span><span class="op">,</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>            <span class="op">|</span><span class="kw">mut</span> caller<span class="op">:</span> Caller<span class="op">&lt;</span><span class="ot">&#39;_</span><span class="op">,</span> WasmHostState<span class="op">&gt;,</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>             input_ptr<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>             output_ptr<span class="op">:</span> <span class="dt">i32</span><span class="op">|</span> <span class="op">{</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Read input from WASM memory</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> memory <span class="op">=</span> caller<span class="op">.</span>get_export(<span class="st">&quot;memory&quot;</span>)</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>unwrap()<span class="op">.</span>into_memory()<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> input <span class="op">=</span> read_complex_slice(<span class="op">&amp;</span>memory<span class="op">,</span> <span class="op">&amp;</span>caller<span class="op">,</span> input_ptr<span class="op">,</span> <span class="dv">1024</span>)<span class="op">;</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Perform FFT using native SIMD-optimized code</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> <span class="kw">mut</span> output <span class="op">=</span> input<span class="op">.</span>clone()<span class="op">;</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>                caller<span class="op">.</span>data()<span class="op">.</span>dsp<span class="op">.</span>fft_1024(<span class="op">&amp;</span><span class="kw">mut</span> output)<span class="op">;</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Write output back to WASM memory</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>                write_complex_slice(<span class="op">&amp;</span>memory<span class="op">,</span> <span class="op">&amp;</span><span class="kw">mut</span> caller<span class="op">,</span> output_ptr<span class="op">,</span> <span class="op">&amp;</span>output)<span class="op">;</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>            <span class="op">},</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>        )<span class="op">?;</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>        <span class="co">// FIR Filter: (samples_ptr, len, coeffs_ptr, coeffs_len, output_ptr) -&gt; ()</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>        linker<span class="op">.</span>func_wrap(</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;r4w_dsp&quot;</span><span class="op">,</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;fir_filter&quot;</span><span class="op">,</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>            <span class="op">|</span><span class="kw">mut</span> caller<span class="op">:</span> Caller<span class="op">&lt;</span><span class="ot">&#39;_</span><span class="op">,</span> WasmHostState<span class="op">&gt;,</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>             samples_ptr<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span> samples_len<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>             coeffs_ptr<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span> coeffs_len<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>             output_ptr<span class="op">:</span> <span class="dt">i32</span><span class="op">|</span> <span class="op">{</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Read from WASM memory</span></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> memory <span class="op">=</span> caller<span class="op">.</span>get_export(<span class="st">&quot;memory&quot;</span>)</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>unwrap()<span class="op">.</span>into_memory()<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> samples <span class="op">=</span> read_f32_slice(<span class="op">&amp;</span>memory<span class="op">,</span> <span class="op">&amp;</span>caller<span class="op">,</span> samples_ptr<span class="op">,</span> samples_len)<span class="op">;</span></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> coeffs <span class="op">=</span> read_f32_slice(<span class="op">&amp;</span>memory<span class="op">,</span> <span class="op">&amp;</span>caller<span class="op">,</span> coeffs_ptr<span class="op">,</span> coeffs_len)<span class="op">;</span></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Native SIMD-optimized FIR filter</span></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> output <span class="op">=</span> simd_fir_filter(<span class="op">&amp;</span>samples<span class="op">,</span> <span class="op">&amp;</span>coeffs)<span class="op">;</span></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Write back</span></span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>                write_f32_slice(<span class="op">&amp;</span>memory<span class="op">,</span> <span class="op">&amp;</span><span class="kw">mut</span> caller<span class="op">,</span> output_ptr<span class="op">,</span> <span class="op">&amp;</span>output)<span class="op">;</span></span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>            <span class="op">},</span></span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>        )<span class="op">?;</span></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Batch complex multiply: (a_ptr, b_ptr, len, out_ptr) -&gt; ()</span></span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>        linker<span class="op">.</span>func_wrap(</span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;r4w_dsp&quot;</span><span class="op">,</span></span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;complex_multiply_batch&quot;</span><span class="op">,</span></span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>            <span class="op">|</span><span class="kw">mut</span> caller<span class="op">:</span> Caller<span class="op">&lt;</span><span class="ot">&#39;_</span><span class="op">,</span> WasmHostState<span class="op">&gt;,</span></span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>             a_ptr<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span> b_ptr<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span> len<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span> out_ptr<span class="op">:</span> <span class="dt">i32</span><span class="op">|</span> <span class="op">{</span></span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> memory <span class="op">=</span> caller<span class="op">.</span>get_export(<span class="st">&quot;memory&quot;</span>)</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>unwrap()<span class="op">.</span>into_memory()<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> a <span class="op">=</span> read_complex_slice(<span class="op">&amp;</span>memory<span class="op">,</span> <span class="op">&amp;</span>caller<span class="op">,</span> a_ptr<span class="op">,</span> len)<span class="op">;</span></span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> b <span class="op">=</span> read_complex_slice(<span class="op">&amp;</span>memory<span class="op">,</span> <span class="op">&amp;</span>caller<span class="op">,</span> b_ptr<span class="op">,</span> len)<span class="op">;</span></span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>                <span class="co">// AVX-512 / NEON optimized</span></span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> output <span class="op">=</span> simd_complex_multiply(<span class="op">&amp;</span>a<span class="op">,</span> <span class="op">&amp;</span>b)<span class="op">;</span></span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>                write_complex_slice(<span class="op">&amp;</span>memory<span class="op">,</span> <span class="op">&amp;</span><span class="kw">mut</span> caller<span class="op">,</span> out_ptr<span class="op">,</span> <span class="op">&amp;</span>output)<span class="op">;</span></span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>            <span class="op">},</span></span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>        )<span class="op">?;</span></span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(())</span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="wasm-waveform-using-host-functions">WASM Waveform Using Host
Functions</h4>
<div class="sourceCode" id="cb15"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">// In the WASM waveform module (compiled to wasm32-wasip1)</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Import host functions</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>link<span class="at">(</span>wasm_import_module <span class="op">=</span> <span class="st">&quot;r4w_dsp&quot;</span><span class="at">)]</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="op">{</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> fft_1024(input_ptr<span class="op">:</span> <span class="op">*</span><span class="kw">const</span> Complex<span class="op">,</span> output_ptr<span class="op">:</span> <span class="op">*</span><span class="kw">mut</span> Complex)<span class="op">;</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> fir_filter(</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>        samples_ptr<span class="op">:</span> <span class="op">*</span><span class="kw">const</span> <span class="dt">f32</span><span class="op">,</span> samples_len<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>        coeffs_ptr<span class="op">:</span> <span class="op">*</span><span class="kw">const</span> <span class="dt">f32</span><span class="op">,</span> coeffs_len<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>        output_ptr<span class="op">:</span> <span class="op">*</span><span class="kw">mut</span> <span class="dt">f32</span><span class="op">,</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> complex_multiply_batch(</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>        a_ptr<span class="op">:</span> <span class="op">*</span><span class="kw">const</span> Complex<span class="op">,</span> b_ptr<span class="op">:</span> <span class="op">*</span><span class="kw">const</span> Complex<span class="op">,</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>        len<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span> out_ptr<span class="op">:</span> <span class="op">*</span><span class="kw">mut</span> Complex<span class="op">,</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="co">/// LoRa demodulation - logic in WASM, heavy math in native</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>no_mangle<span class="at">]</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> demodulate_symbol(samples_ptr<span class="op">:</span> <span class="op">*</span><span class="kw">const</span> Complex<span class="op">,</span> samples_len<span class="op">:</span> <span class="dt">i32</span>) <span class="op">-&gt;</span> <span class="dt">i32</span> <span class="op">{</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Allocate buffers</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> fft_input <span class="op">=</span> <span class="pp">vec!</span>[<span class="pp">Complex::</span>zero()<span class="op">;</span> <span class="dv">1024</span>]<span class="op">;</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> fft_output <span class="op">=</span> <span class="pp">vec!</span>[<span class="pp">Complex::</span>zero()<span class="op">;</span> <span class="dv">1024</span>]<span class="op">;</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> downchirp <span class="op">=</span> <span class="pp">vec!</span>[<span class="pp">Complex::</span>zero()<span class="op">;</span> <span class="dv">1024</span>]<span class="op">;</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Generate downchirp (simple math, stays in WASM)</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>    generate_downchirp(<span class="op">&amp;</span><span class="kw">mut</span> downchirp<span class="op">,</span> samples_len <span class="kw">as</span> <span class="dt">usize</span>)<span class="op">;</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Multiply by downchirp - USE NATIVE HOST FUNCTION</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>        complex_multiply_batch(</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>            samples_ptr<span class="op">,</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>            downchirp<span class="op">.</span>as_ptr()<span class="op">,</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>            samples_len<span class="op">,</span></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>            fft_input<span class="op">.</span>as_mut_ptr()<span class="op">,</span></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>        )<span class="op">;</span></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">// FFT to find peak - USE NATIVE HOST FUNCTION</span></span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>        fft_1024(fft_input<span class="op">.</span>as_ptr()<span class="op">,</span> fft_output<span class="op">.</span>as_mut_ptr())<span class="op">;</span></span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Find peak (simple loop, stays in WASM)</span></span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> symbol <span class="op">=</span> find_peak_bin(<span class="op">&amp;</span>fft_output)<span class="op">;</span></span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Gray decode (simple lookup, stays in WASM)</span></span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>    gray_decode(symbol)</span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="performance-comparison">Performance Comparison</h4>
<table>
<thead>
<tr class="header">
<th>Approach</th>
<th>Call Pattern</th>
<th>Overhead</th>
<th>Viable?</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Pure WASM</td>
<td>Per-sample calls to host</td>
<td>300x</td>
<td>❌</td>
</tr>
<tr class="even">
<td>Pure WASM</td>
<td>Batch processing</td>
<td>2-3x</td>
<td>✅</td>
</tr>
<tr class="odd">
<td>Hybrid</td>
<td>Logic in WASM, DSP in native</td>
<td>1.1-1.5x</td>
<td>✅ (see caveats)</td>
</tr>
<tr class="even">
<td>Pure Native</td>
<td>No isolation</td>
<td>1x</td>
<td>⚠️ Security risk</td>
</tr>
</tbody>
</table>
<h4 id="measured-host-function-benchmarks">Measured Host Function
Benchmarks</h4>
<p><strong>Important Finding</strong>: Host functions have inherent
boundary-crossing overhead. After optimization (using f32 natively in
host functions), wasmtime’s JIT-compiled pure WASM remains competitive
for most workloads.</p>
<p>Benchmarks measured on x86_64 Linux, release builds, <strong>with
f32-optimized host functions</strong>:</p>
<p><strong>FFT Performance (Host rustfft f32 vs Pure WASM
Cooley-Tukey)</strong>:</p>
<table>
<thead>
<tr class="header">
<th>Size</th>
<th>Host (µs)</th>
<th>Pure WASM (µs)</th>
<th>Ratio</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>64</td>
<td>1.4</td>
<td>1.0</td>
<td>WASM 1.4x faster</td>
</tr>
<tr class="even">
<td>256</td>
<td>6.1</td>
<td>3.4</td>
<td>WASM 1.8x faster</td>
</tr>
<tr class="odd">
<td>1024</td>
<td>24.6</td>
<td>14.4</td>
<td>WASM 1.7x faster</td>
</tr>
<tr class="even">
<td>4096</td>
<td>97.8</td>
<td>68.3</td>
<td>WASM 1.4x faster</td>
</tr>
<tr class="odd">
<td>8192</td>
<td>197.8</td>
<td>200.8</td>
<td><strong>~Equal</strong></td>
</tr>
</tbody>
</table>
<p>At 8192 samples, rustfft’s optimized algorithms overcome the
boundary-crossing overhead.</p>
<p><strong>Complex Multiply (Host vs Pure WASM)</strong>:</p>
<table>
<thead>
<tr class="header">
<th>Size</th>
<th>Host (µs)</th>
<th>Pure WASM (µs)</th>
<th>Ratio</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>128</td>
<td>1.5</td>
<td>0.5</td>
<td>WASM 3x faster</td>
</tr>
<tr class="even">
<td>512</td>
<td>7.3</td>
<td>1.0</td>
<td>WASM 7x faster</td>
</tr>
<tr class="odd">
<td>1024</td>
<td>15.1</td>
<td>1.8</td>
<td>WASM 8x faster</td>
</tr>
</tbody>
</table>
<p>For simple O(n) operations, the boundary overhead dominates. Pure
WASM wins decisively.</p>
<p><strong>Full Demodulation Pipeline (complex_multiply + FFT +
find_peak)</strong>:</p>
<table>
<thead>
<tr class="header">
<th>Size</th>
<th>Host (µs)</th>
<th>Pure WASM (µs)</th>
<th>Ratio</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>128</td>
<td>5.7</td>
<td>2.3</td>
<td>WASM 2.5x faster</td>
</tr>
<tr class="even">
<td>512</td>
<td>21.7</td>
<td>8.1</td>
<td>WASM 2.7x faster</td>
</tr>
<tr class="odd">
<td>1024</td>
<td>42.0</td>
<td>17.5</td>
<td>WASM 2.4x faster</td>
</tr>
</tbody>
</table>
<p><strong>Why is pure WASM faster?</strong> Even after f32
optimization, the remaining overhead includes: 1. <strong>Memory
copying</strong>: Reading samples from WASM linear memory to Rust Vec 2.
<strong>Memory copying</strong>: Writing results back to WASM linear
memory 3. <strong>Call boundary</strong>: wasmtime host function
dispatch overhead 4. <strong>Allocation</strong>: Creating intermediate
buffers on each call</p>
<p>wasmtime’s JIT produces efficient code that operates directly on WASM
linear memory without copying.</p>
<p><strong>When to use host functions</strong>:</p>
<p>Host functions make sense when: - <strong>Large FFTs</strong> (8k+
samples): rustfft optimizations overcome overhead - <strong>Complex
algorithms</strong>: Operations that are hard to implement correctly in
WASM - <strong>Hardware acceleration</strong>: When host can leverage
SIMD/AVX/GPU - <strong>Shared lookup tables</strong>: Avoiding duplicate
data in each WASM instance</p>
<p><strong>Recommendations</strong>: 1. <strong>For DSP-heavy
workloads</strong>: Use pure WASM; wasmtime’s JIT is excellent 2.
<strong>For large FFTs (8k+)</strong>: Host functions become competitive
3. <strong>For simple ops</strong>: Pure WASM is significantly faster 4.
<strong>Future optimization</strong>: Shared memory, batched operations,
SIMD-128 in WASM</p>
<h4 id="standard-dsp-host-function-library">Standard DSP Host Function
Library</h4>
<p>For production use, R4W provides a standard library of host functions
that waveforms can use:</p>
<table>
<colgroup>
<col style="width: 35%" />
<col style="width: 39%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="header">
<th>Category</th>
<th>Functions</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>FFT</strong></td>
<td><code>fft_64</code>, <code>fft_128</code>, <code>fft_256</code>,
<code>fft_512</code>, <code>fft_1024</code>, <code>fft_2048</code>,
<code>fft_4096</code></td>
<td>FFTW/MKL backend</td>
</tr>
<tr class="even">
<td><strong>Filters</strong></td>
<td><code>fir_filter</code>, <code>iir_filter</code>,
<code>polyphase_filter</code></td>
<td>SIMD optimized</td>
</tr>
<tr class="odd">
<td><strong>Resampling</strong></td>
<td><code>resample</code>, <code>interpolate</code>,
<code>decimate</code></td>
<td>Fractional rate support</td>
</tr>
<tr class="even">
<td><strong>Modulation</strong></td>
<td><code>qam_mod</code>, <code>qam_demod</code>, <code>psk_mod</code>,
<code>psk_demod</code></td>
<td>Batch operations</td>
</tr>
<tr class="odd">
<td><strong>Math</strong></td>
<td><code>complex_multiply</code>, <code>complex_add</code>,
<code>magnitude</code>, <code>phase</code></td>
<td>Vectorized</td>
</tr>
<tr class="even">
<td><strong>Correlation</strong></td>
<td><code>correlate</code>, <code>cross_correlate</code>,
<code>auto_correlate</code></td>
<td>For sync detection</td>
</tr>
<tr class="odd">
<td><strong>AGC</strong></td>
<td><code>agc_process</code>, <code>power_estimate</code></td>
<td>Automatic gain control</td>
</tr>
</tbody>
</table>
<p>This library is: - <strong>Generic</strong>: Works with any waveform
- <strong>Trusted</strong>: Part of the R4W core, audited -
<strong>Fast</strong>: Native SIMD implementations -
<strong>Safe</strong>: WASM can only call these specific functions</p>
<h3 id="summary-wasm-production-viability">Summary: WASM Production
Viability</h3>
<table>
<colgroup>
<col style="width: 55%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr class="header">
<th>Question</th>
<th>Answer</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Can WASM achieve native performance?</td>
<td>No, there is an inherent isolation cost</td>
</tr>
<tr class="even">
<td>Can WASM be viable for production?</td>
<td><strong>Yes</strong>, with hybrid architecture</td>
</tr>
<tr class="odd">
<td>What’s the practical overhead?</td>
<td>10-50% with proper design (batch + host functions)</td>
</tr>
<tr class="even">
<td>When should I use pure WASM?</td>
<td>Prototyping, untrusted plugins, portability</td>
</tr>
<tr class="odd">
<td>When should I use hybrid?</td>
<td>Production waveforms needing both isolation and performance</td>
</tr>
</tbody>
</table>
<p>The hybrid architecture gives you: - <strong>Isolation</strong> for
untrusted waveform logic - <strong>Performance</strong> for DSP
operations - <strong>Portability</strong> across platforms -
<strong>Security</strong> with deny-by-default capabilities</p>
<h4 id="fuel-metering">Fuel Metering</h4>
<table>
<thead>
<tr class="header">
<th>Metric</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Overhead</td>
<td>Negligible (&lt;1%)</td>
</tr>
<tr class="even">
<td>Fuel per <code>add()</code></td>
<td>14 units</td>
</tr>
</tbody>
</table>
<h3 id="trade-offs">Trade-offs</h3>
<table>
<thead>
<tr class="header">
<th>Aspect</th>
<th>WASM (L1.5)</th>
<th>Namespaces (L2)</th>
<th>Containers (L4)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Cold start</strong></td>
<td>&lt;10ms</td>
<td>~10ms</td>
<td>~100-500ms</td>
</tr>
<tr class="even">
<td><strong>Call overhead</strong></td>
<td>300ns</td>
<td>~0ns</td>
<td>~0ns</td>
</tr>
<tr class="odd">
<td><strong>DSP overhead</strong></td>
<td>2.8x</td>
<td>~1x</td>
<td>~1x</td>
</tr>
<tr class="even">
<td><strong>Memory bandwidth</strong></td>
<td>48-80 GB/s</td>
<td>Native</td>
<td>Native</td>
</tr>
<tr class="odd">
<td><strong>Memory isolation</strong></td>
<td>Linear memory</td>
<td>Virtual memory</td>
<td>cgroups</td>
</tr>
<tr class="even">
<td><strong>Syscall filtering</strong></td>
<td>WASI only</td>
<td>seccomp</td>
<td>seccomp</td>
</tr>
<tr class="odd">
<td><strong>Portability</strong></td>
<td>Cross-platform</td>
<td>Linux only</td>
<td>Linux/Docker</td>
</tr>
<tr class="even">
<td><strong>Root required</strong></td>
<td>No</td>
<td>Sometimes</td>
<td>Usually</td>
</tr>
</tbody>
</table>
<h3 id="when-to-use-wasm-isolation">When to Use WASM Isolation</h3>
<p><strong>Good fit:</strong> - Plugin architecture for third-party
waveforms - Non-real-time DSP where 2-3x overhead is acceptable -
Cross-platform deployment (Linux, macOS, Windows, embedded) - Untrusted
code execution without root privileges - Rapid prototyping (fast
compilation, instant feedback) - Batch processing where call overhead is
amortized</p>
<p><strong>Poor fit:</strong> - Hard real-time DSP requiring &lt;1μs
latency - Tight inner loops with frequent function calls - Multi-level
security requiring kernel-level isolation - Direct hardware access
(FPGA, SDR devices) - Sample-by-sample processing (call overhead
dominates)</p>
<h3 id="compiling-waveforms-to-wasm">Compiling Waveforms to WASM</h3>
<div class="sourceCode" id="cb16"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install WASM target</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="ex">rustup</span> target add wasm32-wasip1</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Compile waveform to WASM</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> build <span class="at">--target</span> wasm32-wasip1 <span class="at">--release</span> <span class="at">-p</span> my-waveform</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Optimize (optional)</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="ex">wasm-opt</span> <span class="at">-O3</span> target/wasm32-wasip1/release/my_waveform.wasm <span class="dt">\</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">-o</span> waveforms/my_waveform.wasm</span></code></pre></div>
<h3 id="benchmark-example">Benchmark Example</h3>
<div class="sourceCode" id="cb17"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">r4w_sandbox::</span><span class="op">{</span>WasmSandbox<span class="op">,</span> WasmConfig<span class="op">,</span> WasmBenchmark<span class="op">};</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> sandbox <span class="op">=</span> <span class="pp">WasmSandbox::</span>new(<span class="pp">WasmConfig::</span>dsp())<span class="op">?;</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> module <span class="op">=</span> sandbox<span class="op">.</span>load_module(<span class="st">&quot;waveforms/bpsk.wasm&quot;</span>)<span class="op">?;</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="kw">mut</span> instance <span class="op">=</span> sandbox<span class="op">.</span>instantiate(<span class="op">&amp;</span>module)<span class="op">?;</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Benchmark modulation function</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="kw">mut</span> bench <span class="op">=</span> <span class="pp">WasmBenchmark::</span>new()<span class="op">;</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _ <span class="kw">in</span> <span class="dv">0</span><span class="op">..</span><span class="dv">1000</span> <span class="op">{</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> result <span class="op">=</span> instance<span class="op">.</span>call_i32(<span class="st">&quot;process_samples&quot;</span>)<span class="op">?;</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    bench<span class="op">.</span>record(result<span class="op">.</span>execution_time_us)<span class="op">;</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="pp">println!</span>(<span class="st">&quot;WASM benchmark: {}&quot;</span><span class="op">,</span> bench<span class="op">.</span>summary())<span class="op">;</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Output: n=1000 min=45us mean=52.3us p50=51us p99=89us max=156us</span></span></code></pre></div>
<hr />
<h2 id="level-4-5-container-isolation">Level 4-5: Container
Isolation</h2>
<h3 id="docker-compose-for-multi-waveform-deployment">Docker Compose for
Multi-Waveform Deployment</h3>
<div class="sourceCode" id="cb18"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># docker-compose.isolation.yml</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">version</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;3.8&#39;</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="fu">x-waveform-common</span><span class="kw">:</span><span class="at"> </span><span class="ot">&amp;waveform-common</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">security_opt</span><span class="kw">:</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> no-new-privileges:true</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> seccomp:seccomp-dsp.json</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">cap_drop</span><span class="kw">:</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> ALL</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">cap_add</span><span class="kw">:</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> SYS_NICE</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> IPC_LOCK</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">read_only</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">tmpfs</span><span class="kw">:</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> /tmp:noexec,nosuid,size=64M</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="co">  # Unclassified waveform - maximum restrictions</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">waveform-unclass</span><span class="kw">:</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">&lt;&lt;</span><span class="kw">:</span><span class="at"> </span><span class="ot">*waveform-common</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> r4w/waveform:latest</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">container_name</span><span class="kw">:</span><span class="at"> r4w-unclass</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> R4W_WAVEFORM=BPSK</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> R4W_SECURITY_LEVEL=UNCLASS</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">mem_limit</span><span class="kw">:</span><span class="at"> 256m</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">cpus</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">pids_limit</span><span class="kw">:</span><span class="at"> </span><span class="dv">50</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">networks</span><span class="kw">:</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> unclass-net</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a><span class="co">    # No FPGA access</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a><span class="co">    # No shared memory with other waveforms</span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a><span class="co">  # Secret waveform - moderate restrictions</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">waveform-secret</span><span class="kw">:</span></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">&lt;&lt;</span><span class="kw">:</span><span class="at"> </span><span class="ot">*waveform-common</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> r4w/waveform:latest</span></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">container_name</span><span class="kw">:</span><span class="at"> r4w-secret</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">security_opt</span><span class="kw">:</span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> no-new-privileges:true</span></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> seccomp:seccomp-dsp.json</span></span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> apparmor:r4w-secret-profile</span></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> R4W_WAVEFORM=SINCGARS</span></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> R4W_SECURITY_LEVEL=SECRET</span></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">mem_limit</span><span class="kw">:</span><span class="at"> 512m</span></span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">cpus</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">pids_limit</span><span class="kw">:</span><span class="at"> </span><span class="dv">100</span></span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">devices</span><span class="kw">:</span></span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> /dev/uio0:/dev/uio0:rw</span><span class="co">  # FPGA access</span></span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> secret-keys:/keys:ro</span></span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">networks</span><span class="kw">:</span></span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> secret-net</span></span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a><span class="co">    # Isolated network, no route to unclass</span></span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a><span class="co">  # Top Secret waveform - minimal restrictions for performance</span></span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">waveform-topsecret</span><span class="kw">:</span></span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">&lt;&lt;</span><span class="kw">:</span><span class="at"> </span><span class="ot">*waveform-common</span></span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> r4w/waveform:latest</span></span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">container_name</span><span class="kw">:</span><span class="at"> r4w-topsecret</span></span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">security_opt</span><span class="kw">:</span></span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> no-new-privileges:true</span></span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> seccomp:seccomp-dsp.json</span></span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> apparmor:r4w-topsecret-profile</span></span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> R4W_WAVEFORM=LINK16</span></span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> R4W_SECURITY_LEVEL=TOPSECRET</span></span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">mem_limit</span><span class="kw">:</span><span class="at"> 1g</span></span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">cpus</span><span class="kw">:</span><span class="at"> </span><span class="dv">4</span></span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">pids_limit</span><span class="kw">:</span><span class="at"> </span><span class="dv">200</span></span>
<span id="cb18-72"><a href="#cb18-72" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">devices</span><span class="kw">:</span></span>
<span id="cb18-73"><a href="#cb18-73" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> /dev/uio0:/dev/uio0:rw</span></span>
<span id="cb18-74"><a href="#cb18-74" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> /dev/uio1:/dev/uio1:rw</span></span>
<span id="cb18-75"><a href="#cb18-75" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb18-76"><a href="#cb18-76" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> topsecret-keys:/keys:ro</span></span>
<span id="cb18-77"><a href="#cb18-77" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">networks</span><span class="kw">:</span></span>
<span id="cb18-78"><a href="#cb18-78" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> topsecret-net</span></span>
<span id="cb18-79"><a href="#cb18-79" aria-hidden="true" tabindex="-1"></a><span class="co">    # Dedicated FPGA partition</span></span>
<span id="cb18-80"><a href="#cb18-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-81"><a href="#cb18-81" aria-hidden="true" tabindex="-1"></a><span class="co">  # Control process - orchestrates all waveforms</span></span>
<span id="cb18-82"><a href="#cb18-82" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">r4w-control</span><span class="kw">:</span></span>
<span id="cb18-83"><a href="#cb18-83" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> r4w/control:latest</span></span>
<span id="cb18-84"><a href="#cb18-84" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">container_name</span><span class="kw">:</span><span class="at"> r4w-control</span></span>
<span id="cb18-85"><a href="#cb18-85" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">security_opt</span><span class="kw">:</span></span>
<span id="cb18-86"><a href="#cb18-86" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> no-new-privileges:true</span></span>
<span id="cb18-87"><a href="#cb18-87" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">cap_drop</span><span class="kw">:</span></span>
<span id="cb18-88"><a href="#cb18-88" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> ALL</span></span>
<span id="cb18-89"><a href="#cb18-89" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">networks</span><span class="kw">:</span></span>
<span id="cb18-90"><a href="#cb18-90" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> unclass-net</span></span>
<span id="cb18-91"><a href="#cb18-91" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> secret-net</span></span>
<span id="cb18-92"><a href="#cb18-92" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> topsecret-net</span></span>
<span id="cb18-93"><a href="#cb18-93" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb18-94"><a href="#cb18-94" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;127.0.0.1:8080:8080&quot;</span></span>
<span id="cb18-95"><a href="#cb18-95" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb18-96"><a href="#cb18-96" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> /var/run/docker.sock:/var/run/docker.sock:ro</span></span>
<span id="cb18-97"><a href="#cb18-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-98"><a href="#cb18-98" aria-hidden="true" tabindex="-1"></a><span class="fu">networks</span><span class="kw">:</span></span>
<span id="cb18-99"><a href="#cb18-99" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">unclass-net</span><span class="kw">:</span></span>
<span id="cb18-100"><a href="#cb18-100" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">driver</span><span class="kw">:</span><span class="at"> bridge</span></span>
<span id="cb18-101"><a href="#cb18-101" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">internal</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb18-102"><a href="#cb18-102" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">driver_opts</span><span class="kw">:</span></span>
<span id="cb18-103"><a href="#cb18-103" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">com.docker.network.bridge.enable_icc</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;false&quot;</span></span>
<span id="cb18-104"><a href="#cb18-104" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">secret-net</span><span class="kw">:</span></span>
<span id="cb18-105"><a href="#cb18-105" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">driver</span><span class="kw">:</span><span class="at"> bridge</span></span>
<span id="cb18-106"><a href="#cb18-106" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">internal</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb18-107"><a href="#cb18-107" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">driver_opts</span><span class="kw">:</span></span>
<span id="cb18-108"><a href="#cb18-108" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">com.docker.network.bridge.enable_icc</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;false&quot;</span></span>
<span id="cb18-109"><a href="#cb18-109" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">topsecret-net</span><span class="kw">:</span></span>
<span id="cb18-110"><a href="#cb18-110" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">driver</span><span class="kw">:</span><span class="at"> bridge</span></span>
<span id="cb18-111"><a href="#cb18-111" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">internal</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb18-112"><a href="#cb18-112" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">driver_opts</span><span class="kw">:</span></span>
<span id="cb18-113"><a href="#cb18-113" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">com.docker.network.bridge.enable_icc</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;false&quot;</span></span>
<span id="cb18-114"><a href="#cb18-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-115"><a href="#cb18-115" aria-hidden="true" tabindex="-1"></a><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb18-116"><a href="#cb18-116" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">secret-keys</span><span class="kw">:</span></span>
<span id="cb18-117"><a href="#cb18-117" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">driver</span><span class="kw">:</span><span class="at"> local</span></span>
<span id="cb18-118"><a href="#cb18-118" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">driver_opts</span><span class="kw">:</span></span>
<span id="cb18-119"><a href="#cb18-119" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">type</span><span class="kw">:</span><span class="at"> tmpfs</span></span>
<span id="cb18-120"><a href="#cb18-120" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">o</span><span class="kw">:</span><span class="at"> size=1m,mode=0400</span></span>
<span id="cb18-121"><a href="#cb18-121" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">topsecret-keys</span><span class="kw">:</span></span>
<span id="cb18-122"><a href="#cb18-122" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">driver</span><span class="kw">:</span><span class="at"> local</span></span>
<span id="cb18-123"><a href="#cb18-123" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">driver_opts</span><span class="kw">:</span></span>
<span id="cb18-124"><a href="#cb18-124" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">type</span><span class="kw">:</span><span class="at"> tmpfs</span></span>
<span id="cb18-125"><a href="#cb18-125" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">o</span><span class="kw">:</span><span class="at"> size=1m,mode=0400</span></span></code></pre></div>
<h3 id="firecracker-microvm-level-5">Firecracker MicroVM (Level 5)</h3>
<div class="sourceCode" id="cb19"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">firecracker_sdk::</span><span class="op">{</span>VmConfig<span class="op">,</span> NetworkInterface<span class="op">,</span> Drive<span class="op">};</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// Create a Firecracker microVM for isolated waveform execution</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> create_waveform_microvm(</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    waveform<span class="op">:</span> <span class="op">&amp;</span><span class="dt">str</span><span class="op">,</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    security_level<span class="op">:</span> SecurityLevel<span class="op">,</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>VmHandle<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> config <span class="op">=</span> <span class="pp">VmConfig::</span>builder()</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Minimal kernel for DSP workloads</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>kernel_image(<span class="st">&quot;/var/lib/r4w/vmlinux-dsp&quot;</span>)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>kernel_args(<span class="st">&quot;console=ttyS0 quiet&quot;</span>)</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Root filesystem with waveform</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>root_drive(<span class="pp">Drive::</span>builder()</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>path(<span class="pp">format!</span>(<span class="st">&quot;/var/lib/r4w/rootfs-{}.ext4&quot;</span><span class="op">,</span> waveform))</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>read_only(<span class="cn">true</span>)</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>build())</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Resource limits based on security level</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>vcpu_count(<span class="cf">match</span> security_level <span class="op">{</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>            <span class="pp">SecurityLevel::</span>Unclass <span class="op">=&gt;</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>            <span class="pp">SecurityLevel::</span>Secret <span class="op">=&gt;</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>            <span class="pp">SecurityLevel::</span>TopSecret <span class="op">=&gt;</span> <span class="dv">4</span><span class="op">,</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span>)</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>mem_size_mib(<span class="cf">match</span> security_level <span class="op">{</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>            <span class="pp">SecurityLevel::</span>Unclass <span class="op">=&gt;</span> <span class="dv">256</span><span class="op">,</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>            <span class="pp">SecurityLevel::</span>Secret <span class="op">=&gt;</span> <span class="dv">512</span><span class="op">,</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>            <span class="pp">SecurityLevel::</span>TopSecret <span class="op">=&gt;</span> <span class="dv">1024</span><span class="op">,</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span>)</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Network isolation</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>network_interface(<span class="pp">NetworkInterface::</span>builder()</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>iface_id(<span class="st">&quot;eth0&quot;</span>)</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>host_dev_name(<span class="pp">format!</span>(<span class="st">&quot;tap-{}&quot;</span><span class="op">,</span> waveform))</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>build())</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>        <span class="co">// FPGA passthrough (for high-security only)</span></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>mmio_device(<span class="cf">if</span> security_level <span class="op">&gt;=</span> <span class="pp">SecurityLevel::</span>Secret <span class="op">{</span></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Some</span>(<span class="pp">MmioDevice::</span>builder()</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>type_(<span class="st">&quot;virtio-fpga&quot;</span>)</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>base_addr(<span class="dv">0x40000000</span>)</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>size(<span class="dv">0x10000</span>)</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>irq(<span class="dv">5</span>)</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>build())</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>            <span class="cn">None</span></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span>)</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>build()<span class="op">?;</span></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>    <span class="pp">VmHandle::</span>spawn(config)</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="level-6-virtual-machine-isolation">Level 6: Virtual Machine
Isolation</h2>
<h3 id="kvmqemu-with-vfio-passthrough">KVM/QEMU with VFIO
Passthrough</h3>
<div class="sourceCode" id="cb20"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co"># launch-isolated-vm.sh - Launch VM with FPGA passthrough</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="va">WAVEFORM</span><span class="op">=</span><span class="va">$1</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="va">SECURITY_LEVEL</span><span class="op">=</span><span class="va">$2</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine IOMMU group for FPGA</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="va">FPGA_PCI</span><span class="op">=</span><span class="st">&quot;0000:01:00.0&quot;</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="va">IOMMU_GROUP</span><span class="op">=</span><span class="va">$(</span><span class="fu">readlink</span> /sys/bus/pci/devices/<span class="va">$FPGA_PCI</span>/iommu_group <span class="kw">|</span> <span class="fu">basename</span><span class="va">)</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Unbind from host driver</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="va">$FPGA_PCI</span> <span class="op">&gt;</span> /sys/bus/pci/drivers/xilinx_dma/unbind</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="va">$FPGA_PCI</span> <span class="op">&gt;</span> /sys/bus/pci/drivers/vfio-pci/bind</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Launch QEMU with isolated resources</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="ex">qemu-system-x86_64</span> <span class="dt">\</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">-name</span> <span class="st">&quot;r4w-</span><span class="va">${WAVEFORM}</span><span class="st">-</span><span class="va">${SECURITY_LEVEL}</span><span class="st">&quot;</span> <span class="dt">\</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">-machine</span> q35,accel=kvm,kernel-irqchip=split <span class="dt">\</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">-cpu</span> host,+invtsc <span class="dt">\</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">-m</span> 2G <span class="dt">\</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">-smp</span> 4,sockets=1,cores=4,threads=1 <span class="dt">\</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">\</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Memory isolation</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-object</span> memory-backend-memfd,id=mem0,size=2G,share=off <span class="dt">\</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">-numa</span> node,memdev=mem0 <span class="dt">\</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">\</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># CPU pinning for deterministic performance</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-realtime</span> mlock=on <span class="dt">\</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">-overcommit</span> cpu-pm=on <span class="dt">\</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    <span class="dt">\</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># FPGA passthrough via VFIO</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-device</span> vfio-pci,host=<span class="va">$FPGA_PCI</span>,id=fpga0 <span class="dt">\</span></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>    <span class="dt">\</span></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Isolated network</span></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-netdev</span> tap,id=net0,ifname=tap-<span class="va">${WAVEFORM}</span>,script=no <span class="dt">\</span></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">-device</span> virtio-net-pci,netdev=net0,mac=52:54:00:<span class="va">${SECURITY_LEVEL}</span>:00:01 <span class="dt">\</span></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>    <span class="dt">\</span></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Secure boot (optional)</span></span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-drive</span> if=pflash,format=raw,readonly=on,file=/usr/share/OVMF/OVMF_CODE.fd <span class="dt">\</span></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">-drive</span> if=pflash,format=raw,file=/var/lib/r4w/OVMF_VARS_<span class="va">${WAVEFORM}</span>.fd <span class="dt">\</span></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>    <span class="dt">\</span></span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Root filesystem</span></span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-drive</span> file=/var/lib/r4w/vm-<span class="va">${WAVEFORM}</span>.qcow2,if=virtio,format=qcow2 <span class="dt">\</span></span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>    <span class="dt">\</span></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Console</span></span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-serial</span> stdio <span class="dt">\</span></span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">-display</span> none</span></code></pre></div>
<h3 id="libvirt-configuration">libvirt Configuration</h3>
<div class="sourceCode" id="cb21"><pre
class="sourceCode xml"><code class="sourceCode xml"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- /etc/libvirt/qemu/r4w-secret.xml --&gt;</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">domain</span><span class="ot"> type=</span><span class="st">&#39;kvm&#39;</span>&gt;</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">name</span>&gt;r4w-secret-sincgars&lt;/<span class="kw">name</span>&gt;</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">uuid</span>&gt;12345678-1234-1234-1234-123456789012&lt;/<span class="kw">uuid</span>&gt;</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">memory</span><span class="ot"> unit=</span><span class="st">&#39;GiB&#39;</span>&gt;2&lt;/<span class="kw">memory</span>&gt;</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">vcpu</span><span class="ot"> placement=</span><span class="st">&#39;static&#39;</span><span class="ot"> cpuset=</span><span class="st">&#39;4-7&#39;</span>&gt;4&lt;/<span class="kw">vcpu</span>&gt;</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">cputune</span>&gt;</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">vcpupin</span><span class="ot"> vcpu=</span><span class="st">&#39;0&#39;</span><span class="ot"> cpuset=</span><span class="st">&#39;4&#39;</span>/&gt;</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">vcpupin</span><span class="ot"> vcpu=</span><span class="st">&#39;1&#39;</span><span class="ot"> cpuset=</span><span class="st">&#39;5&#39;</span>/&gt;</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">vcpupin</span><span class="ot"> vcpu=</span><span class="st">&#39;2&#39;</span><span class="ot"> cpuset=</span><span class="st">&#39;6&#39;</span>/&gt;</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">vcpupin</span><span class="ot"> vcpu=</span><span class="st">&#39;3&#39;</span><span class="ot"> cpuset=</span><span class="st">&#39;7&#39;</span>/&gt;</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">emulatorpin</span><span class="ot"> cpuset=</span><span class="st">&#39;4-7&#39;</span>/&gt;</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">cputune</span>&gt;</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">numatune</span>&gt;</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">memory</span><span class="ot"> mode=</span><span class="st">&#39;strict&#39;</span><span class="ot"> nodeset=</span><span class="st">&#39;1&#39;</span>/&gt;</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">numatune</span>&gt;</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">memoryBacking</span>&gt;</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">hugepages</span>/&gt;</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">locked</span>/&gt;</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">nosharepages</span>/&gt;</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">memoryBacking</span>&gt;</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">os</span>&gt;</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">type</span><span class="ot"> arch=</span><span class="st">&#39;x86_64&#39;</span>&gt;hvm&lt;/<span class="kw">type</span>&gt;</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">loader</span><span class="ot"> readonly=</span><span class="st">&#39;yes&#39;</span><span class="ot"> type=</span><span class="st">&#39;pflash&#39;</span>&gt;/usr/share/OVMF/OVMF_CODE.fd&lt;/<span class="kw">loader</span>&gt;</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">nvram</span>&gt;/var/lib/libvirt/qemu/nvram/r4w-secret_VARS.fd&lt;/<span class="kw">nvram</span>&gt;</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">boot</span><span class="ot"> dev=</span><span class="st">&#39;hd&#39;</span>/&gt;</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">os</span>&gt;</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">features</span>&gt;</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">acpi</span>/&gt;</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">apic</span>/&gt;</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">ioapic</span><span class="ot"> driver=</span><span class="st">&#39;kvm&#39;</span>/&gt;</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">features</span>&gt;</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">devices</span>&gt;</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- FPGA passthrough --&gt;</span></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">hostdev</span><span class="ot"> mode=</span><span class="st">&#39;subsystem&#39;</span><span class="ot"> type=</span><span class="st">&#39;pci&#39;</span><span class="ot"> managed=</span><span class="st">&#39;yes&#39;</span>&gt;</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">driver</span><span class="ot"> name=</span><span class="st">&#39;vfio&#39;</span>/&gt;</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">source</span>&gt;</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">address</span><span class="ot"> domain=</span><span class="st">&#39;0x0000&#39;</span><span class="ot"> bus=</span><span class="st">&#39;0x01&#39;</span><span class="ot"> slot=</span><span class="st">&#39;0x00&#39;</span><span class="ot"> function=</span><span class="st">&#39;0x0&#39;</span>/&gt;</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>      &lt;/<span class="kw">source</span>&gt;</span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">hostdev</span>&gt;</span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- Isolated network --&gt;</span></span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">interface</span><span class="ot"> type=</span><span class="st">&#39;network&#39;</span>&gt;</span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">mac</span><span class="ot"> address=</span><span class="st">&#39;52:54:00:02:00:01&#39;</span>/&gt;</span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">source</span><span class="ot"> network=</span><span class="st">&#39;r4w-secret-isolated&#39;</span>/&gt;</span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">model</span><span class="ot"> type=</span><span class="st">&#39;virtio&#39;</span>/&gt;</span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">interface</span>&gt;</span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- Disk --&gt;</span></span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">disk</span><span class="ot"> type=</span><span class="st">&#39;file&#39;</span><span class="ot"> device=</span><span class="st">&#39;disk&#39;</span>&gt;</span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">driver</span><span class="ot"> name=</span><span class="st">&#39;qemu&#39;</span><span class="ot"> type=</span><span class="st">&#39;qcow2&#39;</span>/&gt;</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">source</span><span class="ot"> file=</span><span class="st">&#39;/var/lib/r4w/vm-sincgars.qcow2&#39;</span>/&gt;</span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">target</span><span class="ot"> dev=</span><span class="st">&#39;vda&#39;</span><span class="ot"> bus=</span><span class="st">&#39;virtio&#39;</span>/&gt;</span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">disk</span>&gt;</span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">devices</span>&gt;</span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">seclabel</span><span class="ot"> type=</span><span class="st">&#39;static&#39;</span><span class="ot"> model=</span><span class="st">&#39;selinux&#39;</span><span class="ot"> relabel=</span><span class="st">&#39;yes&#39;</span>&gt;</span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">label</span>&gt;system_u:system_r:svirt_t:s0:c123,c456&lt;/<span class="kw">label</span>&gt;</span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">seclabel</span>&gt;</span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">domain</span>&gt;</span></code></pre></div>
<hr />
<h2 id="level-7-hardware-isolation">Level 7: Hardware Isolation</h2>
<h3 id="cpu-and-memory-isolation">CPU and Memory Isolation</h3>
<div class="sourceCode" id="cb22"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">libc::</span><span class="op">{</span>cpu_set_t<span class="op">,</span> sched_setaffinity<span class="op">,</span> CPU_SET<span class="op">,</span> CPU_ZERO<span class="op">};</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">std::mem::</span>MaybeUninit<span class="op">;</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co">/// Pin waveform to specific CPU cores</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> pin_to_cores(cores<span class="op">:</span> <span class="op">&amp;</span>[<span class="dt">usize</span>]) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> cpuset <span class="op">=</span> <span class="pp">MaybeUninit::</span><span class="op">&lt;</span>cpu_set_t<span class="op">&gt;</span><span class="pp">::</span>uninit()<span class="op">;</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>        CPU_ZERO(cpuset<span class="op">.</span>as_mut_ptr())<span class="op">;</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">&amp;</span>core <span class="kw">in</span> cores <span class="op">{</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>            CPU_SET(core<span class="op">,</span> cpuset<span class="op">.</span>as_mut_ptr())<span class="op">;</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> result <span class="op">=</span> sched_setaffinity(<span class="dv">0</span><span class="op">,</span> <span class="pp">std::mem::size_of::</span><span class="op">&lt;</span>cpu_set_t<span class="op">&gt;</span>()<span class="op">,</span> cpuset<span class="op">.</span>as_ptr())<span class="op">;</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> result <span class="op">!=</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>AffinityFailed(<span class="pp">std::io::</span><span class="bu">Error</span><span class="pp">::</span>last_os_error()))<span class="op">;</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Ok</span>(())</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="co">/// Configure NUMA memory policy</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> set_numa_policy(node<span class="op">:</span> <span class="dt">usize</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">libc::</span><span class="op">{</span>set_mempolicy<span class="op">,</span> MPOL_BIND<span class="op">};</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> nodemask<span class="op">:</span> <span class="dt">u64</span> <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> node<span class="op">;</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> result <span class="op">=</span> set_mempolicy(</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>            MPOL_BIND<span class="op">,</span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span>nodemask <span class="kw">as</span> <span class="op">*</span><span class="kw">const</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>            <span class="pp">std::mem::size_of::</span><span class="op">&lt;</span><span class="dt">u64</span><span class="op">&gt;</span>() <span class="op">*</span> <span class="dv">8</span><span class="op">,</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>        )<span class="op">;</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> result <span class="op">!=</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>NumaFailed(<span class="pp">std::io::</span><span class="bu">Error</span><span class="pp">::</span>last_os_error()))<span class="op">;</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Ok</span>(())</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a><span class="co">/// Hardware isolation configuration</span></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> HardwareIsolation <span class="op">{</span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Dedicated CPU cores for this waveform</span></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> cpu_cores<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">usize</span><span class="op">&gt;,</span></span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// NUMA node for memory allocation</span></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> numa_node<span class="op">:</span> <span class="dt">usize</span><span class="op">,</span></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// IOMMU group for FPGA isolation</span></span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> iommu_group<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">&gt;,</span></span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Enable Intel CAT (Cache Allocation Technology)</span></span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> cache_allocation<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span>CacheConfig<span class="op">&gt;,</span></span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Enable AMD SEV (Secure Encrypted Virtualization)</span></span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> memory_encryption<span class="op">:</span> <span class="dt">bool</span><span class="op">,</span></span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> HardwareIsolation <span class="op">{</span></span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> apply(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Pin to dedicated cores</span></span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>        pin_to_cores(<span class="op">&amp;</span><span class="kw">self</span><span class="op">.</span>cpu_cores)<span class="op">?;</span></span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Set NUMA policy</span></span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a>        set_numa_policy(<span class="kw">self</span><span class="op">.</span>numa_node)<span class="op">?;</span></span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Configure cache allocation if available</span></span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Some</span>(<span class="kw">ref</span> cache) <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>cache_allocation <span class="op">{</span></span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a>            configure_intel_cat(cache)<span class="op">?;</span></span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a>        <span class="co">// IOMMU isolation is configured at boot/VM level</span></span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(())</span>
<span id="cb22-69"><a href="#cb22-69" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb22-70"><a href="#cb22-70" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="intel-cache-allocation-technology-cat">Intel Cache Allocation
Technology (CAT)</h3>
<div class="sourceCode" id="cb23"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co"># configure-cat.sh - Configure Intel CAT for waveform isolation</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Check CAT support</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="ot">!</span> <span class="ot">-d</span> /sys/fs/resctrl <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mount</span> <span class="at">-t</span> resctrl resctrl /sys/fs/resctrl</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Create resource groups for each security level</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> /sys/fs/resctrl/r4w-unclass</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> /sys/fs/resctrl/r4w-secret</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> /sys/fs/resctrl/r4w-topsecret</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Allocate cache ways (assuming 11 ways available, 0-10)</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Unclass: 2 ways (0-1)</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;L3:0=003&quot;</span> <span class="op">&gt;</span> /sys/fs/resctrl/r4w-unclass/schemata</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Secret: 4 ways (2-5)</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;L3:0=03c&quot;</span> <span class="op">&gt;</span> /sys/fs/resctrl/r4w-secret/schemata</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Top Secret: 5 ways (6-10)</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;L3:0=7c0&quot;</span> <span class="op">&gt;</span> /sys/fs/resctrl/r4w-topsecret/schemata</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign PIDs to resource groups</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a><span class="co"># (done dynamically when waveforms start)</span></span></code></pre></div>
<h3 id="iommu-configuration-for-fpga">IOMMU Configuration for FPGA</h3>
<div class="sourceCode" id="cb24"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /etc/default/grub</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="va">GRUB_CMDLINE_LINUX</span><span class="op">=</span><span class="st">&quot;intel_iommu=on iommu=pt&quot;</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify IOMMU groups</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> g <span class="kw">in</span> /sys/kernel/iommu_groups/<span class="pp">*</span>/devices/<span class="pp">*</span><span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;IOMMU Group </span><span class="va">$(</span><span class="fu">basename</span> <span class="va">$(</span><span class="fu">dirname</span> <span class="va">$(</span><span class="fu">dirname</span> <span class="va">$g)))</span><span class="st">:&quot;</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;    </span><span class="va">$(</span><span class="ex">lspci</span> <span class="at">-nns</span> <span class="va">$(</span><span class="fu">basename</span> <span class="va">$g))</span><span class="st">&quot;</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Bind FPGA to VFIO for passthrough</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;10ee 9034&quot;</span> <span class="op">&gt;</span> /sys/bus/pci/drivers/vfio-pci/new_id</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;0000:01:00.0&quot;</span> <span class="op">&gt;</span> /sys/bus/pci/drivers/xilinx_dma/unbind</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;0000:01:00.0&quot;</span> <span class="op">&gt;</span> /sys/bus/pci/drivers/vfio-pci/bind</span></code></pre></div>
<hr />
<h2 id="level-8-air-gap-isolation">Level 8: Air-Gap Isolation</h2>
<h3 id="data-diode-architecture">Data Diode Architecture</h3>
<pre><code>┌────────────────────────────────────────────────────────────────────────────┐
│                      Air-Gap with Data Diode                               │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│  ┌─────────────────────┐         ┌─────────────────────┐                   │
│  │   High-Side System  │         │   Low-Side System   │                   │
│  │   (TOP SECRET)      │         │   (UNCLASS)         │                   │
│  │                     │         │                     │                   │
│  │  ┌───────────────┐  │         │  ┌───────────────┐  │                   │
│  │  │ Link-16       │  │         │  │ ADS-B         │  │                   │
│  │  │ SINCGARS      │  │         │  │ AIS           │  │                   │
│  │  │ HAVEQUICK     │  │         │  │ Commercial FM │  │                   │
│  │  └───────────────┘  │         │  └───────────────┘  │                   │
│  │         │           │         │         ▲           │                   │
│  │         ▼           │         │         │           │                   │
│  │  ┌───────────────┐  │         │  ┌───────────────┐  │                   │
│  │  │ Data Diode TX │──┼────────►│  │ Data Diode RX │  │                   │
│  │  │ (fiber optic) │  │  ONE    │  │ (fiber optic) │  │                   │
│  │  └───────────────┘  │  WAY    │  └───────────────┘  │                   │
│  │                     │         │                     │                   │
│  └─────────────────────┘         └─────────────────────┘                   │
│                                                                            │
│  • Physical fiber ensures unidirectional flow                              │
│  • No electrical connection between systems                                │
│  • High-to-low only (sanitized data)                                       │
│  • Certified for cross-domain transfer                                     │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="fpga-isolation">FPGA Isolation</h2>
<h3 id="bitstream-partitioning">Bitstream Partitioning</h3>
<pre><code>┌────────────────────────────────────────────────────────────────────────────┐
│                    FPGA Partial Reconfiguration                            │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         FPGA Fabric                                 │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐  │   │
│  │  │   Static    │  │  Partition  │  │  Partition  │  │  Partition │  │   │
│  │  │   Region    │  │     A       │  │     B       │  │     C      │  │   │
│  │  │             │  │             │  │             │  │            │  │   │
│  │  │ • AXI Bus   │  │ • UNCLASS   │  │ • SECRET    │  │ • TOPSECRET│  │   │
│  │  │ • Clocking  │  │ • Waveform  │  │ • Waveform  │  │ • Waveform │  │   │
│  │  │ • Reset     │  │             │  │             │  │            │  │   │
│  │  │ • Firewall  │◄─┤             │◄─┤             │◄─┤            │  │   │
│  │  │             │  │             │  │             │  │            │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └────────────┘  │   │
│  │                         ▲                ▲                ▲         │   │
│  │                         │                │                │         │   │
│  │         ┌───────────────┴────────────────┴────────────────┴──────┐  │   │ 
│  │         │              AXI Firewall                              │  │   │
│  │         │   • Address filtering per partition                    │  │   │
│  │         │   • Transaction logging                                │  │   │
│  │         │   • Illegal access blocking                            │  │   │
│  │         └────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="axi-firewall-configuration">AXI Firewall Configuration</h3>
<div class="sourceCode" id="cb27"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// FPGA partition isolation using AXI Firewall</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> FpgaPartition <span class="op">{</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Partition identifier</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> id<span class="op">:</span> <span class="dt">u8</span><span class="op">,</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Base address in FPGA memory map</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> base_addr<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Size of partition</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> size<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Security level</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> security_level<span class="op">:</span> SecurityLevel<span class="op">,</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Allowed AXI masters</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> allowed_masters<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>AxiMasterId<span class="op">&gt;,</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> FpgaPartition <span class="op">{</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Configure AXI firewall rules for this partition</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> configure_firewall(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> fpga<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> FpgaHandle) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Set address range</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>        fpga<span class="op">.</span>write_reg(</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>            FIREWALL_BASE <span class="op">+</span> <span class="kw">self</span><span class="op">.</span>id <span class="kw">as</span> <span class="dt">u64</span> <span class="op">*</span> FIREWALL_STRIDE <span class="op">+</span> ADDR_LOW<span class="op">,</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>base_addr<span class="op">,</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>        )<span class="op">?;</span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>        fpga<span class="op">.</span>write_reg(</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>            FIREWALL_BASE <span class="op">+</span> <span class="kw">self</span><span class="op">.</span>id <span class="kw">as</span> <span class="dt">u64</span> <span class="op">*</span> FIREWALL_STRIDE <span class="op">+</span> ADDR_HIGH<span class="op">,</span></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>base_addr <span class="op">+</span> <span class="kw">self</span><span class="op">.</span>size <span class="op">-</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>        )<span class="op">?;</span></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Configure allowed masters</span></span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> master_mask<span class="op">:</span> <span class="dt">u32</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> master <span class="kw">in</span> <span class="op">&amp;</span><span class="kw">self</span><span class="op">.</span>allowed_masters <span class="op">{</span></span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>            master_mask <span class="op">|=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> master<span class="op">.</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>        fpga<span class="op">.</span>write_reg(</span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>            FIREWALL_BASE <span class="op">+</span> <span class="kw">self</span><span class="op">.</span>id <span class="kw">as</span> <span class="dt">u64</span> <span class="op">*</span> FIREWALL_STRIDE <span class="op">+</span> MASTER_ALLOW<span class="op">,</span></span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>            master_mask <span class="kw">as</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>        )<span class="op">?;</span></span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Enable firewall</span></span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a>        fpga<span class="op">.</span>write_reg(</span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a>            FIREWALL_BASE <span class="op">+</span> <span class="kw">self</span><span class="op">.</span>id <span class="kw">as</span> <span class="dt">u64</span> <span class="op">*</span> FIREWALL_STRIDE <span class="op">+</span> CTRL<span class="op">,</span></span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>            FIREWALL_ENABLE <span class="op">|</span> FIREWALL_LOG_VIOLATIONS<span class="op">,</span></span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>        )<span class="op">?;</span></span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(())</span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="memory-protection">Memory Protection</h2>
<h3 id="encrypted-memory-regions">Encrypted Memory Regions</h3>
<div class="sourceCode" id="cb28"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">zeroize::</span><span class="op">{</span>Zeroize<span class="op">,</span> ZeroizeOnDrop<span class="op">};</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// Secure buffer that is always encrypted in memory</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span>ZeroizeOnDrop<span class="at">)]</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> SecureBuffer <span class="op">{</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Encrypted data</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    data<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;,</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Encryption key (derived from hardware key)</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    key<span class="op">:</span> [<span class="dt">u8</span><span class="op">;</span> <span class="dv">32</span>]<span class="op">,</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Nonce for encryption</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    nonce<span class="op">:</span> [<span class="dt">u8</span><span class="op">;</span> <span class="dv">12</span>]<span class="op">,</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> SecureBuffer <span class="op">{</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Create new secure buffer</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> new(size<span class="op">:</span> <span class="dt">usize</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">Self</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Derive key from hardware (TPM or CPU key)</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> key <span class="op">=</span> derive_hardware_key()<span class="op">?;</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> nonce <span class="op">=</span> generate_nonce()<span class="op">;</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Allocate and lock memory</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> data <span class="op">=</span> <span class="pp">vec!</span>[<span class="dv">0u8</span><span class="op">;</span> size <span class="op">+</span> <span class="dv">16</span>]<span class="op">;</span> <span class="co">// +16 for auth tag</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>        mlock(<span class="op">&amp;</span>data)<span class="op">?;</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(<span class="dt">Self</span> <span class="op">{</span> data<span class="op">,</span> key<span class="op">,</span> nonce <span class="op">}</span>)</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Write data (encrypts automatically)</span></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> write(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> plaintext<span class="op">:</span> <span class="op">&amp;</span>[<span class="dt">u8</span>]) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>        <span class="kw">use</span> <span class="pp">aes_gcm::</span><span class="op">{</span>Aes256Gcm<span class="op">,</span> Key<span class="op">,</span> Nonce<span class="op">};</span></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">use</span> <span class="pp">aes_gcm::aead::</span><span class="op">{</span>Aead<span class="op">,</span> NewAead<span class="op">};</span></span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> cipher <span class="op">=</span> <span class="pp">Aes256Gcm::</span>new(<span class="pp">Key::</span>from_slice(<span class="op">&amp;</span><span class="kw">self</span><span class="op">.</span>key))<span class="op">;</span></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> nonce <span class="op">=</span> <span class="pp">Nonce::</span>from_slice(<span class="op">&amp;</span><span class="kw">self</span><span class="op">.</span>nonce)<span class="op">;</span></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> ciphertext <span class="op">=</span> cipher<span class="op">.</span>encrypt(nonce<span class="op">,</span> plaintext)</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>map_err(<span class="op">|</span>_<span class="op">|</span> <span class="bu">Error</span><span class="pp">::</span>EncryptionFailed)<span class="op">?;</span></span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>data[<span class="op">..</span>ciphertext<span class="op">.</span>len()]<span class="op">.</span>copy_from_slice(<span class="op">&amp;</span>ciphertext)<span class="op">;</span></span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Increment nonce</span></span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>        increment_nonce(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">.</span>nonce)<span class="op">;</span></span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(())</span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Read data (decrypts automatically)</span></span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> read(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> len<span class="op">:</span> <span class="dt">usize</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;&gt;</span> <span class="op">{</span></span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>        <span class="kw">use</span> <span class="pp">aes_gcm::</span><span class="op">{</span>Aes256Gcm<span class="op">,</span> Key<span class="op">,</span> Nonce<span class="op">};</span></span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a>        <span class="kw">use</span> <span class="pp">aes_gcm::aead::</span><span class="op">{</span>Aead<span class="op">,</span> NewAead<span class="op">};</span></span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> cipher <span class="op">=</span> <span class="pp">Aes256Gcm::</span>new(<span class="pp">Key::</span>from_slice(<span class="op">&amp;</span><span class="kw">self</span><span class="op">.</span>key))<span class="op">;</span></span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Use previous nonce for decryption</span></span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> prev_nonce <span class="op">=</span> decrement_nonce(<span class="op">&amp;</span><span class="kw">self</span><span class="op">.</span>nonce)<span class="op">;</span></span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> nonce <span class="op">=</span> <span class="pp">Nonce::</span>from_slice(<span class="op">&amp;</span>prev_nonce)<span class="op">;</span></span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> plaintext <span class="op">=</span> cipher<span class="op">.</span>decrypt(nonce<span class="op">,</span> <span class="op">&amp;</span><span class="kw">self</span><span class="op">.</span>data[<span class="op">..</span>len <span class="op">+</span> <span class="dv">16</span>])</span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>map_err(<span class="op">|</span>_<span class="op">|</span> <span class="bu">Error</span><span class="pp">::</span>DecryptionFailed)<span class="op">?;</span></span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(plaintext)</span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> <span class="bu">Drop</span> <span class="cf">for</span> SecureBuffer <span class="op">{</span></span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> drop(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">{</span></span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Zeroize is handled by derive macro, but also unlock</span></span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a>        munlock(<span class="op">&amp;</span><span class="kw">self</span><span class="op">.</span>data)<span class="op">.</span>ok()<span class="op">;</span></span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="guard-pages">Guard Pages</h3>
<div class="sourceCode" id="cb29"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// Allocate buffer with guard pages</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> allocate_guarded(size<span class="op">:</span> <span class="dt">usize</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>GuardedBuffer<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> page_size <span class="op">=</span> <span class="kw">unsafe</span> <span class="op">{</span> <span class="pp">libc::</span>sysconf(<span class="pp">libc::</span>_SC_PAGESIZE) <span class="op">}</span> <span class="kw">as</span> <span class="dt">usize</span><span class="op">;</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Round up to page boundary</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> aligned_size <span class="op">=</span> (size <span class="op">+</span> page_size <span class="op">-</span> <span class="dv">1</span>) <span class="op">&amp;</span> <span class="op">!</span>(page_size <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Allocate: guard + data + guard</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> total_size <span class="op">=</span> aligned_size <span class="op">+</span> <span class="dv">2</span> <span class="op">*</span> page_size<span class="op">;</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> ptr <span class="op">=</span> <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>        <span class="pp">libc::</span>mmap(</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>            <span class="pp">std::ptr::</span>null_mut()<span class="op">,</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>            total_size<span class="op">,</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>            <span class="pp">libc::</span>PROT_NONE<span class="op">,</span>  <span class="co">// Start with no permissions</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>            <span class="pp">libc::</span>MAP_PRIVATE <span class="op">|</span> <span class="pp">libc::</span>MAP_ANONYMOUS<span class="op">,</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>            <span class="op">-</span><span class="dv">1</span><span class="op">,</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>            <span class="dv">0</span><span class="op">,</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ptr <span class="op">==</span> <span class="pp">libc::</span>MAP_FAILED <span class="op">{</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>MmapFailed(<span class="pp">std::io::</span><span class="bu">Error</span><span class="pp">::</span>last_os_error()))<span class="op">;</span></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Make data region readable/writable</span></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> data_ptr <span class="op">=</span> <span class="kw">unsafe</span> <span class="op">{</span> ptr<span class="op">.</span>add(page_size) <span class="op">};</span></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">unsafe</span> <span class="op">{</span></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>        <span class="pp">libc::</span>mprotect(</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>            data_ptr<span class="op">,</span></span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>            aligned_size<span class="op">,</span></span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>            <span class="pp">libc::</span>PROT_READ <span class="op">|</span> <span class="pp">libc::</span>PROT_WRITE<span class="op">,</span></span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>        )<span class="op">;</span></span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Guard pages remain PROT_NONE - any access triggers SIGSEGV</span></span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Ok</span>(GuardedBuffer <span class="op">{</span></span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>        ptr<span class="op">:</span> data_ptr<span class="op">,</span></span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a>        size<span class="op">:</span> aligned_size<span class="op">,</span></span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a>        total_ptr<span class="op">:</span> ptr<span class="op">,</span></span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a>        total_size<span class="op">,</span></span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span>)</span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="cross-domain-solutions">Cross-Domain Solutions</h2>
<h3 id="multi-level-security-architecture">Multi-Level Security
Architecture</h3>
<pre><code>┌─────────────────────────────────────────────────────────────────────────────┐
│                    Cross-Domain Solution (CDS)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                      ┌─────────────────────┐                                │
│                      │    Guard Server     │                                │
│                      │                     │                                │
│                      │ • Policy Engine     │                                │
│                      │ • Content Filter    │                                │
│                      │ • Audit Logger      │                                │
│                      │ • Crypto Services   │                                │
│                      └──────────┬──────────┘                                │
│                                 │                                           │
│         ┌───────────────────────┼───────────────────────┐                   │
│         │                       │                       │                   │
│         ▼                       ▼                       ▼                   │
│  ┌──────────────┐       ┌──────────────┐       ┌──────────────┐             │
│  │  UNCLASS     │       │   SECRET     │       │  TOP SECRET  │             │
│  │  Domain      │       │   Domain     │       │   Domain     │             │
│  │              │       │              │       │              │             │
│  │ • ADS-B      │       │ • SINCGARS   │       │ • Link-16    │             │
│  │ • AIS        │       │ • P25        │       │ • HAVEQUICK  │             │
│  │ • Commercial │       │ • MIL-STD    │       │ • JTRS       │             │
│  └──────────────┘       └──────────────┘       └──────────────┘             │
│                                                                             │
│  Data Flow Rules:                                                           │
│  • UNCLASS ──► SECRET ──► TOP SECRET  (upward allowed)                      │
│  • TOP SECRET ──► SECRET ──► UNCLASS  (downward: guard filtered only)       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="implementation-guide">Implementation Guide</h2>
<h3 id="r4w-sandbox-crate-structure">r4w-sandbox Crate Structure</h3>
<pre><code>crates/r4w-sandbox/
├── Cargo.toml
├── src/
│   ├── lib.rs
│   ├── levels/
│   │   ├── mod.rs
│   │   ├── process.rs      # L1-L2: Process/namespace isolation
│   │   ├── lsm.rs          # L3: seccomp/SELinux/AppArmor
│   │   ├── container.rs    # L4: Docker/Podman integration
│   │   ├── microvm.rs      # L5: Firecracker/gVisor
│   │   ├── vm.rs           # L6: KVM/QEMU
│   │   └── hardware.rs     # L7: CPU pinning, NUMA, IOMMU
│   ├── memory/
│   │   ├── mod.rs
│   │   ├── secure.rs       # Encrypted buffers
│   │   ├── guarded.rs      # Guard pages
│   │   └── zeroize.rs      # Secure cleanup
│   ├── ipc/
│   │   ├── mod.rs
│   │   ├── channel.rs      # Secure IPC channels
│   │   └── shm.rs          # Isolated shared memory
│   ├── fpga/
│   │   ├── mod.rs
│   │   ├── partition.rs    # FPGA partitioning
│   │   └── firewall.rs     # AXI firewall config
│   └── policy/
│       ├── mod.rs
│       ├── seccomp.rs      # Seccomp profiles
│       ├── selinux.rs      # SELinux policy generation
│       └── apparmor.rs     # AppArmor profile generation
├── profiles/
│   ├── seccomp-dsp.json
│   ├── seccomp-crypto.json
│   └── apparmor-dsp.profile
└── tests/
    ├── isolation_tests.rs
    └── escape_tests.rs</code></pre>
<h3 id="basic-usage">Basic Usage</h3>
<div class="sourceCode" id="cb32"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">r4w_sandbox::</span><span class="op">{</span>Sandbox<span class="op">,</span> IsolationLevel<span class="op">};</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">r4w_core::waveform::bpsk::</span>Bpsk<span class="op">;</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> main() <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create isolated sandbox for BPSK waveform</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> sandbox <span class="op">=</span> <span class="pp">Sandbox::</span>new(<span class="pp">IsolationLevel::</span>L3_LSM)<span class="op">?</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>name(<span class="st">&quot;waveform-bpsk&quot;</span>)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>memory_limit(<span class="dv">256</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>)</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>cpu_cores(<span class="op">&amp;</span>[<span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>])</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>seccomp_profile(<span class="st">&quot;dsp&quot;</span>)</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>build()<span class="op">?;</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Spawn waveform in sandbox</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> handle <span class="op">=</span> sandbox<span class="op">.</span>spawn(<span class="op">||</span> <span class="op">{</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> waveform <span class="op">=</span> <span class="pp">Bpsk::</span>new(<span class="dv">48000.0</span>)<span class="op">;</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ... process samples</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span>)<span class="op">?;</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Communicate via secure IPC</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> (tx<span class="op">,</span> rx) <span class="op">=</span> sandbox<span class="op">.</span><span class="pp">create_channel::</span><span class="op">&lt;</span>WaveformCommand<span class="op">&gt;</span>()<span class="op">?;</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>    tx<span class="op">.</span>send(<span class="pp">WaveformCommand::</span>SetFrequency(<span class="dv">915_000_000</span>))<span class="op">?;</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>    handle<span class="op">.</span>wait()<span class="op">?;</span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Ok</span>(())</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="deployment-configurations">Deployment Configurations</h2>
<h3 id="development-l1-l2">Development (L1-L2)</h3>
<div class="sourceCode" id="cb33"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Minimal isolation for development</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="ex">r4w</span> sandbox <span class="at">--level</span> process <span class="at">--waveform</span> BPSK</span></code></pre></div>
<h3 id="production-single-tenant-l3">Production Single-Tenant (L3)</h3>
<div class="sourceCode" id="cb34"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Production with LSM enforcement</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="ex">r4w</span> sandbox <span class="at">--level</span> lsm <span class="dt">\</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">--seccomp-profile</span> dsp <span class="dt">\</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">--selinux-context</span> r4w_production_t <span class="dt">\</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">--waveform</span> SINCGARS</span></code></pre></div>
<h3 id="production-multi-tenant-l4">Production Multi-Tenant (L4)</h3>
<div class="sourceCode" id="cb35"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Container-based multi-waveform</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="ex">docker-compose</span> <span class="at">-f</span> docker-compose.isolation.yml up</span></code></pre></div>
<h3 id="high-security-multi-tenant-l5">High-Security Multi-Tenant
(L5)</h3>
<div class="sourceCode" id="cb36"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Firecracker microVM for each waveform</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Provides VM-level isolation with container-like startup times</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create microVM for SECRET waveform</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="ex">r4w</span> sandbox <span class="at">--level</span> microvm <span class="dt">\</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">--kernel</span> /var/lib/r4w/vmlinux-dsp <span class="dt">\</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">--rootfs</span> /var/lib/r4w/rootfs-sincgars.ext4 <span class="dt">\</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">--vcpus</span> 2 <span class="dt">\</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">--memory</span> 512M <span class="dt">\</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">--network</span> tap-sincgars <span class="dt">\</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">--waveform</span> SINCGARS</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternative: gVisor for OCI container isolation with syscall interception</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">--runtime</span><span class="op">=</span>runsc <span class="dt">\</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">--security-opt</span> seccomp=seccomp-dsp.json <span class="dt">\</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">--cpus</span><span class="op">=</span>2 <span class="at">--memory</span><span class="op">=</span>512m <span class="dt">\</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>    r4w/waveform:latest <span class="at">--waveform</span> SINCGARS</span></code></pre></div>
<div class="sourceCode" id="cb37"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># firecracker-waveform.yaml - Firecracker configuration</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">machine-config</span><span class="kw">:</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">vcpu_count</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">mem_size_mib</span><span class="kw">:</span><span class="at"> </span><span class="dv">512</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">smt</span><span class="kw">:</span><span class="at"> </span><span class="ch">false</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="fu">boot-source</span><span class="kw">:</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">kernel_image_path</span><span class="kw">:</span><span class="at"> /var/lib/r4w/vmlinux-dsp</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">boot_args</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;console=ttyS0 quiet r4w.waveform=SINCGARS r4w.level=SECRET&quot;</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="fu">drives</span><span class="kw">:</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">drive_id</span><span class="kw">:</span><span class="at"> rootfs</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">path_on_host</span><span class="kw">:</span><span class="at"> /var/lib/r4w/rootfs-sincgars.ext4</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">is_root_device</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">is_read_only</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a><span class="fu">network-interfaces</span><span class="kw">:</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">iface_id</span><span class="kw">:</span><span class="at"> eth0</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">host_dev_name</span><span class="kw">:</span><span class="at"> tap-sincgars</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">guest_mac</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;06:00:AC:10:00:02&quot;</span></span></code></pre></div>
<h3 id="high-security-l6-l7">High-Security (L6-L7)</h3>
<div class="sourceCode" id="cb38"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># VM with hardware isolation</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="ex">r4w</span> sandbox <span class="at">--level</span> vm <span class="dt">\</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">--cpu-pinning</span> 4,5,6,7 <span class="dt">\</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">--numa-node</span> 1 <span class="dt">\</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">--iommu-group</span> 12 <span class="dt">\</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">--waveform</span> LINK16</span></code></pre></div>
<hr />
<h2 id="references">References</h2>
<ul>
<li><a
href="https://man7.org/linux/man-pages/man7/namespaces.7.html">Linux
Namespaces</a></li>
<li><a
href="https://www.kernel.org/doc/html/latest/userspace-api/seccomp_filter.html">Seccomp
BPF</a></li>
<li><a href="https://selinuxproject.org/">SELinux</a></li>
<li><a href="https://apparmor.net/">AppArmor</a></li>
<li><a href="https://firecracker-microvm.github.io/">Firecracker
MicroVMs</a></li>
<li><a
href="https://www.intel.com/content/www/us/en/developer/articles/technical/introduction-to-cache-allocation-technology.html">Intel
CAT</a></li>
<li><a href="https://developer.amd.com/sev/">AMD SEV</a></li>
<li><a
href="https://www.kernel.org/doc/html/latest/driver-api/vfio.html">VFIO</a></li>
<li><a
href="https://www.nsa.gov/What-We-Do/Cybersecurity/Cross-Domain/">Cross
Domain Solutions</a></li>
</ul>
</body>
</html>
